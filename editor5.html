<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editor - MixCertificate</title>
    <!-- In your <head> section, ensure you have the Google Fonts preconnect and display swap -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@400;700&family=Raleway:wght@400;700&family=Roboto:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Ubuntu:wght@400;700&family=Merriweather:wght@400;700&family=Lora:wght@400;700&family=Noto+Sans:wght@400;700&family=PT+Sans:wght@400;700&family=Quicksand:wght@400;700&family=Rubik:wght@400;700&family=Inter:wght@400;700&family=Exo+2:wght@400;700&family=Fira+Sans:wght@400;700&family=Cabin:wght@400;700&family=Abel&family=Anton&family=Bebas+Neue&family=Pacifico&family=Great+Vibes&display=swap"
        rel="stylesheet" />
    <!-- Material Icons for various UI icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <!-- Font Awesome for additional icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <!-- jQuery CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

    <!-- Color Thief CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.min.js"></script>
    <!-- Fabric.js CDN for canvas manipulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js" crossorigin="anonymous"></script>
    <!-- jsPDF CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jQuery UI for drag-and-drop or other UI interactions -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.min.css" />
    <!-- jQuery UI Position (needed by contextMenu, must be loaded before contextMenu JS) -->
    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.ui.position.min.js"></script>
    <!-- jQuery Context Menu CSS -->
    <link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.min.css" />
    <!-- jQuery Context Menu JS -->
    <script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.min.js"></script>

    <!-- QRCode.js for QR code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    <!-- Tailwind CSS (Browser version for simplicity) -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Spectrum Color Picker CSS -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.css" />
    <!-- Spectrum Color Picker JS -->
    <script src="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.js"></script>

    <style>
        body {
            font-family: "Inter", sans-serif;
            overflow: hidden;
        }

        body.drag-active {
            outline: 3px dashed #6366f1;
            /* Tailwind indigo-500 */
            outline-offset: -5px;
        }

        .sidebar {
            color: #cbd5e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .sidebar {
            scrollbar-width: none;
        }

        .sidebar {
            -ms-overflow-style: none;
        }

        .sidebar .editor-sidebar-items:hover {
            color: #ffffff;
        }

        .sidebar .editor-sidebar-items.active {
            color: #ffffff;
        }

        .editor-sidebar-items {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .sidebar-content-area {
            color: #cbd5e0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            transform: translateY(100%);
            height: 90%;
            width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar-inner-area::-webkit-scrollbar {
            width: 12px;
            background-color: #374151;
            border-radius: 6px;
        }

        .sidebar-inner-area::-webkit-scrollbar-track {
            background-color: #374151;
            border-radius: 6px;
        }

        .sidebar-inner-area::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 6px;
            border: 3px solid #374151;
        }

        .sidebar-inner-area::-webkit-scrollbar-thumb:hover {
            background-color: #aeb5bf;
        }

        @media (min-width: 768px) {
            .sidebar-content-area {
                transform: translateX(-100%);
                width: 0;
                height: auto;
                overflow-y: auto;
            }

            .sidebar-content-area.sidebar-open {
                opacity: 1;
                pointer-events: auto;
                transform: translateX(0%);
            }
        }

        .elements-tabs-scroll::-webkit-scrollbar {
            height: 8px;
            /* Height of the horizontal scrollbar */
        }

        .elements-tabs-scroll::-webkit-scrollbar-track {
            background: #3f3f46;
            /* Background of the scrollbar track (zinc-800) */
            border-radius: 4px;
        }

        .elements-tabs-scroll::-webkit-scrollbar-thumb {
            background-color: #a1a1aa;
            /* Color of the scrollbar thumb (zinc-400) */
            border-radius: 4px;
            border: 2px solid #3f3f46;
            /* Border around the thumb */
        }

        .elements-tabs-scroll::-webkit-scrollbar-thumb:hover {
            background-color: #d4d4d8;
            /* Lighter color on hover (zinc-200) */
        }

        /* Firefox scrollbar styling for the Elements tabs */
        .elements-tabs-scroll {
            scrollbar-width: thin;
            /* "auto" or "thin" */
            scrollbar-color: #a1a1aa #3f3f46;
            /* thumb color track color */
        }

        .sidebar-content-area h2 {
            color: #ffffff;
        }

        .sidebar-content-area p {
            color: #cbd5e0;
        }

        #close-sidebar-content {
            color: #9ca3af;
        }

        #close-sidebar-content:hover {
            color: #ffffff;
        }

        #backgrounds-content input[type="text"] {
            background-color: #424751;
            border: 1px solid #4a5568;
            color: #ffffff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            flex: 1;
            font-size: 0.875rem;
        }

        #backgrounds-content input[type="text"]::placeholder {
            color: #a0aec0;
        }

        #backgrounds-content button {
            background-color: #4a5568;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        #backgrounds-content button:hover {
            background-color: #64748b;
        }

        .material-icons,
        .fas,
        .far,
        .fab {
            color: inherit;
        }

        .editor-sidebar-items {
            min-height: 50px;
        }

        .draggable-item {
            cursor: grab;
            user-select: none;
            -webkit-user-drag: element;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #5b5f67;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #5b5f67;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }

        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: -0.125em;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }

        .canvas-container {
            position: absolute !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
            display: block;
        }

        .canvas-container .lower-canvas,
        .canvas-container .upper-canvas {
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }

        #object-toolbar.center-global {
            justify-content: center;
        }

        .icon-sm,
        .icon-sm-2 {
            font-size: 8px;
            cursor: pointer;
        }

        .btn-icon,
        .btn-icon-2 {
            padding: 0px 8px;
        }

        #drop-area.highlight {
            border-color: #6366f1;

            background-color: #374151;
            /* Gray-700 */
        }

        .imageWrapper:hover .btn-icon-2 {
            opacity: 1;
        }

        .context-menu-item {
            padding: 2px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #333;
        }

        /* Style for separators */
        .context-menu-item.context-menu-separator {
            border-top: 1px solid #eee;
            padding: 0;
        }

        /* Style for the shortcut text (e.g., Ctrl+C) */
        .context-menu-item .shortcut {
            margin-left: auto;
            font-size: 0.8em;
            color: #999;
        }

        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: -0.125em;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }

        .brand-colors .sp-original-input-container {
            border: 1px solid #6a7282;
            border-radius: 6px;
            flex: 1;
        }

        .sp-original-input-container:focus {
            outline: 1px solid #2b7fff;
        }

        /* Styles for Webkit browsers (Chrome, Safari) */
        #fontFamily::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #fontFamily::-webkit-scrollbar-track {
            background: #3f3f46;
            border-radius: 4px;
        }

        #fontFamily::-webkit-scrollbar-thumb {
            background-color: #a1a1aa;
            border-radius: 4px;
            border: 2px solid #3f3f46;
        }

        #fontFamily::-webkit-scrollbar-thumb:hover {
            background-color: #d4d4d8;
            /* Lighter color on hover (zinc-200) */
        }

        /* Styles for Firefox */
        #fontFamily {
            scrollbar-width: thin;
            scrollbar-color: #a1a1aa #3f3f46;
        }

        .savespiner,
        .deletespiner {
            width: 1.2rem;
            height: 1.2rem;
        }

        /* Base styles */
        #main-content-area {
            width: 100%;
            height: 100%;
            overflow: auto;

            /* Firefox scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: #8d9397 #f5f5f5;
        }

        /* WebKit scrollbar styling */
        #main-content-area::-webkit-scrollbar {
            width: 10px;
            background-color: #f5f5f5;
        }

        #main-content-area::-webkit-scrollbar-thumb {
            background-color: #8d9397;
            border-radius: 6px;
            border: 2px solid #f5f5f5;
        }

        #main-content-area::-webkit-scrollbar-track {
            background-color: #f5f5f5;
        }

        textarea[data-fabric-hiddentextarea] {
            left: 0 !important;
            top: 0 !important;
        }


        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* For Chrome, Safari, Edge, and Opera */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Standard property for general compatibility */
        input[type="number"] {
            appearance: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;

        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #c9c9c9;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #6b7280;
            border-radius: 10px;

        }
    </style>
</head>

<body>
    <!-- Full-screen Drag Overlay -->

    <div id="app-container" class="w-full h-full bg-[#f5f5f5]">
        <div id="file-drag-overlay"
            class="fixed inset-0 hidden bg-black/70 items-center justify-center w-full h-screen z-[9998] pointer-events-none">
            <div
                class="border-4 border-dashed border-blue-500 text-white text-2xl p-20 rounded-lg text-center flex flex-col items-center justify-center gap-4">
                <i class="fas fa-cloud-upload-alt text-6xl"></i>
                <p>Drop your images here to upload!</p>
            </div>
        </div>
        <!-- Navbar -->
        <nav class="bg-white flex items-center justify-between py-2 sm:py-3 px-2 sm:px-4 shadow-sm relative z-20">
            <div class="flex items-center gap-3">
                <a href="/designs/" class="flex items-center">
                    <img src="/assets/images/logo-sm.svg" alt="Logo" width="30" height="30" class="w-[25px]"
                        title="mixcertificate" />
                    <span class="font-bold hidden">MixCertificate</span>
                </a>
                <input type="text" id="designName" placeholder="Design Name" value="Untitled Design"
                    class="h-10 text-lg text-gray-600 text-left outline-none w-32 sm:w-64 md:w-80 border-none focus:ring-0 focus:outline-none bg-transparent"
                    onfocus="this.style.border='none'" onblur="this.style.border='none'" />
            </div>
            <!-- Undo/Redo Buttons -->
            <div class="flex items-center gap-2 sm:gap-2 px-2" data-group-name="History">
                <button id="undo-button"
                    class="flex items-center justify-center rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700 p-2"
                    title="Undo">
                    <i class="material-icons text-xl">undo</i>
                </button>
                <button id="redo-button"
                    class="flex items-center justify-center rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700 p-2"
                    title="Redo">
                    <i class="material-icons text-xl">redo</i>
                </button>
            </div>
            <div class="flex items-center gap-2">
                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button"
                        class="text-gray-700 focus:outline-none p-2 rounded-md hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
                <!-- Desktop Action Buttons -->
                <div id="desktop-action-buttons" class="hidden md:flex items-center gap-2">
                    <!-- Save Dropdown for Desktop -->
                    <button id="saveDesignBtn"
                        class="flex items-center px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200">
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                    <button id="previewBtn"
                        class="flex items-center px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200">
                        <i class="fas fa-eye mr-2"></i>Preview
                    </button>
                    <!-- Download Dropdown -->
                    <div class="relative group">
                        <button
                            class="flex items-center px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200"
                            type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download mr-2"></i>Download
                        </button>
                        <ul class="absolute hidden bg-white shadow-lg rounded-md w-48 z-10 group-hover:block right-0"
                            aria-labelledby="downloadDropdown">
                            <li>
                                <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="downloadPngBtn"
                                    href="#">Download PNG</a>
                            </li>
                            <li>
                                <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="downloadJpegBtn"
                                    href="#">Download JPEG</a>
                            </li>
                            <li>
                                <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="downloadPdfBtn"
                                    href="#">Download PDF</a>
                            </li>
                            <li>
                                <hr class="border-t border-gray-200 my-1" />
                            </li>
                            <li class="px-4 py-2 text-xs text-gray-500 uppercase tracking-wider">
                                For Print (300 DPI)
                            </li>
                            <li>
                                <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="printDownloadPngBtn"
                                    href="#">Download PNG</a>
                            </li>
                            <li>
                                <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="printDownloadJpegBtn"
                                    href="#">Download JPEG</a>
                            </li>
                            <li>
                                <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="printDownloadPdfBtn"
                                    href="#">Download PDF</a>
                            </li>
                        </ul>
                    </div>
                    <!-- Create Dropdown -->
                    <div class="relative group">
                        <button
                            class="flex items-center px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200"
                            type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plus mr-2"></i>Create
                        </button>
                        <ul class="absolute hidden bg-white shadow-lg rounded-md w-64 z-10 right-0 group-hover:block"
                            aria-labelledby="dropdownMenuButton">
                            <li>
                                <a class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100" href="#"
                                    data-type="horizontal" onclick="openEditor('horizontal')">
                                    <i class="fas fa-arrows-alt-h mr-2"></i> Horizontal
                                    Certificate
                                </a>
                            </li>
                            <li>
                                <a class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100" href="#"
                                    data-type="vertical" onclick="openEditor('vertical')">
                                    <i class="fas fa-arrows-alt-v mr-2"></i> Vertical
                                    Certificate
                                </a>
                            </li>
                            <li>
                                <a class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100" href="#"
                                    data-type="badge" onclick="openEditor('badge')">
                                    <i class="fas fa-badge mr-2"></i> Badge
                                </a>
                            </li>
                            <li>
                                <hr class="border-t border-gray-200 my-1" />
                            </li>
                            <li>
                                <div class="px-3 py-2">
                                    <input type="number" id="customWidth"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Width (px)" />
                                    <input type="number" id="customHeight"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Height (px)" />
                                    <button
                                        class="w-full mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200"
                                        onclick="createCustomDesign()">
                                        Create
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu-dropdown"
            class="md:hidden bg-white shadow-lg absolute top-[56px] left-0 right-0 z-10 hidden">
            <div class="flex flex-col p-4 gap-2">
                <!-- Save Dropdown for Mobile -->
                <button id="saveDesignBtn-mobile"
                    class="flex items-center justify-center px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200 w-full">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
                <button id="previewBtn-mobile"
                    class="flex items-center justify-center px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200 w-full">
                    <i class="fas fa-eye mr-2"></i>Preview
                </button>
                <div class="relative w-full">
                    <button
                        class="flex items-center justify-center w-full px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200"
                        type="button" id="downloadDropdown-mobile" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download mr-2"></i>Download
                    </button>
                    <ul class="hidden bg-white shadow-lg rounded-md mt-1 w-full z-10 absolute"
                        aria-labelledby="downloadDropdown-mobile">
                        <li>
                            <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="downloadPngBtn-mobile"
                                href="#">Download PNG</a>
                        </li>
                        <li>
                            <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="downloadJpegBtn-mobile"
                                href="#">Download JPEG</a>
                        </li>
                        <li>
                            <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="downloadPdfBtn-mobile"
                                href="#">Download PDF</a>
                        </li>
                        <li>
                            <hr class="border-t border-gray-200 my-1" />
                        </li>
                        <li class="px-4 py-2 text-xs text-gray-500 uppercase tracking-wider">
                            For Print (300 DPI)
                        </li>
                        <li>
                            <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="printDownloadPngBtn-mobile"
                                href="#">Download PNG</a>
                        </li>
                        <li>
                            <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="printDownloadJpegBtn-mobile"
                                href="#">Download JPEG</a>
                        </li>
                        <li>
                            <a class="block px-4 py-2 text-gray-700 hover:bg-gray-100" id="printDownloadPdfBtn-mobile"
                                href="#">Download PDF</a>
                        </li>
                    </ul>
                </div>
                <div class="relative w-full">
                    <button
                        class="flex items-center justify-center w-full px-4 py-2 bg-white text-gray-800 rounded-md border border-gray-300 hover:bg-gray-100 shadow-sm transition-colors duration-200"
                        type="button" id="dropdownMenuButton-mobile" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-plus mr-2"></i>Create
                    </button>
                    <ul class="hidden bg-white shadow-lg rounded-md mt-1 w-full z-10 absolute"
                        aria-labelledby="dropdownMenuButton-mobile">
                        <li>
                            <a class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100" href="#"
                                data-type="horizontal" onclick="openEditor('horizontal')"><i
                                    class="fas fa-arrows-alt-h mr-2"></i> Horizontal
                                Certificate</a>
                        </li>
                        <li>
                            <a class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100" href="#"
                                data-type="vertical" onclick="openEditor('vertical')"><i
                                    class="fas fa-arrows-alt-v mr-2"></i> Vertical
                                Certificate</a>
                        </li>
                        <li>
                            <a class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100" href="#"
                                data-type="badge" onclick="openEditor('badge')"><i class="fas fa-badge mr-2"></i>
                                Badge</a>
                        </li>
                        <li>
                            <hr class="border-t border-gray-200 my-1" />
                        </li>
                        <li>
                            <div class="px-3 py-2">
                                <input type="number" id="customWidth-mobile"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Width (px)" />
                                <input type="number" id="customHeight-mobile"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Height (px)" />
                                <button
                                    class="w-full mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200"
                                    onclick="createCustomDesign()">
                                    Create
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Main Editor Area -->
        <div class="fixed flex flex-col w-full h-full">
            <div class="flex w-full bg-zinc-800 h-full max-h-[100%] flex-grow">
                <!-- Sidebar -->
                <div class="sidebar shadow-lg overflow-y-auto flex-nowrap whitespace-nowrap flex md:flex-col md:pt-4 md:px-4 md:static md:w-26 fixed bottom-0 left-0 w-full min-w-[85px] bg-zinc-900 z-50 flex-row items-center gap-2 md:gap-1 pt-1 px-1 md:pb-16"
                    id="sidebar">
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group active md:w-auto md:p-3"
                        data-target="#design-content">
                        <span class="material-icons text-2xl group-hover:text-white">home</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Design
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 hover:text-white transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#ai-designer-panel">
                        <span class="material-icons text-2xl group-hover:text-white">auto_awesome</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            AI Designer
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#background-content">
                        <span class="material-icons text-2xl group-hover:text-white">verified</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Background
                        </div>
                    </button>

                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#elements-content">
                        <span class="material-icons text-2xl group-hover:text-white">category</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Elements
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#text-content">
                        <span class="material-icons text-2xl group-hover:text-white">text_fields</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Text
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#photos-content">
                        <span class="material-icons text-2xl group-hover:text-white">wallpaper</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Photos
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#image-upload-content">
                        <span class="material-icons text-2xl group-hover:text-white">cloud_upload</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Uploads
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#brand-content">
                        <span class="material-icons text-2xl group-hover:text-white">branding_watermark</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Brand
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#qr-code-content">
                        <span class="material-icons text-2xl group-hover:text-white">grid_on</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            QR Code
                        </div>
                    </button>
                    <button
                        class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                        data-target="#variable-gifs-content">
                        <span class="material-icons text-2xl group-hover:text-white">insert_emoticon</span>
                        <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">
                            Variables
                        </div>
                    </button>
                    <!--                     
                            <button
                                class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                                data-target="#frames-content">
                                <span class="material-icons text-2xl group-hover:text:white block md:block">crop</span>
                                <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">Frames</div>
                            </button>
                            -->

                    <!--                     
                            <button
                                class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                                data-target="#shapes-elements-content">
                                <span class="material-icons text-2xl group-hover:text-white">view_module</span>
                                <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">Icons</div>
                            </button>
                            

                            <button
                                class="editor-sidebar-items flex flex-col items-center justify-center p-3 w-full text-gray-400 transition-colors duration-200 group md:w-auto md:p-3"
                                data-target="#stickers-gifs-content">
                                <span class="material-icons text-2xl group-hover:text-white">insert_emoticon</span>
                                <div class="sidebar-text text-xs mt-1 group-hover:text-white block md:block">Stickers &amp; GIFs
                                </div>
                            </button> -->
                </div>

                <!-- Sidebar Content Area -->
                <div id="sidebar-content-area"
                    class="bg-zinc-800 min-w-[280px] shadow-lg md:relative transition-transform duration-300 ease-in-out md:w-[30%] w-full text-white z-20 absolute bottom-0 h-[80%] md:h-[auto]">
                    <button id="close-sidebar-content"
                        class="cursor-pointer absolute left-1/2 -translate-x-1/2 md:-translate-y-1/2 md:top-1/2 md:-right-[10px] md:left-[unset] top-1 p-1 rounded-full bg-zinc-600 shadow-md flex items-center justify-center focus:outline-none z-10">
                        <span class="material-icons rotate-[271deg] md:rotate-0 text-white">chevron_left</span>
                    </button>
                    <div class="overflow-y-auto h-full sidebar-inner-area px-4 pb-38 pt-9 md:pb-18">
                        <!-- Design Content -->

                        <div id="design-content" class="sidebar-content">
                            <h5 class="text-xl font-semibold text-white mb-4">Designs</h5>
                            <div class="flex items-center gap-2 mb-4 flex-wrap">
                                <input type="text" id="designSearch" placeholder="Search Designs..." value=""
                                    class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:border-blue-500" />
                                <button id="designSearchButton"
                                    class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                    Search
                                </button>
                            </div>
                            <div id="designsSearchResults" class="mt-4 grid grid-cols-2 gap-2"></div>
                            <div id="designLoading" class="hidden text-center mt-4 w-full">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Ai Template -->
                        <div id="ai-designer-panel" class="sidebar-content">
                            <h2 class="text-xl font-semibold text-white mb-6">
                                AI Designer
                            </h2>

                            <div class="flex mb-4 rounded-md bg-zinc-700 p-1">
                                <button id="manual-tab-btn" class="flex-1 px-4 py-2 font-medium text-gray-400">
                                    Quick
                                </button>
                                <button id="automatic-tab-btn" class="flex-1 px-4 py-2 font-medium text-gray-400">
                                    Professional
                                </button>
                            </div>

                            <!-- Automatic (Professional) Tab Content -->
                            <div id="automatic-tab-content" class="tab-content">
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Step 1: Choose Certificate Type
                                    </h3>
                                    <!-- Font weight adjusted -->
                                    <div class="relative">
                                        <select id="certificate-type-dropdown"
                                            class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 appearance-none">
                                            <option value="Completion">Completion</option>
                                            <option value="Achievement">Achievement</option>
                                            <option value="Participation">Participation</option>
                                            <option value="Appreciation">Appreciation</option>
                                            <option value="Graduation">Graduation</option>
                                        </select>
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 20 20">
                                                <path
                                                    d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Step 2: Define Purpose
                                    </h3>
                                    <!-- Font weight adjusted -->
                                    <input type="text" id="certificate-purpose-input"
                                        class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
                                        placeholder="e.g., To certify completion of the program" />
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Step 3: Event Name
                                    </h3>
                                    <!-- Font weight adjusted -->
                                    <input type="text" id="event-name-input"
                                        class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
                                        placeholder="e.g., Winter Commencement 2024" />
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Step 4: Custom Prompt (Optional)
                                    </h3>
                                    <textarea id="professional-prompt-input"
                                        class="w-full p-3 rounded-md bg-zinc-700 text-sm text-white border border-gray-600 focus:outline-none focus:border-blue-500 h-24"
                                        placeholder="Add specific instructions for AI, e.g., 'Use a vintage look with gold accents and a serif font for the title.'"></textarea>
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Step 5: Select Style (Theme)
                                    </h3>
                                    <!-- Font weight adjusted -->
                                    <div class="grid grid-cols-2 gap-3" id="style-selection-container">
                                        <button
                                            class="ai-style-pill py-1 px-2 rounded-lg bg-zinc-700 text-white hover:bg-zinc-600 transition-colors duration-200 text-center"
                                            data-style="Professional">
                                            Professional
                                        </button>
                                        <button
                                            class="ai-style-pill py-1 px-2 rounded-lg bg-zinc-700 text-white hover:bg-zinc-600 transition-colors duration-200 text-center"
                                            data-style="Minimalist">
                                            Minimal
                                        </button>
                                        <button
                                            class="ai-style-pill py-1 px-2 rounded-lg bg-zinc-700 text-white hover:bg-zinc-600 transition-colors duration-200 text-center"
                                            data-style="Elegant">
                                            Elegant
                                        </button>
                                        <button
                                            class="ai-style-pill py-1 px-2 rounded-lg bg-zinc-700 text-white hover:bg-zinc-600 transition-colors duration-200 text-center"
                                            data-style="Modern">
                                            Modern
                                        </button>
                                        <button
                                            class="ai-style-pill py-1 px-2 rounded-lg bg-zinc-700 text-white hover:bg-zinc-600 transition-colors duration-200 text-center"
                                            data-style="Creative">
                                            Creative
                                        </button>
                                        <button
                                            class="ai-style-pill py-1 px-2 rounded-lg bg-zinc-700 text-white hover:bg-zinc-600 transition-colors duration-200 text-center"
                                            data-style="Academic">
                                            Academic
                                        </button>
                                        <button
                                            class="ai-style-pill py-1 px-2 rounded-lg bg-zinc-700 text-white hover:bg-zinc-600 transition-colors duration-200 text-center"
                                            data-style="Classic">
                                            Classic
                                        </button>
                                    </div>
                                </div>

                                <!-- NEW: Logo upload/select for Automatic Tab -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Step 6: Add Background
                                    </h3>
                                    <div class="bg-image-preview-container mb-2 hidden">
                                        <img class="bg-image-preview w-fit h-24 object-contain rounded-md mb-2" src=""
                                            alt="background" />
                                        <button
                                            class="remove-bg-image-btn px-3 py-1 bg-zinc-600 text-white rounded-md text-sm hover:bg-zinc-700 transition-colors duration-200">
                                            <i class="fas fa-times-circle mr-1"></i>Remove
                                        </button>
                                    </div>
                                    <div
                                        class="bg-upload-area border-2 border-dashed border-gray-600 rounded-lg p-3 text-center text-gray-400 cursor-pointer hover:border-blue-500 hover:text-white transition-colors duration-200">
                                        <span class="material-icons text-3xl mb-1"><i
                                                class="fas fa-cloud-upload-alt"></i></span>
                                        <p class="mb-1 text-sm">Drag & drop or</p>
                                        <input type="file" class="logo-file-upload-input hidden" accept="image/*" />
                                        <button
                                            class="browse-bg-files-button px-3 py-1 bg-zinc-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none text-sm">
                                            <i class="fas fa-folder-open mr-1"></i>Browse Files
                                        </button>
                                        <button
                                            class="select-existing-bg-btn px-3 py-1 bg-zinc-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none text-sm ml-1">
                                            <i class="fas fa-images mr-1"></i>Existing
                                        </button>
                                    </div>
                                    <input type="hidden" class="logo-image-url" />
                                </div>

                                <!-- Brand/Color Selection for Professional Tab -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Step 7: Select Brand or Custom Colors
                                    </h3>
                                    <div class="relative mb-3">
                                        <select id="professional-brand-selector"
                                            class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 appearance-none">
                                            <option value="">-- Select a Brand --</option>
                                            <option value="custom">Custom Colors</option>
                                        </select>
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 20 20">
                                                <path
                                                    d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                            </svg>
                                        </div>
                                    </div>
                                    <div id="custom-color-inputs" class="hidden">
                                        <p class="text-gray-400 text-sm mb-2">
                                            Choose primary and secondary colors:
                                        </p>
                                        <div class="flex flex-col gap-2 mb-2">
                                            <label for="primary-color-picker"
                                                class="text-white text-sm">Primary:</label>
                                            <input type="text" id="primary-color-picker"
                                                class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
                                                placeholder="#FF0000" />
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label for="secondary-color-picker"
                                                class="text-white text-sm">Secondary:</label>
                                            <input type="text" id="secondary-color-picker"
                                                class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
                                                placeholder="#0000FF" />
                                        </div>
                                    </div>
                                </div>



                                <div class="mb-6 flex items-center">
                                    <input type="checkbox" id="smart-mode-toggle"
                                        class="form-checkbox h-5 w-5 text-blue-500 rounded border-gray-600 bg-zinc-700 focus:ring-blue-500"
                                        checked />
                                    <label for="smart-mode-toggle" class="ml-2 text-sm text-white cursor-pointer">Let AI
                                        optimize layout & fonts for me</label>
                                </div>

                                <div class="mt-auto pt-4 border-t border-gray-700">
                                    <button id="generate-automatic-template-btn"
                                        class="w-full py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors duration-200">
                                        <!-- Font weight adjusted -->
                                        Generate Professional Template
                                    </button>

                                    <div id="ai-loading-overlay-automatic"
                                        class="fixed inset-0 bg-black/70 flex items-center justify-center z-40 hidden">
                                        <div class="text-center text-white">
                                            <div class="spinner-border text-zinc-100" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                            <p class="mt-4 text-lg">Generating your design...</p>
                                            <p class="text-sm text-gray-400">
                                                This might take a moment.
                                            </p>
                                        </div>
                                    </div>
                                    <div id="ai-loading-spinner-automatic" class="hidden text-center text-white mt-3">
                                        <div class="spinner-border text-blue-500" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-gray-300">
                                            Designing your certificate...
                                        </p>
                                    </div>
                                    <button id="regenerate-automatic-template-btn"
                                        class="hidden w-full py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors duration-200 mt-2">
                                        <!-- Font weight adjusted -->
                                        Regenerate Professional
                                    </button>
                                    <button id="revise-automatic-template-btn"
                                        class="hidden w-full py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors duration-200 mt-2">
                                        <!-- Font weight adjusted -->
                                        Revise Professional Design
                                    </button>
                                </div>
                            </div>

                            <!-- Manual (Quick) Tab Content -->
                            <div id="manual-tab-content" class="tab-content hidden">
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Enter Custom Prompt
                                    </h3>
                                    <!-- Font weight adjusted -->
                                    <textarea id="manual-prompt-input"
                                        class="w-full p-3 rounded-md bg-zinc-700 text-sm text-white border border-gray-600 focus:outline-none focus:border-blue-500 h-24"
                                        placeholder="Describe the certificate template you want to generate. E.g., 'A modern certificate for a coding competition winner with a blue and white theme and a minimalist layout.'"></textarea>
                                </div>

                                <!-- NEW: Logo upload/select for Manual Tab -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Add Background
                                    </h3>
                                    <div class="manual-bg-image-preview-container mb-2 hidden">
                                        <img class="manual-bg-image-preview w-fit h-24 object-contain mb-2" src=""
                                            alt="background" />
                                        <button
                                            class="manual-remove-bg-image-btn px-3 py-1 bg-zinc-600 text-white rounded-md text-sm hover:bg-zinc-700 transition-colors duration-200">
                                            <i class="fas fa-times-circle mr-1"></i>Remove
                                        </button>
                                    </div>
                                    <div
                                        class="manual-bg-upload-area border-2 border-dashed border-gray-600 rounded-lg p-3 text-center text-gray-400 cursor-pointer hover:border-blue-500 hover:text-white transition-colors duration-200">
                                        <span class="material-icons text-3xl mb-1"><i
                                                class="fas fa-cloud-upload-alt"></i></span>
                                        <p class="mb-3 text-sm">Drag & drop or</p>
                                        <input type="file" class="manual-logo-file-upload-input hidden"
                                            accept="image/*" />
                                        <button
                                            class="manual-browse-bg-files-button px-2  py-1  text-xs bg-zinc-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none text-sm">
                                            <i class="fas fa-folder-open mr-1"></i>Browse Files
                                        </button>
                                        <button id="manual-select-public-bg-btn"
                                            class="px-2  py-1 bg-zinc-600 text-white rounded-md  text-xs hover:bg-blue-700 transition-colors duration-200 focus:outline-none text-sm ml-1">
                                            <i class="fas fa-images mr-1"></i>Public
                                        </button>
                                        <button
                                            class="manual-select-existing-bg-btn px-2  py-1 bg-zinc-600 text-xs  text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none text-sm ml-1">
                                            <i class="fas fa-images mr-1"></i>Existing
                                        </button>
                                    </div>
                                    <input type="hidden" class="manual-logo-image-url" />
                                </div>

                                <!-- NEW: Brand/Color Selection for Manual Tab -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium text-white mb-3">
                                        Select Brand or Custom Colors
                                    </h3>
                                    <div class="relative mb-3">
                                        <select id="manual-brand-selector"
                                            class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 appearance-none">
                                            <option value="">-- Select a Brand --</option>
                                            <option value="custom">Custom Colors</option>
                                        </select>
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 20 20">
                                                <path
                                                    d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                            </svg>
                                        </div>
                                    </div>
                                    <div id="manual-custom-color-inputs" class="hidden">
                                        <p class="text-gray-400 text-sm mb-2">
                                            Choose primary and secondary colors:
                                        </p>
                                        <div class="flex flex-col gap-2 mb-2">
                                            <label for="manual-primary-color-picker"
                                                class="text-white text-xs">Primary:</label>
                                            <input type="text" id="manual-primary-color-picker"
                                                class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
                                                placeholder="#FF0000" />
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label for="manual-secondary-color-picker"
                                                class="text-white text-xs">Secondary:</label>
                                            <input type="text" id="manual-secondary-color-picker"
                                                class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
                                                placeholder="#0000FF" />
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6 flex items-center">
                                    <input type="checkbox" id="manual-smart-mode-toggle"
                                        class="form-checkbox h-5 w-5 text-blue-500 rounded border-gray-600 bg-zinc-700 focus:ring-blue-500"
                                        checked />
                                    <label for="manual-smart-mode-toggle"
                                        class="ml-2 text-sm text-white cursor-pointer">Let AI optimize layout & fonts
                                        for me</label>
                                </div>

                                <div class="mt-auto pt-4 border-t border-gray-700">
                                    <button id="generate-manual-template-btn"
                                        class="w-full py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors duration-200">
                                        <!-- Font weight adjusted -->
                                        Generate Quick Template
                                    </button>
                                    <div id="ai-loading-overlay-manual"
                                        class="fixed inset-0 bg-black/70 flex items-center justify-center z-40 hidden">
                                        <div class="text-center text-white">
                                            <div class="spinner-border text-zinc-100" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                            <p class="mt-4 text-lg">Generating your design...</p>
                                            <p class="text-sm text-gray-400">
                                                This might take a moment.
                                            </p>
                                        </div>
                                    </div>
                                    <button id="regenerate-manual-template-btn"
                                        class="hidden w-full py-1.5 bg-blue-600 text-white font-medium text-sm rounded-md hover:bg-blue-700 transition-colors duration-200 mt-2">
                                        <!-- Font weight adjusted -->
                                        Regenerate Quick
                                    </button>
                                    <!-- <button id="revise-manual-template-btn"
                                        class="hidden w-full py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors duration-200 mt-2">
                                        
                                        Revise Quick Design
                                    </button> -->
                                </div>
                            </div>

                            <div id="ai-generated-design-preview" class="mt-6 pt-4 pb-10 border-t border-gray-700">
                                <h3 class="text-lg font-medium text-white mb-3">
                                    Generated Design Preview
                                </h3>

                                <div id="aiLoadingOverlayManual" class="">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                                </div>
                                <div id="ai-design-previews-grid" class="grid grid-cols-2 gap-1 pb-10"></div>
                                <div id="generatedDesignMessage" class="text-center text-white text-sm mt-2 hidden">
                                </div>
                            </div>
                        </div>

                        <!-- Text Content -->
                        <div id="text-content" class="sidebar-content hidden">
                            <h2 class="text-xl font-semibold mb-4 text-white">
                                Text Tools
                            </h2>
                            <p class="text-gray-300">Add and format text.</p>
                            <div class="grid gap-2 my-2">
                                <button
                                    class="w-full text-white border border-gray-400 hover:bg-zinc-700 p-2 rounded-md text-4xl draggable-item"
                                    id="addH1" data-header="h1" data-type="text-heading" data-text="Add a Heading"
                                    data-font-size="60" data-font-weight="700">
                                    Header 1
                                </button>
                                <button
                                    class="w-full text-white border border-gray-400 hover:bg-zinc-700 p-2 rounded-md text-3xl draggable-item"
                                    id="addH2" data-header="h2" data-type="text-heading" data-text="Add a Subheading"
                                    data-font-size="50" data-font-weight="600">
                                    Header 2
                                </button>
                                <button
                                    class="w-full text-white border border-gray-400 hover:bg-zinc-700 p-2 rounded-md text-2xl draggable-item"
                                    id="addH3" data-header="h3" data-type="text-heading" data-text="Add a Title"
                                    data-font-size="40" data-font-weight="500">
                                    Header 3
                                </button>
                                <button
                                    class="w-full text-white border border-gray-400 hover:bg-zinc-700 p-2 rounded-md text-xl draggable-item"
                                    id="addH4" data-header="h4" data-type="text-heading" data-text="Add a Section Title"
                                    data-font-size="35" data-font-weight="500">
                                    Header 4
                                </button>
                                <button
                                    class="w-full text-white border border-gray-400 hover:bg-zinc-700 p-2 rounded-md text-lg draggable-item"
                                    id="addH5" data-header="h5" data-type="text-heading" data-text="Add a Small Title"
                                    data-font-size="30" data-font-weight="400">
                                    Header 5
                                </button>
                                <button
                                    class="w-full text-white border border-gray-400 hover:bg-zinc-700 p-2 rounded-md text-base my-1 draggable-item"
                                    id="addpara" data-header="p" data-type="text-body" data-text="Add body text"
                                    data-font-size="25" data-font-weight="400">
                                    Paragraph
                                </button>
                            </div>

                            <h3 class="text-lg font-medium text-white mb-3 mt-4">
                                Pre-designed Combinations
                            </h3>
                            <div class="grid grid-cols-2 gap-2 my-2">
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-start justify-center gap-0.5 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "Workflows", "fontSizeRatio": 0.0916, "fontWeight": "700", "textAlign": "center", "fontFamily": "Montserrat", "fill": "#8a63d2"}, {"text": "that work.", "fontSizeRatio": 0.0833, "fontWeight": "700", "textAlign": "center", "offsetY": 0, "fontFamily": "Montserrat", "fill": "#99cc99"}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-xl font-bold" style="
                          font-family: 'Montserrat', sans-serif;
                          color: #8a63d2;
                        ">Workflows</span>
                                        <span class="text-xl font-bold" style="
                          font-family: 'Montserrat', sans-serif;
                          color: #99cc99;
                        ">that work.</span>
                                    </div>
                                </button>
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-center justify-center gap-1 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "Diskon", "fontSizeRatio": 0.0666, "fontWeight": "bold", "textAlign": "center", "fontFamily": "Poppins", "fill": "#000"}, {"text": "50%", "fontSizeRatio": 0.1333, "fontWeight": "900", "textAlign": "center", "offsetY": -10, "fontFamily": "Oswald", "fill": "#ffcc00"}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-lg font-bold"
                                            style="font-family: 'Poppins', sans-serif; color: #000">Diskon</span>
                                        <span class="text-3xl font-extrabold" style="
                          font-family: 'Oswald', sans-serif;
                          color: #ffcc00;
                        ">50%</span>
                                    </div>
                                </button>
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-center justify-center gap-1 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "Join the", "fontSizeRatio": 0.05, "fontWeight": "normal", "textAlign": "center", "fontFamily": "Great Vibes", "fill": "#ADD8E6"}, {"text": "Celebration!", "fontSizeRatio": 0.0916, "fontWeight": "bold", "textAlign": "center", "offsetY": -10, "fontFamily": "Pacifico", "fill": "#87CEEB"}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-md" style="
                          font-family: 'Great Vibes', cursive;
                          color: #add8e6;
                        ">Join the</span>
                                        <span class="text-2xl font-bold"
                                            style="font-family: 'Pacifico', cursive; color: #87ceeb">Celebration!</span>
                                    </div>
                                </button>
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-center justify-center gap-0.5 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "CUSTOM", "fontSizeRatio": 0.075, "fontWeight": "bold", "textAlign": "center", "fontFamily": "Bebas Neue", "fill": "#cccccc", "charSpacing": 50}, {"text": "PAINT", "fontSizeRatio": 0.1, "fontWeight": "bold", "textAlign": "center", "offsetY": -10, "fontFamily": "Anton", "fill": "#FFA500", "charSpacing": 100}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-lg font-bold uppercase tracking-widest" style="
                          font-family: 'Bebas Neue', sans-serif;
                          color: #cccccc;
                        ">Custom</span>
                                        <span class="text-2xl font-bold uppercase tracking-wider"
                                            style="font-family: 'Anton', sans-serif; color: #ffa500">Paint</span>
                                    </div>
                                </button>
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-center justify-center gap-0.5 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "BOLD", "fontSizeRatio": 0.1, "fontWeight": "900", "textAlign": "center", "fontFamily": "Inter", "fill": "#000"}, {"text": "Statement", "fontSizeRatio": 0.06, "fontWeight": "300", "textAlign": "center", "offsetY": 5, "fontFamily": "Inter", "fill": "#a0aec0"}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-2xl font-extrabold"
                                            style="font-family: 'Inter', sans-serif; color: #000">BOLD</span>
                                        <span class="text-base font-light text-gray-400"
                                            style="font-family: 'Inter', sans-serif; color: #a0aec0">Statement</span>
                                    </div>
                                </button>

                                <!-- New Combination: Elegant Script Quote -->
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-center justify-center gap-0.5 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "Inspire", "fontSizeRatio": 0.08, "fontWeight": "normal", "textAlign": "center", "fontFamily": "Dancing Script", "fill": "#FFD700"}, {"text": "Dreams", "fontSizeRatio": 0.07, "fontWeight": "normal", "textAlign": "center", "offsetY": -5, "fontFamily": "Dancing Script", "fill": "#FFD700"}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-xl" style="
                          font-family: 'Dancing Script', cursive;
                          color: #ffd700;
                        ">Inspire</span>
                                        <span class="text-lg" style="
                          font-family: 'Dancing Script', cursive;
                          color: #ffd700;
                        ">Dreams</span>
                                    </div>
                                </button>

                                <!-- New Combination: Retro Vibe -->
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-center justify-center gap-0.5 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "RETRO", "fontSizeRatio": 0.09, "fontWeight": "bold", "textAlign": "center", "fontFamily": "Press Start 2P", "fill": "#FF69B4"}, {"text": "WAVE", "fontSizeRatio": 0.08, "fontWeight": "bold", "textAlign": "center", "offsetY": -5, "fontFamily": "Press Start 2P", "fill": "#8A2BE2"}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-lg font-bold" style="
                          font-family: 'Press Start 2P', cursive;
                          color: #ff69b4;
                        ">RETRO</span>
                                        <span class="text-base font-bold" style="
                          font-family: 'Press Start 2P', cursive;
                          color: #8a2be2;
                        ">WAVE</span>
                                    </div>
                                </button>

                                <!-- New Combination: Minimalist Tagline -->
                                <button
                                    class="w-full text-white border border-gray-600 bg-zinc-700 hover:bg-zinc-600 p-3 rounded-md text-base draggable-item flex flex-col items-center justify-center gap-0.5 shadow-sm hover:shadow-md transition-all duration-200"
                                    data-type="text-combination"
                                    data-text-configs='[{"text": "Less is", "fontSizeRatio": 0.05, "fontWeight": "normal", "textAlign": "center", "fontFamily": "Roboto", "fill": "#cccccc"}, {"text": "More.", "fontSizeRatio": 0.07, "fontWeight": "bold", "textAlign": "center", "offsetY": 0, "fontFamily": "Roboto", "fill": "#000"}]'>
                                    <div class="flex flex-col items-center justify-center w-full">
                                        <span class="text-sm text-gray-400" style="
                          font-family: 'Roboto', sans-serif;
                          color: #cccccc;
                        ">Less is</span>
                                        <span class="text-lg font-bold"
                                            style="font-family: 'Roboto', sans-serif; color: #000">More.</span>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div id="elements-content" class="sidebar-content hidden">
                            <h2 class="text-xl font-semibold mb-4 text-white">Elements</h2>

                            <!-- Tab Buttons for Elements -->
                            <div
                                class="flex mb-4 flex-nowrap gap-2 whitespace-nowrap overflow-x-auto elements-tabs-scroll pb-2">
                                <button id="shapes-tab-btn"
                                    class="flex-1 rounded-md bg-zinc-700 px-2 py-1.5 text-sm text-white">
                                    Shapes
                                </button>
                                <button id="icons-tab-btn"
                                    class="flex-1 rounded-md bg-zinc-700 px-2 py-1.5 text-sm text-gray-400">
                                    Icons
                                </button>
                                <button id="frames-tab-btn"
                                    class="flex-1 rounded-md bg-zinc-700 px-2 py-1.5 text-sm text-gray-400">
                                    Frames
                                </button>
                                <button id="stickers-gifs-tab-btn"
                                    class="flex-1 rounded-md bg-zinc-700 px-2 py-1.5 text-sm text-gray-400">
                                    Stickers & GIFs
                                </button>
                            </div>

                            <!-- Shapes Tab Panel -->
                            <div id="shapes-tab-panel" class="elements-tab-content">
                                <p class="text-gray-300 mb-4">
                                    Add shapes, lines, and other basic forms.
                                </p>
                                <div id="shape-toolbar-bordered" class="flex flex-wrap gap-2 mt-2" role="group"
                                    aria-label="Shape Toolbar Bordered">
                                    <button id="addRectangleBorderedBtn" type="button"
                                        class="w-[60px] h-[60px] border-2 border-blue-500 text-[#00809D] p-2 rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="rect" data-fill="#00809D" data-stroke="#00809D"
                                        data-stroke-width="2">
                                        <span class="material-icons">rectangle</span>
                                    </button>
                                    <button id="addCircleBorderedBtn" type="button"
                                        class="w-[60px] h-[60px] border-2 border-green-500 text-[#28a745] p-2 rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="circle" data-fill="#28a745" data-stroke="#28a745"
                                        data-stroke-width="2">
                                        <i class="fas fa-circle"></i>
                                    </button>
                                    <button id="addTriangleBorderedBtn" type="button"
                                        class="w-[60px] h-[60px] border-2 border-yellow-500 p-2 text-[#ffc107] rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="triangle" data-fill="#ffc107" data-stroke="#ffc107"
                                        data-stroke-width="2">
                                        <i class="fas fa-caret-up"></i>
                                    </button>

                                    <button id="addLineBorderedBtn" type="button"
                                        class="w-[60px] h-[60px] border-2 border-orange-500 p-2 text-[#fd7e14] rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="line" data-stroke="#fd7e14" data-stroke-width="2">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button id="addPolygonBorderedBtn" type="button"
                                        class="w-[60px] h-[60px] border-2 border-red-500 p-2 text-[#dc3545] rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="polygon" data-fill="#dc3545" data-stroke="#dc3545"
                                        data-stroke-width="2">
                                        <i class="fas fa-square"></i>
                                    </button>
                                </div>
                                <div id="shape-toolbar-filled" class="mt-2 flex flex-row flex-wrap gap-2" role="group"
                                    aria-label="Shape Toolbar Filled">
                                    <button id="addRectangleBtn" type="button"
                                        class="w-[60px] h-[60px] bg-zinc-600 hover:bg-zinc-700 text-white p-2 rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="rect" data-fill="#6c757d">
                                        <span class="material-icons">rectangle</span>
                                    </button>
                                    <button id="addCircleBtn" type="button"
                                        class="w-[60px] h-[60px] bg-zinc-600 hover:bg-zinc-700 text-white p-2 rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="circle" data-fill="#6c757d">
                                        <span class="material-icons">circle</span>
                                    </button>
                                    <button id="addTriangleBtn" type="button"
                                        class="w-[60px] h-[60px] bg-zinc-600 hover:bg-zinc-700 text-white p-2 rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="triangle" data-fill="#6c757d">
                                        <span class="material-icons">change_history</span>
                                    </button>

                                    <button id="addLineBtn" type="button"
                                        class="w-[60px] h-[60px] bg-zinc-600 hover:bg-zinc-700 text-white p-2 rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="line" data-stroke="#6c757d" data-stroke-width="2">
                                        <span class="material-icons">remove</span>
                                    </button>
                                    <button id="addPolygonBtn" type="button"
                                        class="w-[60px] h-[60px] bg-zinc-600 hover:bg-zinc-700 text-white p-2 rounded-md flex items-center justify-center text-4xl draggable-item"
                                        data-type="polygon" data-fill="#6c757d">
                                        <i class="fa-solid fa-square"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Icons Tab Panel -->
                            <div id="icons-tab-panel" class="elements-tab-content hidden">
                                <h5 class="text-xl font-semibold mb-4 text-white">Icons</h5>
                                <div class="flex items-center gap-2 mb-4 flex-wrap">
                                    <input type="text" id="icons-search-input" placeholder="Search icons..."
                                        class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:border-blue-500"
                                        value="medal" />
                                    <button id="searchIconBtn"
                                        class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                        Search
                                    </button>
                                </div>
                                <div id="iconResults" class="mt-1 flex flex-wrap gap-2">
                                    <!-- Icon search results will be displayed here -->
                                </div>
                                <div id="iconLoading" class="hidden text-center mt-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Frames Tab Panel -->
                            <div id="frames-tab-panel" class="elements-tab-content hidden">
                                <h2 class="text-xl font-semibold mb-4 text-white">Frames</h2>
                                <p class="text-gray-300">
                                    Choose from various frames for your images.
                                </p>
                                <!-- Frame content goes here -->
                                <div class="grid grid-cols-2 gap-2 mt-4">
                                    <!-- Example Frame 1: Simple Rectangle -->
                                    <div class="frame-item cursor-pointer border-2 border-gray-600 rounded-md overflow-hidden hover:border-blue-500 transition-colors duration-200"
                                        data-frame-type="rect"
                                        data-frame-properties='{"stroke":"#000000","strokeWidth":10,"rx":0,"ry":0}'>
                                        <img src="https://placehold.co/100x100/e0e0e0/333333?text=Frame+1" alt="Frame 1"
                                            class="w-full h-auto object-cover" />
                                        <p class="text-center text-sm text-gray-400 py-1">
                                            Rectangle
                                        </p>
                                    </div>
                                    <!-- Example Frame 2: Rounded Rectangle -->
                                    <div class="frame-item cursor-pointer border-2 border-gray-600 rounded-lg overflow-hidden hover:border-blue-500 transition-colors duration-200"
                                        data-frame-type="rect"
                                        data-frame-properties='{"stroke":"#000000","strokeWidth":10,"rx":20,"ry":20}'>
                                        <img src="https://placehold.co/100x100/d0d0d0/333333?text=Frame+2" alt="Frame 2"
                                            class="w-full h-auto object-cover" />
                                        <p class="text-center text-sm text-gray-400 py-1">
                                            Rounded
                                        </p>
                                    </div>
                                    <!-- Example Frame 3: Circle -->
                                    <div class="frame-item cursor-pointer border-2 border-gray-600 rounded-full overflow-hidden flex items-center justify-center hover:border-blue-500 transition-colors duration-200"
                                        data-frame-type="circle"
                                        data-frame-properties='{"stroke":"#000000","strokeWidth":10}'>
                                        <img src="https://placehold.co/100x100/c0c0c0/333333?text=Frame+3" alt="Frame 3"
                                            class="w-full h-auto object-cover rounded-full" />
                                        <p class="text-center text-sm text-gray-400 py-1">
                                            Circle
                                        </p>
                                    </div>
                                    <!-- Example Frame 4: Abstract Shape (Placeholder) -->
                                    <div class="frame-item cursor-pointer border-2 border-gray-600 rounded-md overflow-hidden hover:border-blue-500 transition-colors duration-200"
                                        data-frame-type="polygon"
                                        data-frame-properties='{"stroke":"#000000","strokeWidth":10}'>
                                        <img src="https://placehold.co/100x100/b0b0b0/333333?text=Frame+4" alt="Frame 4"
                                            class="w-full h-auto object-cover" />
                                        <p class="text-center text-sm text-gray-400 py-1">
                                            Abstract
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Stickers & GIFs Tab Panel -->
                            <div id="stickers-gifs-tab-panel" class="elements-tab-content hidden">
                                <h2 class="text-xl font-semibold mb-4 text-white">
                                    Stickers & GIFs
                                </h2>
                                <p class="text-gray-300 mb-4">
                                    Add fun stickers and GIFs to your design.
                                </p>
                                <div class="flex items-center gap-2 mb-4 flex-wrap">
                                    <input type="text" id="giphy-search-input" placeholder="Search stickers/GIFs..."
                                        class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:border-blue-500" />
                                    <button id="searchGiphyBtn"
                                        class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                        Search
                                    </button>
                                </div>
                                <div id="giphyResults" class="mt-4 grid grid-cols-2 gap-2">
                                    <!-- Giphy search results will be displayed here -->
                                </div>
                                <div id="giphyLoading" class="hidden text-center mt-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Background Content  -->
                        <div id="background-content" class="sidebar-content">
                            <h5 class="text-xl font-semibold text-white mb-4">
                                Certificate Backgrounds
                            </h5>
                            <div class="flex items-center gap-2 mb-4 flex-wrap">
                                <input type="text" id="designSearchQuery" placeholder="Search backgrounds..."
                                    value="certificate"
                                    class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:border-blue-500" />
                                <button id="designSearchButton"
                                    class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                    Search
                                </button>
                            </div>
                            <div id="backgroundLoading" class="hidden text-center mt-4 w-full">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>

                            <div id="backgroundSearchResults" class="mt-4 grid grid-cols-2 gap-2">
                                <!-- Background templates will be loaded here -->

                            </div>
                        </div>

                        <!-- Photos -->
                        <div id="photos-content" class="sidebar-content hidden">
                            <h5 class="text-xl font-semibold text-white mb-4">Photos</h5>
                            <div class="flex items-center gap-2 mb-4 flex-wrap">
                                <input type="text" id="photosSearchQuery" placeholder="Search Photos..." value="peace"
                                    class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:border-blue-500" />
                                <button id="photoSearchButton"
                                    class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                    Search
                                </button>
                            </div>
                            <div id="photoSearchResults" class="mt-4 grid grid-cols-2 gap-2">
                                <!-- Photo search results will be displayed here -->
                            </div>
                            <div id="photoLoading" class="hidden text-center mt-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Brand Kit Content -->
                        <div id="brand-content" class="sidebar-content hidden">
                            <h2 class="text-xl font-semibold mb-4 text-white">Brand Kit</h2>
                            <p class="text-gray-300 mb-4">
                                Manage your brand logos, colors, and fonts.
                            </p>

                            <!-- Brand Selection/Creation -->
                            <div class="mb-6 p-4 bg-zinc-700 rounded-md">
                                <h3 class="text-lg font-medium text-white mb-3">
                                    Select or Create Brand
                                </h3>
                                <div class="relative mb-3">
                                    <select id="brandSelector"
                                        class="w-full p-2 rounded-md bg-zinc-600 text-white border border-gray-500 focus:outline-none focus:border-blue-500 appearance-none">
                                        <option value="">-- Select a Brand --</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                        </svg>
                                    </div>
                                </div>
                                <input type="text" id="newBrandNameInput"
                                    class="w-full p-2 rounded-md bg-zinc-600 text-white border border-gray-500 focus:outline-none focus:border-blue-500 placeholder-gray-400"
                                    placeholder="Enter new brand name" />
                                <button id="createNewBrandBtn"
                                    class="w-full mt-3 py-2 bg-zinc-600 text-white font-bold rounded-md hover:bg-zinc-700 transition-colors duration-200">
                                    Create New Brand
                                </button>
                                <div id="brandLoader" class="hidden text-center mt-3">
                                    <div class="spinner-border text-blue-500" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Brand Details Display -->
                            <div id="currentBrandDetails" class="hidden">
                                <div class="mb-6 p-4 bg-zinc-700 rounded-md">
                                    <h3 class="text-lg font-medium text-white mb-3 flex justify-between items-center">
                                        <span id="currentBrandName"></span>
                                        <button id="deleteCurrentBrandBtn"
                                            class="px-3 py-2 bg-zinc-600 text-blue-400 rounded-full text-sm hover:bg-zinc-800 transition-colors duration-200">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </h3>
                                </div>

                                <!-- Logos Section -->
                                <div class="mb-6 p-4 bg-zinc-700 rounded-md">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="text-lg font-medium text-white">Logos</h3>
                                        <button id="addLogoButton"
                                            class="w-8 h-8 flex items-center justify-center bg-zinc-600 text-blue-400 rounded-full hover:bg-zinc-800 transition-colors duration-200">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="brandLogos" class="grid grid-cols-3 gap-2 mb-3">
                                        <!-- Logos will be rendered here -->
                                    </div>

                                    <div id="logo-add-options" class="hidden flex flex-col gap-3">
                                        <div class="flex items-center justify-center gap-2">
                                            <button id="selectExistingLogoBtn"
                                                class="flex-1 px-3 py-2 bg-zinc-800 text-white rounded-md hover:bg-zinc-900 transition-colors duration-200 text-sm text-center">
                                                Select Existing
                                            </button>
                                            <span class="text-gray-400 text-sm">or</span>
                                            <label for="newLogoInput"
                                                class="flex-1 px-3 py-2 bg-zinc-700 text-white rounded-md hover:bg-zinc-600 transition-colors duration-200 focus:outline-none cursor-pointer text-center text-sm">
                                                Upload New
                                            </label>
                                            <input type="file" id="newLogoInput" class="hidden"
                                                accept="image/*,image/svg+xml" />
                                        </div>

                                        <!-- Logo Version Selector -->
                                        <div class="relative w-full">
                                            <select id="newLogoVersion"
                                                class="w-full p-2 rounded-md bg-zinc-600 text-white border border-gray-500 text-sm focus:outline-none focus:border-blue-500 appearance-none">
                                                <option value="default">Default Version</option>
                                                <option value="light">Light Mode</option>
                                                <option value="dark">Dark Mode</option>
                                                <option value="mono">Monochromatic</option>
                                            </select>
                                            <div
                                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                    viewBox="0 0 20 20">
                                                    <path
                                                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Colors Section -->
                                <div class="mb-6 p-4 bg-zinc-700 rounded-md">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="text-lg font-medium text-white">Colors</h3>
                                        <button id="addColorSectionButton"
                                            class="w-8 h-8 flex items-center justify-center bg-zinc-600 text-blue-400 rounded-full hover:bg-zinc-800 transition-colors duration-200">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="brandColors" class="flex gap-2 mb-3">
                                        <!-- Colors will be rendered here -->
                                    </div>
                                    <div id="color-input-area"
                                        class="hidden flex gap-2 items-center brand-colors flex-wrap">
                                        <input type="text" id="newColorPicker"
                                            class="flex-1 p-2 rounded-md bg-zinc-600 text-sm text-white focus:outline-none"
                                            placeholder="Pick a color" />
                                        <div class="flex flex-wrap gap-2">
                                            <div class="relative">
                                                <select id="newColorVersion"
                                                    class="p-2 rounded-md bg-zinc-600 text-white text-sm border border-gray-500 focus:outline-none focus:border-blue-500 appearance-none">
                                                    <option value="default">Default</option>
                                                    <option value="light">Light Mode</option>
                                                    <option value="dark">Dark Mode</option>
                                                </select>
                                                <div
                                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                        viewBox="0 0 20 20">
                                                        <path
                                                            d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <button id="addColorBtn"
                                            class="w-10 h-10 flex items-center justify-center bg-zinc-600 text-blue-400 rounded-full hover:bg-zinc-800 transition-colors duration-200">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Fonts Section -->
                                <div class="mb-6 p-4 bg-zinc-700 rounded-md">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="text-lg font-medium text-white">Fonts</h3>
                                        <button id="addFontSectionButton"
                                            class="w-8 h-8 flex items-center justify-center bg-zinc-600 text-blue-400 rounded-full hover:bg-zinc-800 transition-colors duration-200">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div id="font-content-area" class="hidden">
                                        <div id="brandFonts" class="flex flex-col gap-2 mb-3">
                                            <!-- Font categories will be rendered here by JavaScript -->
                                        </div>
                                        <div id="font-assignment-area">
                                            <button id="openFontAssignmentModalBtn"
                                                class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 mt-2">
                                                <i class="fas fa-font mr-2"></i> Assign / Edit Font
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <button id="saveBrandChangesBtn"
                                    class="w-full py-2 bg-zinc-600 text-white font-medium rounded-md hover:bg-zinc-800 transition-colors duration-200">
                                    Save Brand Changes
                                </button>
                            </div>
                        </div>

                        <!-- Font Assignment Modal -->
                        <div id="fontAssignmentModal"
                            class="fixed inset-0 bg-black/50 items-center justify-center z-50 hidden">
                            <div class="bg-zinc-800 p-6 rounded-lg shadow-xl max-w-sm w-full m-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 id="fontModalLabel" class="text-xl font-semibold text-white">
                                        Assign Font
                                    </h3>
                                    <button id="closeFontAssignmentModal"
                                        class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                        &times;
                                    </button>
                                </div>
                                <div class="text-gray-300 mb-4">
                                    <input type="hidden" id="fontModalOriginalCategory" />

                                    <!-- Inside <div id="fontAssignmentModal"> ... -->
                                    <div class="relative mb-4">
                                        <label class="block text-sm font-medium text-white mb-1">Select Font:</label>
                                        <!-- Display area for the selected font -->
                                        <div id="fontModalSelectFontDisplay"
                                            class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 cursor-pointer flex justify-between items-center">
                                            <span id="selectedFontModalText" class="truncate">-- Select a Font --</span>
                                            <svg class="fill-current h-4 w-4 text-gray-400"
                                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                                <path
                                                    d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                            </svg>
                                        </div>

                                        <input type="hidden" id="fontModalSelectFont" value="" />

                                        <ul id="fontModalFontList"
                                            class="absolute z-10 w-full bg-zinc-700 border border-gray-600 rounded-md mt-1 max-h-60 overflow-y-auto hidden">
                                        </ul>
                                    </div>
                                    <div class="relative mb-4">
                                        <label for="fontModalFontSizeInput"
                                            class="block text-sm font-medium text-white mb-1">Font Size (px):</label>
                                        <input type="number" id="fontModalFontSizeInput" min="8" max="100" value="24"
                                            class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500" />
                                    </div>
                                    <div class="relative mb-4">
                                        <label for="fontModalFontWeightSelect"
                                            class="block text-sm font-medium text-white mb-1">Font Weight:</label>
                                        <select id="fontModalFontWeightSelect"
                                            class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 appearance-none">
                                            <option value="">-- Select Weight --</option>
                                            <option value="100">Thin (100)</option>
                                            <option value="200">Extra Light (200)</option>
                                            <option value="300">Light (300)</option>
                                            <option value="400">Normal (400)</option>
                                            <option value="500">Medium (500)</option>
                                            <option value="600">Semi Bold (600)</option>
                                            <option value="700">Bold (700)</option>
                                            <option value="800">Extra Bold (800)</option>
                                            <option value="900">Black (900)</option>
                                        </select>
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 20 20">
                                                <path
                                                    d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                            </svg>
                                        </div>
                                    </div>

                                    <div class="relative mb-4">
                                        <label for="fontModalAssignCategorySelect"
                                            class="block text-sm font-medium text-white mb-1">Assign to
                                            Category:</label>
                                        <select id="fontModalAssignCategorySelect"
                                            class="w-full p-2 rounded-md bg-zinc-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 appearance-none">
                                            <option value="">-- Select Category --</option>
                                            <option value="Title">Title</option>
                                            <option value="Subtitle">Subtitle</option>
                                            <option value="Heading">Heading</option>
                                            <option value="Subheading">Subheading</option>
                                            <option value="Section Header">Section Header</option>
                                            <option value="Body">Body</option>
                                            <option value="Quote">Quote</option>
                                            <option value="Caption">Caption</option>
                                        </select>
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 20 20">
                                                <path
                                                    d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button id="saveFontAssignmentBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200    text-sm ">
                                        Save Assignment
                                    </button>
                                    <button id="cancelFontAssignmentBtn"
                                        class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200 text-sm">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Image Upload Content -->
                        <div id="image-upload-content" class="sidebar-content hidden">
                            <h2 class="text-xl font-semibold mb-4 text-white">
                                Uploaded Images
                            </h2>
                            <div class="flex items-center gap-2 mb-4 flex-wrap">
                                <input type="text" id="uploadedImageSearchQuery" placeholder="Search uploaded images..."
                                    value=""
                                    class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:border-blue-500" />
                                <button id="uploadedImageSearchButton"
                                    class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                    Search
                                </button>
                            </div>

                            <div class="mb-4">
                                <input type="file" id="file-upload-input" class="hidden" accept="image/*" multiple />
                                <button id="browse-files-button"
                                    class="w-full px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none">
                                    Click to Upload Image
                                </button>
                                <p class="text-xs mt-2 text-gray-500 text-center">
                                    Supported formats: JPG, PNG, GIF
                                </p>
                            </div>
                            <div id="image-loader" class=" flex justify-center items-center py-4 hidden">
                                <div class="spinner-border" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <div id="uploadedImagesLoading" class=" flex justify-center items-center py-4 hidden">
                                <div class="spinner-border" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <div id="uploadedImages" class="mt-3 grid grid-cols-2 gap-2">
                                <!-- Uploaded image previews will be added here -->
                                <div id="uploadedImagesLoading" class="hidden text-center mt-4 w-full">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Frames Content -->
                        <div id="frames-content" class="sidebar-content hidden">
                            <h2 class="text-xl font-semibold mb-4 text-white">Frames</h2>
                            <p class="text-gray-300">
                                Choose from various frames for your images.
                            </p>
                        </div>
                        <!-- QR Code Content -->
                        <div id="qr-code-content" class="sidebar-content hidden">
                            <h5 class="text-xl font-semibold mb-4 text-white">
                                Generate QR codes for your links
                            </h5>
                            <div class="flex items-center gap-2 mb-4 flex-wrap">
                                <input type="text" id="qrCodeUrlInput" placeholder="Enter URL here"
                                    class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:border-blue-500" />
                                <button id="generateQrCodeBtn"
                                    class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                    Generate
                                </button>
                            </div>
                            <div id="qrCodeDisplay" class="mt-4 flex items-center flex-wrap">
                                <!-- QR Code will be displayed here -->
                                <div id="qrCodeLoading" class="hidden text-center mt-4 w-full">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Variable Gifs Content -->
                        <div id="variable-gifs-content" class="sidebar-content hidden">
                            <h2 class="text-xl font-semibold mb-4 text-white">Variables</h2>
                            <div class="flex items-center gap-2 mb-4 flex-wrap">
                                <input type="text" id="variable-name-input" placeholder="Add Variable"
                                    class="flex-1 p-2 rounded-md bg-[#424751] text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                                <button id="add-variable-btn"
                                    class="px-4 py-2 bg-zinc-600 text-white rounded-md hover:bg-gray-500 transition-colors duration-200">
                                    Add Variable
                                </button>
                            </div>
                            <div id="components-list" class="mt-4 flex flex-wrap gap-2">
                                <!-- Predefined and custom variables will be rendered here -->
                                <div id="variablesLoading" class="hidden text-center mt-4 w-full">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Stickers & Gifs Content -->
                        <div id="stickers-gifs-content" class="sidebar-content hidden">
                            <h2 class="text-xl font-semibold mb-4 text-white">
                                Stickers & GIFs
                            </h2>
                            <p class="text-gray-300">Add fun stickers and GIFs.</p>
                            <!-- Removed duplicate icon search elements from here -->
                        </div>
                    </div>
                </div>
                <!-- Main Content Wrapper -->
                <div id="main-content-wrapper"
                    class="flex flex-col w-full transition-all duration-300 ease-in-out md:h-auto">
                    <!-- Object Toolbar (Dynamic based on selection) -->

                    <div id="object-toolbar"
                        class="bg-gradient-to-r from-zinc-700 to-zinc-900 py-3 px-6 h-[53px] shadow-lg md:justify-center flex items-center gap-6 z-10 overflow-y-hidden overflow-x-auto whitespace-nowrap max-w-full w-full text-white center-global"
                        style="scrollbar-width: thin; scrollbar-color: #9ca3af #374151">
                        <!-- Global Controls -->
                        <div id="global-controls" class="flex items-center gap-3" data-toolbar-group="global">
                            <label for="bgColorPicker" class="text-xs md:text-sm font-medium">Background:</label>
                            <input type="color" id="bgColorPicker" value="#ffffff"
                                class="w-10 h-10 rounded-md cursor-pointer border-none" />
                        </div>


                        <!-- Text Formatting Controls -->
                        <div id="text-formatting" class="flex items-center gap-3 whitespace-nowrap"
                            data-toolbar-group="text">
                            <div class="relative w-40">
                                <!-- Adjust width as needed -->
                                <select id="fontFamily"
                                    class="bg-zinc-600 text-white py-1 px-2 outline-0 rounded-md text-xs md:text-sm w-40">

                                </select>
                                <!-- Hidden input to store the actual selected font value for toolbar -->
                                <input type="hidden" id="fontFamilyHidden" value="" />
                            </div>
                            <div class="flex items-center rounded-md overflow-hidden bg-zinc-600 text-white">
                                <button id="minusBtn" class="py-1 px-2 hover:bg-gray-500 transition-colors">
                                    -
                                </button>
                                <input type="number" id="fontSizeInput" min="8" max="500" value="24"
                                    class="w-10 bg-transparent text-white text-center outline-none border-none py-1 text-sm" />
                                <button id="plusBtn" class="py-1 px-2 hover:bg-gray-500 transition-colors">
                                    +
                                </button>
                            </div>

                            <input type="color" id="fontColorPicker" value="#000000"
                                class="w-10 h-10 rounded-md cursor-pointer border-none" />

                            <!-- Text Styles -->
                            <button id="boldBtn" class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button id="italicBtn" class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button id="underlineBtn" class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors">
                                <i class="fas fa-underline"></i>
                            </button>
                            <button id="strikethroughBtn"
                                class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors">
                                <i class="fas fa-strikethrough"></i>
                            </button>
                            <!-- New Capitalize Button -->
                            <button id="capitalizeBtn" class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors"
                                title="Capitalize Text">
                                <i class="fas fa-font"></i>
                                <!-- Using a generic font icon for now -->
                            </button>

                            <div class="relative">
                                <button id="textAlignToggle"
                                    class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors"
                                    title="Text Alignment">
                                    <i class="fas fa-align-left"></i>
                                    <!-- Default icon, will update based on selection -->
                                </button>
                            </div>

                            <!-- Merged Text Properties Control (Font Thickness, Line Height, Letter Spacing) -->
                            <div class="relative">
                                <button id="textPropertiesToggle"
                                    class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors"
                                    title="Text Properties">
                                    <i class="fas fa-text-height"></i>
                                    <!-- Generic icon for text properties -->
                                </button>
                            </div>
                        </div>

                        <!-- Element Colors and Border Controls -->
                        <div id="element-colors" class="flex items-center gap-3 whitespace-nowrap"
                            data-toolbar-group="element">
                            <label for="elementFillPicker" class="text-xs md:text-sm font-medium">Fill:</label>
                            <input type="color" id="elementFillPicker" value="#cccccc"
                                class="w-10 h-10 rounded-md cursor-pointer border-none" />
                            <label for="borderColorPicker" class="text-xs md:text-sm font-medium">Border:</label>
                            <input type="color" id="borderColorPicker" value="#000000"
                                class="w-10 h-10 rounded-md cursor-pointer border-none" />
                            <label for="borderThickness" class="text-xs md:text-sm font-medium">Thickness:</label>
                            <input type="number" id="borderThickness" min="0" max="10" value="0"
                                class="w-16 bg-zinc-600 text-white py-1 px-2 rounded-md text-sm" />
                            <select id="borderType" class="bg-zinc-600 text-white py-1 px-2 rounded-md text-sm">
                                <option value="solid">Solid</option>
                                <option value="dashed">Dashed</option>
                                <option value="dotted">Dotted</option>
                            </select>
                            <label for="elementBorderRadius" class="text-xs md:text-sm font-medium">Radius:</label>
                            <input type="number" id="elementBorderRadius" min="0" max="100" value="0"
                                class="w-16 bg-zinc-600 text-white py-1 px-2 rounded-md text-sm" />
                        </div>

                        <!-- Image Controls -->
                        <div id="image-controls" class="flex items-center gap-3 whitespace-nowrap"
                            data-toolbar-group="image">
                            <label for="imageBorderColor" class="text-xs md:text-sm font-medium">Border:</label>
                            <input type="color" id="imageBorderColor" value="#000000"
                                class="w-10 h-10 rounded-md cursor-pointer border-none" />
                            <label for="imageBorderThickness" class="text-xs md:text-sm font-medium">Thickness:</label>
                            <input type="number" id="imageBorderThickness" min="0" max="10" value="0"
                                class="w-16 bg-zinc-600 text-white px-2 py-1 rounded-md text-sm" />
                            <label for="imageBorderRadius" class="text-sm font-medium">Radius:</label>
                            <input type="number" id="imageBorderRadius" min="0" max="100" value="0"
                                class="w-16 bg-zinc-600 text-white px-2 py-1 rounded-md text-sm" />

                            <!-- Flip -->
                            <button id="flipXBtn"
                                class="p-1 rounded-md hover:bg-gray-500 transition-colors text-xs md:text-sm"
                                title="Flip Horizontal">
                                <i class="fas fa-arrows-alt-h"></i> Flip X
                            </button>
                            <button id="flipYBtn"
                                class="p-1 rounded-md hover:bg-gray-500 transition-colors text-xs md:text-sm"
                                title="Flip Vertical">
                                <i class="fas fa-arrows-alt-v"></i> Flip Y
                            </button>
                            <!-- Crop Button -->
                            <button id="cropImageBtn"
                                class="p-1 rounded-md hover:bg-gray-500 transition-colors text-xs md:text-sm"
                                title="Crop Image">
                                <i class="fas fa-crop-alt"></i> Crop
                            </button>
                        </div>
                        <!-- Crop Actions (shown only during cropping) -->
                        <div id="crop-actions" class="flex items-center gap-2 whitespace-nowrap"
                            data-toolbar-group="crop">
                            <button id="applyCropBtn"
                                class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 text-sm">
                                <i class="fas fa-check mr-1"></i>Apply
                            </button>
                            <button id="cancelCropBtn"
                                class="px-3 py-1 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200 text-sm">
                                <i class="fas fa-times mr-1"></i>Cancel
                            </button>
                        </div>

                        <!-- General Actions -->
                        <div id="general-element-actions"
                            class="flex items-center gap-3 whitespace-nowrap max-w-full relative"
                            data-toolbar-group="general-actions">
                            <svg id="toogleButton" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24"
                                class="text-gray-300 hover:text-white cursor-pointer transition-colors">
                                <g fill="currentColor" fill-rule="evenodd">
                                    <path
                                        d="M3 2h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z">
                                    </path>
                                    <path
                                        d="M11 2h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"
                                        opacity=".45"></path>
                                    <path
                                        d="M19 2h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"
                                        opacity=".15"></path>
                                    <path
                                        d="M7 6h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"
                                        opacity=".7"></path>
                                    <path
                                        d="M15 6h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1zm0 8h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1z"
                                        opacity=".3"></path>
                                </g>
                            </svg>
                        </div>

                        <!-- Opacity Range -->
                        <div id="inputContainer"
                            class="absolute top-12 bg-zinc-800 py-2 px-4 rounded-lg shadow-xl hidden z-40">
                            <div id="opacity-range" class="hidden z-40">
                                <label for="opacity" class="text-white text-xs md:text-sm font-medium">Opacity:</label>
                                <input type="range" id="opacity" min="0" max="1" value="1" step="0.05"
                                    class="w-24 h-1.5 bg-zinc-600 rounded-lg cursor-pointer accent-blue-500" />
                            </div>
                            <div id="textPropertiesDropdown" class="flex flex-col gap-1 hidden z-40">
                                <div class="mb-1">
                                    <div class="flex justify-between">
                                        <label for="fontWeightSlider"
                                            class="block text-white text-sm font-medium mb-1">Font Weight</label>
                                        <span id="fontWeightValue"
                                            class="text-white text-xs mt-1 block text-right">400</span>
                                    </div>
                                    <input type="range" id="fontWeightSlider" min="100" max="900" step="100" value="400"
                                        class="w-full h-1.5 bg-zinc-600 rounded-lg cursor-pointer accent-blue-500" />
                                </div>
                                <div class="mb-1">
                                    <div class="flex justify-between">
                                        <label for="lineHeightSlider"
                                            class="block text-white text-sm font-medium mb-1">Line Height:</label>

                                        <span id="lineHeightValue"
                                            class="text-white text-xs mt-1 block text-right">1.2</span>
                                    </div>

                                    <input type="range" id="lineHeightSlider" min="0.5" max="3.0" step="0.1" value="1.2"
                                        class="w-full h-1.5 bg-zinc-600 rounded-lg cursor-pointer accent-blue-500" />
                                </div>
                                <div>
                                    <div class="flex justify-between">
                                        <label for="charSpacingSlider"
                                            class="block text-white text-sm font-medium mb-1">Letter Spacing:</label>
                                        <span id="charSpacingValue"
                                            class="text-white text-xs mt-1 block text-right">0</span>
                                    </div>
                                    <input type="range" id="charSpacingSlider" min="-100" max="500" step="10" value="0"
                                        class="w-full h-1.5 bg-zinc-600 rounded-lg cursor-pointer accent-blue-500" />
                                </div>
                            </div>
                            <div id="textAlignDropdown" class="flex hidden gap-1 z-40">
                                <button id="textAlignLeft"
                                    class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors text-white text-sm block w-full text-left"
                                    data-align="left">
                                    <i class="fas fa-align-left mr-2"></i>Left
                                </button>
                                <button id="textAlignCenter"
                                    class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors text-white text-sm block w-full text-left"
                                    data-align="center">
                                    <i class="fas fa-align-center mr-2"></i>Center
                                </button>
                                <button id="textAlignRight"
                                    class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors text-white text-sm block w-full text-left"
                                    data-align="right">
                                    <i class="fas fa-align-right mr-2"></i>Right
                                </button>
                                <button id="textAlignJustify"
                                    class="py-1 px-2 rounded-md hover:bg-gray-500 transition-colors text-white text-sm block w-full text-left"
                                    data-align="justify">
                                    <i class="fas fa-align-justify mr-2"></i>Justify
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Canvas Area -->
                    <div id="main-content-area" style="width: 100%; height: 100%" class="bg-[#f5f5f5] overflow-auto">
                        <div class="relative canvas-wrapper">
                            <canvas id="canvas-editor"></canvas>
                            <!-- Floating Object Controls -->
                        </div>
                        <div id="floating-object-controls"
                            class="absolute flex bg-zinc-700 text-white rounded-md shadow-lg items-center hidden">
                            <button id="lockUnlockFloatingBtn" class="px-2 py-1 rounded hover:bg-zinc-600"
                                title="Lock/Unlock Object">
                                <i class="fas fa-unlock" id="lockUnlockFloatingIcon"></i>
                            </button>
                            <button id="duplicateFloatingBtn" class="px-2 py-1 rounded hover:bg-zinc-600"
                                title="Duplicate Object">
                                <i class="fas fa-clone"></i>
                            </button>
                            <button id="deleteFloatingBtn" class="px-2 py-1 rounded hover:bg-zinc-600"
                                title="Delete Object">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button id="groupFloatingBtn" class="px-2 py-1 text-xs rounded hover:bg-zinc-600"
                                title="Group Objects">
                                Group
                            </button>
                            <button id="ungroupFloatingBtn" class="px-2 text-xs py-1 rounded hover:bg-zinc-600"
                                title="Ungroup Objects">
                                Ungroup
                            </button>
                        </div>
                    </div>
                    <!-- Canvas Footer (Zoom, Fullscreen) -->
                    <div id="canvas-footer"
                        class="py-0 px-4 shadow-md hidden md:flex items-center justify-end fixed bottom-0 right-0 w-full">
                        <div class="w-[65%] flex items-center justify-between gap-4">
                            <div class="flex items-center gap-2 mr-4">
                                <input type="checkbox" id="savePubliclyCheckbox"
                                    class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                                <label for="savePubliclyCheckbox" class="text-gray-700 text-sm cursor-pointer">Save
                                    Publicly</label>
                            </div>
                            <!-- Pixel Selection Toggle -->
                            <!-- <div class="flex items-center gap-2 mr-4">
                                <input type="checkbox" id="pixelSelectionToggle"
                                    class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" />
                                <label for="pixelSelectionToggle"
                                    class="text-gray-700 text-sm cursor-pointer">Scale</label>
                            </div> -->

                            <div class="flex items-center">
                                <div class="flex items-center gap-4">
                                    <label for="zoomSlider" class="text-gray-700 text-sm">Zoom:</label>
                                    <input type="range" id="zoomSlider" min="0.1" max="1.5" step="0.01" value="1"
                                        class="w-40" />
                                    <span id="zoomValue" class="text-gray-700 text-sm">90%</span>
                                </div>
                                <button id="fullscreenToggle"
                                    class="flex items-center justify-center p-2 rounded-md hover:bg-gray-100 text-gray-700"
                                    title="Toggle Fullscreen">
                                    <i class="material-icons text-xl">fullscreen</i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts/Previews -->
    <div id="customModal" class="fixed inset-0 bg-black/50 items-center justify-center z-50 hidden">
        <div class="bg-white py-6 px-4  rounded-lg shadow-xl max-w-lg w-full m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="customModalLabel" class="text-xl font-semibold text-gray-800">
                    Modal Title
                </h3>
                <button id="closeCustomModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                    &times;
                </button>
            </div>
            <div style="scrollbar-width: thin; scrollbar-color: #9ca3af #374151" id="customModalBody"
                class="text-gray-700 mb-4 overflow-y-auto max-h-[60%]">
                <!-- Modal content goes here -->
            </div>
            <div id="customModalFooter" class="flex justify-end gap-2">
                <!-- Modal footer buttons go here -->
            </div>
        </div>
    </div>

    <!-- Custom Variable Modal -->
    <div id="variableModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50 hidden">
        <div class="bg-white py-6 px-4 rounded-lg shadow-xl max-w-lg w-full m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">
                    Add Custom Variable
                </h3>
                <button id="closeVariableModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                    &times;
                </button>
            </div>
            <div class="text-gray-700 mb-4">
                <div class="mb-4">
                    <label for="variable-name" class="block text-sm font-medium text-gray-700">Variable Name:</label>
                    <input type="text" id="variable-name"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., eventName" />
                </div>
                <div class="mb-4">
                    <label for="variable-type" class="block text-sm font-medium text-gray-700">Variable Type:</label>
                    <select id="variable-type"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="date">Date</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="variable-default" class="block text-sm font-medium text-gray-700">Default Value
                        (Optional):</label>
                    <input type="text" id="variable-default"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Annual Conference" />
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button id="save-variable-btn"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">
                    Save Variable
                </button>
            </div>
        </div>
    </div>
    <div id="public-backgrounds-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/50 items-center justify-center z-50 flex">
        <div class="bg-white py-6 px-3 rounded-lg shadow-xl max-w-lg w-full m-4">
            <div class="modal-header flex justify-between items-center pb-4 mb-4 sticky top-0 z-10">
                <h2 class="text-xl capitalize font-semibold">Select Public Background</h2>
                <button class="modal-close-btn text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body pb-4">
                <div id="publicBackgroundsContainer"
                    class="grid grid-cols-2 gap-4 max-h-[50vh] overflow-auto custom-scrollbar px-3 pb-6">
                </div>
                <div id="publicLoading" class="flex justify-center items-center h-40 hidden">
                    <div class="spinner-border text-blue-500" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                <p id="noPublicBackgroundsFound" class="text-center text-gray-500 hidden">
                    No public backgrounds found.
                </p>
            </div>
        </div>
    </div>

    <!-- Custom Toast Notification -->
    <div id="custom-toast"
        class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 text-xs rounded-md shadow-lg opacity-0 transition-opacity duration-300 z-50">
        <span id="toast-body"></span>
    </div>

    <!-- Global Loading Overlay -->
    <div id="global-loader-overlay" class="fixed inset-0 bg-black/60 items-center justify-center z-[9999] hidden flex">
        <div class="spinner-border text-white" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- Microsoft Clarity Code -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] =
                c[a] ||
                function () {
                    (c[a].q = c[a].q || []).push(arguments);
                };
            t = l.createElement(r);
            t.async = 1;
            t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0];
            y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "s4x38v3eal");
    </script>

    <script>
        // Global variables for canvas dimensions and utility functions
        let canvas = null;
        let originalCanvasWidth;
        let originalCanvasHeight;
        let currentZoomLevel = null;
        let currentCropRect = null;
        let croppedImage = null;
        let originalClipPath = null;
        let allFetchedBrands = [];
        let canvasStates = [];
        let currentStateIndex = -1;

        let currentEditingGroup = null;
        let copiedObjects = [];
        let croppingRect = null;
        let selectedImage = null;
        let isCropModeActive = false;

        let isDraggingUploadedImage = false;
        let isGroupingUngrouping = false;



        function handleSidebarPaste(event) {
            event.stopPropagation();

            event.preventDefault();

            // Get the text from the clipboard
            const clipboardData = event.clipboardData || window.clipboardData;
            const pastedText = clipboardData.getData("text");

            // Get the target input element
            const targetInput = event.target;

            // Insert the pasted text at the current cursor position
            const start = targetInput.selectionStart;
            const end = targetInput.selectionEnd;
            const value = targetInput.value;

            targetInput.value =
                value.substring(0, start) + pastedText + value.substring(end);

            // Move the cursor to the end of the pasted text
            targetInput.selectionStart = targetInput.selectionEnd =
                start + pastedText.length;

            // Manually trigger an input event to ensure any bound listeners (like for color pickers) react
            const inputEvent = new Event("input", { bubbles: true });
            targetInput.dispatchEvent(inputEvent);
        }

        //  Shows a custom toast notification.

        function showToast(message, duration = 3000) {
            const toast = $("#custom-toast");
            $("#toast-body").text(message);
            toast.removeClass("opacity-0 hidden").addClass("opacity-100");
            setTimeout(() => {
                toast.removeClass("opacity-100").addClass("opacity-0 hidden");
            }, duration);
        }

        // This is essential to ensure only one is visible at a time.
        function hideAllInputPanels() {
            $("#opacity-range").addClass("hidden");
            $("#textAlignDropdown").addClass("hidden");
            $("#textPropertiesDropdown").addClass("hidden");
        }

        // Toggle visibility for the main opacity button
        $("#toogleButton").on("click", function (event) {
            event.stopPropagation();

            // Check if inputContainer is currently visible AND showing the opacity panel
            if (
                !$("#inputContainer").hasClass("hidden") &&
                !$("#opacity-range").hasClass("hidden")
            ) {
                // If true, it means we clicked the same button to close it
                $("#inputContainer").addClass("hidden");
                hideAllInputPanels(); // Hide all inner panels when closing main container
            } else {
                // Otherwise, show inputContainer and the opacity panel
                $("#inputContainer").removeClass("hidden"); // Show the main dropdown container
                hideAllInputPanels();
                $("#opacity-range").removeClass("hidden"); // Then, show ONLY the opacity panel
            }
        });

        // Toggle visibility for the Text Alignment button
        $("#textAlignToggle").on("click", function (event) {
            event.stopPropagation(); // Prevents document click from immediately closing

            if (
                !$("#inputContainer").hasClass("hidden") &&
                !$("#textAlignDropdown").hasClass("hidden")
            ) {
                // If true, it means we clicked the same button to close it
                $("#inputContainer").addClass("hidden");
                hideAllInputPanels(); // Hide all inner panels when closing main container
            } else {
                // Otherwise, show inputContainer and the text alignment panel
                $("#inputContainer").removeClass("hidden"); // Show the main dropdown container
                hideAllInputPanels();
                $("#textAlignDropdown").removeClass("hidden"); // Then, show ONLY the text alignment panel
            }
        });

        // Toggle visibility for the Text Properties button
        $("#textPropertiesToggle").on("click", function (event) {
            event.stopPropagation(); // Prevents document click from immediately closing

            // Check if inputContainer is currently visible AND showing the text properties panel
            if (
                !$("#inputContainer").hasClass("hidden") &&
                !$("#textPropertiesDropdown").hasClass("hidden")
            ) {
                // If true, it means we clicked the same button to close it
                $("#inputContainer").addClass("hidden");
                hideAllInputPanels(); // Hide all inner panels when closing main container
            } else {
                // Otherwise, show inputContainer and the text properties panel
                $("#inputContainer").removeClass("hidden"); // Show the main dropdown container
                hideAllInputPanels(); // IMPORTANT: Hide any previously visible panel first
                $("#textPropertiesDropdown").removeClass("hidden"); // Then, show ONLY the text properties panel
            }
        });

        // Close inputContainer when clicking anywhere else on the document
        $(document).on("click", function (event) {
            // Check if the click target is not within inputContainer, nor any of the toggle buttons
            if (
                !$(event.target).closest(
                    "#inputContainer, #toogleButton, #textAlignToggle, #textPropertiesToggle"
                ).length
            ) {
                $("#inputContainer").addClass("hidden"); // Hide the main container
                hideAllInputPanels(); // Ensure all inner panels are hidden when the main container closes
            }
        });

        // Prevent clicks inside the inputContainer itself from propagating to the document and closing it
        $("#inputContainer").on("click", function (event) {
            event.stopPropagation();
        });

        $("#inputContainer").addClass("hidden");
        hideAllInputPanels(); // Ensures all inner children are hidden too

        /**
         * Shows the global loading overlay.
         */
        function showGlobalLoader() {
            $("#global-loader-overlay").removeClass("hidden");
        }

        /**
         * Hides the global loading overlay.
         */
        function hideGlobalLoader() {
            $("#global-loader-overlay").addClass("hidden");
        }

        // Shows a custom modal with dynamic content
        function showCustomModal(title, bodyHtml, footerHtml = "") {
            $("#customModalLabel").text(title);
            $("#customModalBody").html(bodyHtml);
            $("#customModalFooter").html(footerHtml);
            $("#customModal").removeClass("hidden").addClass("flex");
        }

        // Updates the main object toolbar based on the active object
        function updateObjectToolbar(object) {
            // Hide all specific toolbars first
            $("#text-formatting").addClass("hidden");
            $("#element-colors").addClass("hidden");
            $("#image-controls").addClass("hidden");
            $("#crop-actions").addClass("hidden");
            $("#general-element-actions").addClass("hidden");
            $("#groupFloatingBtn").addClass("hidden");
            $("#ungroupFloatingBtn").addClass("hidden");
            // Always show global controls (background color)
            $("#global-controls").removeClass("hidden");

            if (!object) {
                $("#object-toolbar").addClass("center-global");
                return;
            }

            // Show general actions (opacity, lock/unlock) if an object is selected
            $("#general-element-actions").removeClass("hidden");
            $("#opacity").val(object.opacity);
            $("#object-toolbar").removeClass("center-global");

            // Determine which specific toolbar to show based on the *actual active object*

            let targetForSpecificToolbar = object;

            if (object.type === "activeSelection") {
                $("#groupFloatingBtn").removeClass("hidden");
                $("#ungroupFloatingBtn").addClass("hidden");
                targetForSpecificToolbar = null; // No specific toolbar for multiple selection
            } else if (object.type === "group") {
                $("#groupFloatingBtn").addClass("hidden");
                $("#ungroupFloatingBtn").removeClass("hidden");

                targetForSpecificToolbar = null;
            }

            // Now, apply specific toolbars based on targetForSpecificToolbar
            if (targetForSpecificToolbar) {
                if (
                    targetForSpecificToolbar.type === "i-text" ||
                    targetForSpecificToolbar.type === "text" ||
                    targetForSpecificToolbar.type === "textbox"
                ) {
                    $("#text-formatting").removeClass("hidden");

                    $("#fontFamily").val(targetForSpecificToolbar.fontFamily);
                    $("#fontSizeInput").val(targetForSpecificToolbar.fontSize);
                    $("#fontColorPicker").spectrum(
                        "set",
                        targetForSpecificToolbar.fill
                    );
                    $("#boldBtn").toggleClass(
                        "active",
                        targetForSpecificToolbar.fontWeight === "bold"
                    );
                    $("#italicBtn").toggleClass(
                        "active",
                        targetForSpecificToolbar.fontStyle === "italic"
                    );
                    $("#underlineBtn").toggleClass(
                        "active",
                        targetForSpecificToolbar.underline
                    );
                    $("#strikethroughBtn").toggleClass(
                        "active",
                        targetForSpecificToolbar.linethrough
                    );
                    // Update text alignment icons
                    $("#textAlignToggle i").removeClass().addClass("fas");
                    if (targetForSpecificToolbar.textAlign === "left")
                        $("#textAlignToggle i").addClass("fa-align-left");
                    else if (targetForSpecificToolbar.textAlign === "center")
                        $("#textAlignToggle i").addClass("fa-align-center");
                    else if (targetForSpecificToolbar.textAlign === "right")
                        $("#textAlignToggle i").addClass("fa-align-right");
                    else if (targetForSpecificToolbar.textAlign === "justify")
                        $("#textAlignToggle i").addClass("fa-align-justify");
                } else if (
                    [
                        "rect",
                        "circle",
                        "triangle",
                        "ellipse",
                        "line",
                        "polygon",
                    ].includes(targetForSpecificToolbar.type)
                ) {
                    $("#element-colors").removeClass("hidden");
                    $("#elementFillPicker").spectrum(
                        "set",
                        targetForSpecificToolbar.fill || "#cccccc"
                    );
                    $("#borderColorPicker").spectrum(
                        "set",
                        targetForSpecificToolbar.stroke || "#000000"
                    );
                    $("#borderThickness").val(
                        targetForSpecificToolbar.strokeWidth || 0
                    );
                    if (
                        targetForSpecificToolbar.type === "rect" ||
                        targetForSpecificToolbar.type === "ellipse"
                    ) {
                        $("#elementBorderRadius").val(targetForSpecificToolbar.rx || 0);
                    } else {
                        $("#elementBorderRadius").val(0);
                    }
                    $("#borderType").val(
                        targetForSpecificToolbar.strokeDashArray &&
                            targetForSpecificToolbar.strokeDashArray.length > 0
                            ? "dashed"
                            : "solid"
                    );
                } else if (targetForSpecificToolbar.type === "image") {
                    $("#image-controls").removeClass("hidden");
                    $("#imageBorderColor").spectrum(
                        "set",
                        targetForSpecificToolbar.stroke || "#000000"
                    );
                    $("#imageBorderThickness").val(
                        targetForSpecificToolbar.strokeWidth || 0
                    );
                    const currentRadius =
                        targetForSpecificToolbar.clipPath &&
                            targetForSpecificToolbar.clipPath.type === "rect"
                            ? targetForSpecificToolbar.clipPath.rx
                            : 0;
                    $("#imageBorderRadius").val(currentRadius);
                    $("#flipXBtn").toggleClass(
                        "active",
                        targetForSpecificToolbar.flipX
                    );
                    $("#flipYBtn").toggleClass(
                        "active",
                        targetForSpecificToolbar.flipY
                    );

                    // Show crop actions if an image is selected AND we are in cropping mode
                    if (currentCropRect && croppedImage === targetForSpecificToolbar) {
                        $("#crop-actions").removeClass("hidden");
                        $("#image-controls").addClass("hidden");
                    }
                }
            }

            // Logic for crop button visibility (independent of targetForSpecificToolbar for specific controls)
            if (
                !object ||
                object.isIcon ||
                !["image", "activeSelection", "group"].includes(object.type)
            ) {
                // If no object, is an icon, or not a supported type for cropping, hide crop button
                $("#cropImageBtn").addClass("hidden");
            } else if (object.type === "image") {
                $("#cropImageBtn").removeClass("hidden"); // Show for single images
            } else if (
                object.type === "activeSelection" ||
                object.type === "group"
            ) {
                // Check if the selection/group contains at least one image
                const containsImage = object
                    .getObjects()
                    .some((obj) => obj.type === "image");
                if (containsImage) {
                    $("#cropImageBtn").removeClass("hidden");
                } else {
                    $("#cropImageBtn").addClass("hidden");
                }
            }

            // Ensure crop actions are hidden if not in crop mode
            if (!isCropModeActive) {
                $("#crop-actions").addClass("hidden");
            }
        }

        // Font Weight Slider
        $("#fontWeightSlider").on("input", function () {
            const activeObject = canvas.getActiveObject();
            if (
                activeObject &&
                (activeObject.type === "i-text" ||
                    activeObject.type === "text" ||
                    activeObject.type === "textbox")
            ) {
                const fontWeight = $(this).val();
                activeObject.set("fontWeight", fontWeight);
                $("#fontWeightValue").text(fontWeight);
                canvas.renderAll();
            }
        });

        // Line Height Slider
        $("#lineHeightSlider").on("input", function () {
            const activeObject = canvas.getActiveObject();
            if (
                activeObject &&
                (activeObject.type === "i-text" ||
                    activeObject.type === "text" ||
                    activeObject.type === "textbox")
            ) {
                const lineHeight = parseFloat($(this).val());
                activeObject.set("lineHeight", lineHeight);
                $("#lineHeightValue").text(lineHeight.toFixed(1));
                canvas.renderAll();
            }
        });

        // Letter Spacing Slider
        $("#charSpacingSlider").on("input", function () {
            const activeObject = canvas.getActiveObject();
            if (
                activeObject &&
                (activeObject.type === "i-text" ||
                    activeObject.type === "text" ||
                    activeObject.type === "textbox")
            ) {
                const charSpacing = parseInt($(this).val());
                activeObject.set("charSpacing", charSpacing);
                $("#charSpacingValue").text(charSpacing);
                canvas.renderAll();
            }
        });

        // Close dropdowns when clicking anywhere else on the document
        $(document).on("click", function (event) {
            // Check if the click was outside the alignment toggle/dropdown
            if (
                !$(event.target).closest("#textAlignToggle").length &&
                !$(event.target).closest("#textAlignDropdown").length
            ) {
                $("#textAlignDropdown").addClass("hidden");
            }
            // Check if the click was outside the properties toggle/dropdown
            if (
                !$(event.target).closest("#textPropertiesToggle").length &&
                !$(event.target).closest("#textPropertiesDropdown").length
            ) {
                $("#textPropertiesDropdown").addClass("hidden");
            }
        });

        // Grouping functionality
        $("#groupFloatingBtn").on("click", function () {
            const activeObject = canvas.getActiveObject();

            if (activeObject && activeObject.type === "activeSelection") {
                isGroupingUngrouping = true; // Set flag to prevent toolbar from clearing prematurely

                // Temporarily disable toolbar and floating controls to prevent flicker during transition
                $("#object-toolbar")
                    .css("pointer-events", "none")
                    .css("opacity", "0.5");
                $("#floating-object-controls").addClass("hidden");

                // Fabric.js provides a convenient way to group objects directly from an activeSelection
                // The toGroup() method handles all the complex coordinate transformations.
                const group = activeObject.toGroup();
                canvas.setActiveObject(group);

                canvas.requestRenderAll();
                saveCanvasState();
                showToast("Objects grouped!");

                isGroupingUngrouping = false;


                $("#object-toolbar")
                    .css("pointer-events", "auto")
                    .css("opacity", "1");

                setTimeout(() => {
                    updateFloatingControls(canvas.getActiveObject());
                }, 0);
            } else {
                showToast("Select multiple objects to group.", 2000);
            }
        });

        $("#ungroupFloatingBtn").on("click", function () {
            const activeObject = canvas.getActiveObject();
            if (!activeObject || activeObject.type !== "group") {
                showToast("Select a group to ungroup.", 2000);
                return;
            }
            // Set processing flag
            isGroupingUngrouping = true;
            // Disable UI during operation
            $("#object-toolbar")
                .css("pointer-events", "none")
                .css("opacity", "0.5");
            $("#floating-object-controls").addClass("hidden");

            // Ungroup the objects. toActiveSelection() destroys the group and adds the items back to the canvas.
            activeObject.toActiveSelection();

            // Deselect the newly created active selection.
            canvas.discardActiveObject();

            // Use a timeout to ensure the UI updates correctly after the operation.
            setTimeout(() => {
                canvas.requestRenderAll();
                // Restore UI
                $("#object-toolbar")
                    .css("pointer-events", "auto")
                    .css("opacity", "1");
                updateFloatingControls(null); // Clear floating controls
                // Save state and notify
                saveCanvasState();
                showToast("Objects ungrouped!");
                // Reset processing flag
                isGroupingUngrouping = false;
            }, 50);
        });

        function updateObjectControls() {
            const zoomLevel = currentZoomLevel || 1;
            const minControlSize = 12; // Increased from 8
            const maxControlSize = 24; // Decreased from 60
            const baseControlSize = 16;

            let newControlSize = baseControlSize / zoomLevel;
            newControlSize = Math.max(minControlSize, Math.min(maxControlSize, newControlSize));

            const controlProps = {
                cornerSize: newControlSize,
                cornerStyle: 'circle',
                cornerColor: 'rgba(0,0,255,0.5)',
                cornerStrokeColor: '#0000FF',
                transparentCorners: false,
                borderColor: '#0000FF',
                borderScaleFactor: 2,
                padding: 5,
            };

            fabric.Object.prototype.set(controlProps);
            fabric.Textbox.prototype.set(controlProps);
            fabric.IText.prototype.set(controlProps);

            fabric.Object.prototype.controls.mtr.offsetY = -30 / zoomLevel;

            canvas.renderAll();
        }

        function applyCanvasTransformations() {
            const mainContentArea = document.getElementById("main-content-area");
            if (!mainContentArea) return;

            const containerWidth = mainContentArea.clientWidth;
            const containerHeight = mainContentArea.clientHeight;

            const horizontalPadding = 30;
            const topPadding = 10;
            const bottomPadding = 10;

            // Calculate effective container dimensions for scaling
            const effectiveContainerWidth = containerWidth - horizontalPadding;
            const effectiveContainerHeight =
                containerHeight - (topPadding + bottomPadding);

            // Calculate scale factors to fit the canvas within the container
            const scaleX = effectiveContainerWidth / originalCanvasWidth;
            const scaleY = effectiveContainerHeight / originalCanvasHeight;

            let fitZoom = Math.min(scaleX, scaleY);
            const zoomOutFactor = 0.83;
            fitZoom *= zoomOutFactor;


            if (
                currentZoomLevel === null ||
                currentZoomLevel === 1.0 ||
                currentZoomLevel === 0.35
            ) {
                currentZoomLevel = fitZoom;
            }

            // Ensure the currentZoomLevel is within the allowed slider range
            const zoomSliderMin = parseFloat($("#zoomSlider").attr("min"));
            const zoomSliderMax = parseFloat($("#zoomSlider").attr("max"));
            currentZoomLevel = Math.max(
                zoomSliderMin,
                Math.min(zoomSliderMax, currentZoomLevel)
            );

            // Calculate the final scaled dimensions of the canvas based on the determined zoom level.
            const scaledCanvasWidth = originalCanvasWidth * currentZoomLevel;
            const scaledCanvasHeight = originalCanvasHeight * currentZoomLevel;

            // Set Fabric.js internal canvas dimensions to original (important for internal calculations).
            canvas.setDimensions(
                {
                    width: originalCanvasWidth,
                    height: originalCanvasHeight,
                },
                { cssOnly: false }
            ); // cssOnly: false means Fabric.js updates internal canvas dimensions

            const canvasWrapper = document.querySelector(".canvas-wrapper");
            if (canvasWrapper) {
                // Calculate horizontal translation to center the scaled canvas.
                const translateX = (containerWidth - scaledCanvasWidth) / 2;
                const translateY = (containerHeight - scaledCanvasHeight) / 5;

                canvasWrapper.style.transform = `scale(${currentZoomLevel})`;
                canvasWrapper.style.left = `${translateX}px`;
                canvasWrapper.style.top = `${translateY}px`;
                canvasWrapper.style.transformOrigin = `0 0`;
            }

            // Update the zoom slider and its display.
            $("#zoomSlider").val(currentZoomLevel);
            $("#zoomValue").text(Math.round(currentZoomLevel * 100) + "%");


            const minControlSize = 8;
            const maxControlSize = 60;
            const baseControlSize = 16;
            const basePadding = 20;

            const baseCornerStrokeWidth = 2;

            let newControlSize = baseControlSize / currentZoomLevel;
            newControlSize = Math.max(
                minControlSize,
                Math.min(maxControlSize, newControlSize)
            );

            // The properties to be applied to both object types
            const sharedProperties = {
                cornerSize: newControlSize,
                borderScaleFactor: 1 / currentZoomLevel,
                padding: 5,

            };

            // Apply to the general Object prototype
            fabric.Object.prototype.set(sharedProperties);


            fabric.Textbox.prototype.set(sharedProperties);
            fabric.IText.prototype.set(sharedProperties);

            fabric.Object.prototype.controls.mtr.offsetY = -30 / currentZoomLevel;
            updateObjectControls();
            canvas.renderAll();
        }
        // In your resizeCanvas function:
        function resizeCanvas() {
            applyCanvasTransformations();
        }

        // Updates the position of the floating object controls.
        function updateFloatingControls(object) {
            const floatingControls = $("#floating-object-controls");
            const canvasWrapper = $(".canvas-wrapper");
            const mainContentArea = $("#main-content-area");

            if (isCropModeActive) {
                floatingControls.removeClass("show").addClass("hidden");
                return;
            }

            if (object) {
                const objectBoundingRect = object.getBoundingRect(true);
                const transformMatrix = new WebKitCSSMatrix(
                    window.getComputedStyle(canvasWrapper[0]).transform
                );
                const currentCanvasDisplayScale = transformMatrix.a;

                const objectRenderedLeftRelativeToWrapper =
                    objectBoundingRect.left * currentCanvasDisplayScale;
                const objectRenderedTopRelativeToWrapper =
                    objectBoundingRect.top * currentCanvasDisplayScale;
                const objectRenderedWidth =
                    objectBoundingRect.width * currentCanvasDisplayScale;
                const objectRenderedHeight =
                    objectBoundingRect.height * currentCanvasDisplayScale;

                const canvasWrapperOffset = canvasWrapper.position();

                const objectRenderedLeftRelativeToMain =
                    canvasWrapperOffset.left + objectRenderedLeftRelativeToWrapper;
                const objectRenderedTopRelativeToMain =
                    canvasWrapperOffset.top + objectRenderedTopRelativeToWrapper;

                const baseToolbarFontSize = 13;
                const minToolbarFontSize = 9;
                const maxToolbarFontSize = 17;

                let newToolbarFontSize =
                    baseToolbarFontSize / currentCanvasDisplayScale;
                newToolbarFontSize = Math.max(
                    minToolbarFontSize,
                    Math.min(maxToolbarFontSize, newToolbarFontSize)
                );

                floatingControls.css({
                    "font-size": `${newToolbarFontSize}px`,
                    padding: `${newToolbarFontSize / 8}px ${newToolbarFontSize / 4}px`,
                });

                const toolbarHeight = floatingControls.outerHeight();
                const toolbarWidth = floatingControls.outerWidth();

                // New horizontal offset to shift the toolbar to the right
                const horizontalOffset = 80;
                let controlsLeft =
                    objectRenderedLeftRelativeToMain +
                    objectRenderedWidth / 2 -
                    toolbarWidth / 2 +
                    horizontalOffset;

                const verticalOffset = 10;
                let controlsTop =
                    objectRenderedTopRelativeToMain - toolbarHeight - verticalOffset;

                const mainContentWidth = mainContentArea.width();
                const mainContentHeight = mainContentArea.height();

                controlsLeft = Math.max(0, controlsLeft);
                controlsLeft = Math.min(
                    mainContentWidth - toolbarWidth,
                    controlsLeft
                );

                if (controlsTop < 0) {
                    controlsTop =
                        objectRenderedTopRelativeToMain +
                        objectRenderedHeight +
                        verticalOffset;
                }
                controlsTop = Math.max(0, controlsTop);
                controlsTop = Math.min(
                    mainContentHeight - toolbarHeight,
                    controlsTop
                );

                floatingControls
                    .css({
                        left: controlsLeft + "px",
                        top: controlsTop + "px",
                    })
                    .removeClass("hidden")
                    .addClass("show");

                // Group/Ungroup buttons visibility
                if (object.type === "activeSelection") {
                    $("#groupFloatingBtn").removeClass("hidden");
                    $("#ungroupFloatingBtn").addClass("hidden");
                } else if (object.type === "group") {
                    $("#groupFloatingBtn").addClass("hidden");
                    $("#ungroupFloatingBtn").removeClass("hidden");
                } else {
                    // Single object (not group or activeSelection)
                    $("#groupFloatingBtn").addClass("hidden");
                    $("#ungroupFloatingBtn").addClass("hidden");
                }

                const lockUnlockIcon = $("#lockUnlockFloatingIcon");
                if (
                    object.lockMovementX ||
                    object.lockMovementY ||
                    object.lockScalingX ||
                    object.lockScalingY ||
                    object.lockRotation
                ) {
                    lockUnlockIcon.removeClass("fa-unlock").addClass("fa-lock");
                } else {
                    lockUnlockIcon.removeClass("fa-lock").addClass("fa-unlock");
                }
            } else {
                floatingControls.removeClass("show").addClass("hidden");
            }
        }

        // Saves the current state of the canvas to the history.

        function saveCanvasState() {
            if (currentStateIndex < canvasStates.length - 1) {
                canvasStates = canvasStates.slice(0, currentStateIndex + 1);
            }
            canvasStates.push(JSON.stringify(canvas.toJSON()));
            currentStateIndex = canvasStates.length - 1;
        }

        //  Undoes the last canvas action.
        function undo() {
            if (currentStateIndex > 0) {
                // Temporarily remove event listeners to prevent saveCanvasState during loadFromJSON
                canvas.off("object:added", saveCanvasState);
                canvas.off("object:modified", saveCanvasState);
                canvas.off("object:removed", saveCanvasState);

                currentStateIndex--;
                canvas.loadFromJSON(canvasStates[currentStateIndex], function () {
                    canvas.renderAll();
                    // After rendering, ensure object selections are updated
                    const activeObj = canvas.getActiveObject();
                    updateObjectToolbar(activeObj);
                    updateFloatingControls(activeObj);

                    // Re-add event listeners after the state has been restored
                    canvas.on("object:added", saveCanvasState);
                    canvas.on("object:modified", saveCanvasState);
                    canvas.on("object:removed", saveCanvasState);

                    showToast("Undo successful!");
                });
            } else {
                showToast("Nothing to undo!", 2000);
            }
        }

        //  Redoes the last undone canvas action.

        function redo() {
            if (currentStateIndex < canvasStates.length - 1) {
                // Temporarily remove event listeners to prevent saveCanvasState during loadFromJSON
                canvas.off("object:added", saveCanvasState);
                canvas.off("object:modified", saveCanvasState);
                canvas.off("object:removed", saveCanvasState);

                currentStateIndex++;
                canvas.loadFromJSON(canvasStates[currentStateIndex], function () {
                    canvas.renderAll();

                    const activeObj = canvas.getActiveObject();
                    updateObjectToolbar(activeObj);
                    updateFloatingControls(activeObj);

                    canvas.on("object:added", saveCanvasState);
                    canvas.on("object:modified", saveCanvasState);
                    canvas.on("object:removed", saveCanvasState);

                    showToast("Redo successful!");
                });
            } else {
                showToast("Nothing to redo!", 2000);
            }
        }

        $(document).ready(function () {
            // Add event listeners to all relevant input fields in the sidebar

            document.addEventListener("DOMContentLoaded", () => {
                const sidebarInputs = [
                    document.getElementById("certificate-purpose-input"),
                    document.getElementById("event-name-input"),
                    document.getElementById("professional-prompt-input"),
                    document.getElementById("primary-color-picker"),
                    document.getElementById("secondary-color-picker"),
                    document.getElementById("manual-prompt-input"),
                    document.getElementById("manual-primary-color-picker"),
                    document.getElementById("manual-secondary-color-picker"),
                    // Add any other input IDs here that you want to specifically handle paste for
                ];

                sidebarInputs.forEach((input) => {
                    if (input) {
                        // Ensure the element exists before adding the listener
                        input.addEventListener("paste", handleSidebarPaste);
                    }
                });
            });
            // Extracts query parameters from the URL.

            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                const width = parseInt(params.get("width"));
                const height = parseInt(params.get("height"));
                const name = params.get("name");
                return { width, height, name };
            }

            // Get canvas dimensions and design name from the URL
            const urlParams = getQueryParams();

            // Determine initial canvas dimensions based on screen width or URL parameters
            let initialCanvasWidth =
                urlParams.width || (window.innerWidth <= 500 ? 305 : 800);
            let initialCanvasHeight =
                urlParams.height || (window.innerWidth <= 500 ? 400 : 600);
            originalCanvasWidth = initialCanvasWidth;
            originalCanvasHeight = initialCanvasHeight;

            // Initialize Fabric.js canvas
            canvas = new fabric.Canvas("canvas-editor", {
                width: originalCanvasWidth,
                height: originalCanvasHeight,
                backgroundColor: "#ffffff",
                selection: true,
                renderOnAddRemove: true,
                snapAngle: 45,
                snapThreshold: 5,
                willReadFrequently: true,
                preserveObjectStacking: true,
                controlsAboveOverlay: true,
            });
            canvas.selectionColor = 'rgba(29, 137, 255, 0.3)';
            canvas.selectionBorderColor = '#118ee8';
            canvas.selectionLineWidth = 2;
            canvas.selectionDashArray = [5, 5];

            fabric.Object.prototype.set({
                borderColor: '#118ee8',
                cornerColor: '#ffffff',
                cornerStrokeColor: '#118ee8', // You might want to match this with your borderColor
                cornerSize: 10,
                transparentCorners: false,
                cornerStyle: 'circle',
                borderScaleFactor: 2,
                padding: 5,

            });

            // For text objects specifically, you can override these if needed
            fabric.Textbox.prototype.set({
                borderColor: '#1d89ff',
                cornerColor: '#ffffff',
                cornerStrokeColor: '#1d89ff',
                cornerSize: 6,
                transparentCorners: false,
            });

            // Alignment guides setup
            let guides = []; // Store guide lines and labels
            const alignmentThreshold = 5; // Pixels within which to trigger alignment

            // Function to create a guide line
            function createGuideLine(start, end, isHorizontal = true) {
                // Calculate dynamic stroke width based on canvas size
                const baseStroke = 1;
                const minStroke = 1;
                const maxStroke = 4;
                const scale = Math.max(canvas.width, canvas.height) / 1000;
                const dynamicStroke = Math.max(minStroke, Math.min(maxStroke, baseStroke * scale));

                // Dynamic dash length
                const baseDash = 3;
                const dynamicDash = Math.round(baseDash * scale);

                const line = new fabric.Line(start.concat(end), {
                    stroke: '#1d89ff',
                    strokeWidth: dynamicStroke,
                    selectable: false,
                    evented: false,
                    strokeDashArray: [dynamicDash, dynamicDash],
                });
                canvas.add(line);
                guides.push(line);
                return line;
            }

            // Function to create a distance label
            function createDistanceLabel(position, text) {
                // Dynamic font size
                const baseFont = 12;
                const minFont = 10;
                const maxFont = 40;
                const scale = Math.max(canvas.width, canvas.height) / 1000;
                const dynamicFont = Math.max(minFont, Math.min(maxFont, baseFont * scale));

                const label = new fabric.Text(text, {
                    left: position[0],
                    top: position[1],
                    fontSize: dynamicFont,
                    fill: '#1d89ff',
                    selectable: false,
                    evented: false,
                    fontFamily: 'Roboto',
                });
                canvas.add(label);
                guides.push(label);
                return label;
            }

            // Function to clear all guides
            function clearGuides() {
                guides.forEach(guide => canvas.remove(guide));
                guides = [];
            }

            // Function to check alignment and show guides
            function showAlignmentGuides(activeObject) {
                clearGuides();

                if (!activeObject) return;

                const canvasCenterX = canvas.width / 2;
                const canvasCenterY = canvas.height / 2;
                const objBounds = activeObject.getBoundingRect();
                const objCenterX = objBounds.left + objBounds.width / 2;
                const objCenterY = objBounds.top + objBounds.height / 2;

                // Show canvas center lines
                if (Math.abs(objCenterX - canvasCenterX) < alignmentThreshold) {
                    createGuideLine([canvasCenterX, 0, canvasCenterX, canvas.height], false);
                }
                if (Math.abs(objCenterY - canvasCenterY) < alignmentThreshold) {
                    createGuideLine([0, canvasCenterY, canvas.width, canvasCenterY], true);
                }

                // Check distances to other objects
                canvas.getObjects().forEach(obj => {
                    if (obj === activeObject || obj.type === 'line' || obj.type === 'text') return;

                    const otherBounds = obj.getBoundingRect();
                    const otherCenterX = otherBounds.left + otherBounds.width / 2;
                    const otherCenterY = otherBounds.top + otherBounds.height / 2;

                    // Horizontal alignment (left, center, right)
                    const alignments = [
                        { type: 'left', value: objBounds.left, other: otherBounds.left },
                        { type: 'centerX', value: objCenterX, other: otherCenterX },
                        { type: 'right', value: objBounds.left + objBounds.width, other: otherBounds.left + otherBounds.width },
                    ];

                    alignments.forEach(align => {
                        if (Math.abs(align.value - align.other) < alignmentThreshold) {
                            const x = (align.value + align.other) / 2;
                            createGuideLine([x, 0, x, canvas.height], false);
                        }
                    });

                    // Vertical alignment (top, center, bottom)
                    const verticalAlignments = [
                        { type: 'top', value: objBounds.top, other: otherBounds.top },
                        { type: 'centerY', value: objCenterY, other: otherCenterY },
                        { type: 'bottom', value: objBounds.top + objBounds.height, other: otherBounds.top + otherBounds.height },
                    ];

                    verticalAlignments.forEach(align => {
                        if (Math.abs(align.value - align.other) < alignmentThreshold) {
                            const y = (align.value + align.other) / 2;
                            createGuideLine([0, y, canvas.width, y], true);
                        }
                    });

                    // Spacing guides (horizontal and vertical distances)
                    const horizontalSpacing = Math.abs(objBounds.left - (otherBounds.left + otherBounds.width));
                    const verticalSpacing = Math.abs(objBounds.top - (otherBounds.top + otherBounds.height));

                    if (horizontalSpacing < 50 && horizontalSpacing > 0) {
                        const x1 = Math.min(objBounds.left, otherBounds.left + otherBounds.width);
                        const x2 = Math.max(objBounds.left, otherBounds.left + otherBounds.width);
                        const y = Math.min(objBounds.top, otherBounds.top) - 20;
                        createGuideLine([x1, y, x2, y], true);
                        createDistanceLabel([(x1 + x2) / 2, y - 10], `${Math.round(horizontalSpacing)}px`);
                    }

                    if (verticalSpacing < 50 && verticalSpacing > 0) {
                        const y1 = Math.min(objBounds.top, otherBounds.top + otherBounds.height);
                        const y2 = Math.max(objBounds.top, otherBounds.top + otherBounds.height);
                        const x = Math.min(objBounds.left, otherBounds.left) - 20;
                        createGuideLine([x, y1, x, y2], false);
                        createDistanceLabel([x - 10, (y1 + y2) / 2], `${Math.round(verticalSpacing)}px`);
                    }
                });

                canvas.renderAll();
            }

            if (canvas && canvas.wrapperEl) {
                canvas.wrapperEl.setAttribute("tabindex", "0"); // Make it focusable
                $(canvas.wrapperEl)
                    .on("focus", function () {
                        $(this).addClass("canvas-focused");
                    })
                    .on("blur", function () {
                        $(this).removeClass("canvas-focused");
                    });
            }
            loadDesignIfExists();

            $(canvas.wrapperEl).on("keydown", function (e) {
                const activeObjects = canvas.getActiveObjects();
                const activeObject = canvas.getActiveObject();
                let step = 5;

                // Prevent default for arrow keys to stop page scrolling
                if (
                    ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)
                ) {
                    e.preventDefault();
                }

                if (e.metaKey || e.ctrlKey) {
                    switch (e.key.toLowerCase()) {
                        case "p": // Cmd/Ctrl + P: Print Canvas

                            e.preventDefault(); // Crucial: Prevent the browser's default print dialog

                            // Ensure printCanvas function is defined in the correct scope and accessible
                            if (typeof printCanvas === "function") {
                                printCanvas(
                                    canvas,
                                    originalCanvasWidth,
                                    originalCanvasHeight,
                                    applyCanvasTransformations
                                );

                            } else {
                                console.error(
                                    "Error: printCanvas function is not defined or accessible."
                                );
                            }
                            break;
                        case "a":
                            e.preventDefault();
                            if (canvas.getObjects().length > 0) {
                                const allObjects = canvas.getObjects();
                                const selectAll = new fabric.ActiveSelection(allObjects, {
                                    canvas: canvas,
                                });
                                canvas.setActiveObject(selectAll);
                                canvas.renderAll();
                                showToast("All objects selected!");
                            } else {
                                showToast("No objects to select!", 2000);
                            }
                            break;

                        case "c": // Cmd/Ctrl + C: Copy Selected Objects
                            e.preventDefault();
                            if (activeObjects.length > 0) {
                                copiedObjects = []; // Clear previous copied objects
                                // Clone each active object
                                activeObjects.forEach((obj) => {
                                    obj.clone(function (clonedObj) {
                                        copiedObjects.push(clonedObj);
                                    });
                                });
                                showToast(`Copied ${activeObjects.length} object(s)!`);
                            } else {
                                showToast("No object selected to copy.", 2000);
                            }
                            break;

                        case "v": // Cmd/Ctrl + V: Paste Copied Objects
                            e.preventDefault();
                            // If a text object is active and in editing mode, let the browser handle text paste
                            if (
                                activeObject &&
                                (activeObject.type === "i-text" ||
                                    activeObject.type === "text" ||
                                    activeObject.type === "textbox") &&
                                activeObject.isEditing
                            ) {
                                // Let the browser handle the paste event for the text content
                                return;
                            }

                            if (copiedObjects.length > 0) {
                                canvas.discardActiveObject(); // Deselect current objects before pasting
                                const newSelection = [];
                                copiedObjects.forEach((obj) => {
                                    obj.clone(function (cloned) {
                                        cloned.set({
                                            left: cloned.left + 10,
                                            top: cloned.top + 10,
                                            evented: true,
                                            selectable: true,
                                        });
                                        canvas.add(cloned);
                                        newSelection.push(cloned);
                                    });
                                });
                                if (newSelection.length > 0) {
                                    const selectPasted = new fabric.ActiveSelection(
                                        newSelection,
                                        {
                                            canvas: canvas,
                                        }
                                    );
                                    canvas.setActiveObject(selectPasted);
                                }
                                canvas.renderAll();
                                saveCanvasState(); // Save state after pasting
                                showToast(`Pasted ${copiedObjects.length} object(s)!`);
                            } else {
                                showToast("Nothing to paste.", 2000);
                            }
                            break;

                        case "x": // Cmd/Ctrl + X: Cut Selected Objects
                            e.preventDefault();
                            // If a text object is active and in editing mode, let the browser handle text cut
                            if (
                                activeObject &&
                                (activeObject.type === "i-text" ||
                                    activeObject.type === "text" ||
                                    activeObject.type === "textbox") &&
                                activeObject.isEditing
                            ) {
                                // Let the browser handle the cut event for the text content
                                document.execCommand("cut");
                                return;
                            }

                            if (activeObjects.length > 0) {
                                copiedObjects = []; // Clear previous copied objects
                                // Clone each active object for copying
                                activeObjects.forEach((obj) => {
                                    obj.clone(function (clonedObj) {
                                        copiedObjects.push(clonedObj);
                                    });
                                });
                                // Remove active objects from canvas (cut)
                                activeObjects.forEach((obj) => canvas.remove(obj));
                                canvas.discardActiveObject();
                                canvas.renderAll();
                                saveCanvasState(); // Save state after cutting
                                showToast(`Cut ${copiedObjects.length} object(s)!`);
                            } else {
                                showToast("No object selected to cut.", 2000);
                            }
                            break;

                        case "d": // Cmd/Ctrl + D: Duplicate Selected Objects
                            e.preventDefault();
                            if (activeObjects.length > 0) {
                                const newSelection = [];
                                activeObjects.forEach((obj) => {
                                    obj.clone(function (cloned) {
                                        cloned.set({
                                            left: obj.left + 10,
                                            top: obj.top + 10,
                                            evented: true,
                                            selectable: true,
                                        });
                                        canvas.add(cloned);
                                        newSelection.push(cloned);
                                    });
                                });
                                if (newSelection.length > 0) {
                                    const selectDuplicated = new fabric.ActiveSelection(
                                        newSelection,
                                        {
                                            canvas: canvas,
                                        }
                                    );
                                    canvas.setActiveObject(selectDuplicated);
                                }
                                canvas.renderAll();
                                saveCanvasState(); // Save state after duplicating
                                showToast(`Duplicated ${activeObjects.length} object(s)!`);
                            } else {
                                showToast("No object selected to duplicate.", 2000);
                            }
                            break;

                        case "z": // Cmd/Ctrl + Z: Undo, Cmd/Ctrl + Shift + Z: Redo
                            e.preventDefault();
                            if (e.shiftKey) {
                                redo();
                            } else {
                                undo();
                            }
                            break;

                        case "y": // Cmd/Ctrl + Y: Redo (alternative for Windows users)
                            e.preventDefault();
                            redo();
                            break;
                    }
                } else {
                    // Handle non-Cmd/Ctrl key presses (like arrow keys, delete)
                    switch (e.key) {
                        case "ArrowUp":
                            activeObjects.forEach(function (obj) {
                                obj.top = (obj.top || 0) - step;
                                obj.setCoords();
                            });
                            break;
                        case "ArrowDown":
                            activeObjects.forEach(function (obj) {
                                obj.top = (obj.top || 0) + step;
                                obj.setCoords();
                            });
                            break;
                        case "ArrowLeft":
                            activeObjects.forEach(function (obj) {
                                obj.left = (obj.left || 0) - step;
                                obj.setCoords();
                            });
                            break;
                        case "ArrowRight":
                            activeObjects.forEach(function (obj) {
                                obj.left = (obj.left || 0) + step;
                                obj.setCoords();
                            });
                            break;

                        case "Delete":
                        case "Backspace":
                            // Only delete if no text object is active OR if a text object is active but NOT in editing mode
                            if (
                                activeObjects.length > 0 &&
                                !(
                                    activeObject &&
                                    (activeObject.type === "i-text" ||
                                        activeObject.type === "text" ||
                                        activeObject.type === "textbox") &&
                                    activeObject.isEditing
                                )
                            ) {
                                activeObjects.forEach((obj) => canvas.remove(obj));
                                canvas.discardActiveObject();
                                canvas.renderAll();
                                saveCanvasState(); // Save state after deletion
                                showToast("Object(s) deleted!");
                            }
                            // If a text object is active and in editing mode, allow default backspace behavior
                            break;
                    }
                }
                canvas.renderAll();
            });

            // Add a global paste event listener to handle pasting external text
            $(canvas.wrapperEl).on("paste", function (e) {
                const activeObject = canvas.getActiveObject();
                // If a text object is active and in editing mode, let Fabric.js handle it internally
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox") &&
                    activeObject.isEditing
                ) {
                    // Fabric.js typically handles this automatically for IText objects
                    return;
                }

                // If no text object is active or not in editing mode, try to paste as a new text object
                const clipboardData =
                    e.originalEvent.clipboardData || window.clipboardData;
                const pastedText = clipboardData.getData("text");

                if (pastedText) {
                    e.preventDefault();

                    const textObject = new fabric.Textbox(pastedText, {
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        fontFamily: "Roboto",
                        fontSize: 24,
                        fontWeight: "normal",
                        fill: "#000000",
                        width: 300,
                        originX: "center",
                        textAlign: "left",
                        editable: true,
                        selectable: true,
                    });

                    canvas.add(textObject);
                    canvas.setActiveObject(textObject);
                    canvas.renderAll();
                    saveCanvasState();
                    showToast("Text pasted onto canvas!");
                }
            });

            $(canvas.wrapperEl).on("wheel", function (e) {
                // Check if Ctrl key (Windows/Linux) or Cmd key (Mac) is pressed
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();

                    const zoomFactor = 0.01;
                    const delta = e.originalEvent.deltaY;

                    // Adjust zoom level based on scroll direction
                    if (delta < 0) {
                        // Scroll up (zoom in)
                        currentZoomLevel += zoomFactor;
                    } else {
                        // Scroll down (zoom out)
                        currentZoomLevel -= zoomFactor;
                    }

                    // Clamp zoom level to min/max values from the slider
                    const zoomSliderMin = parseFloat($("#zoomSlider").attr("min"));
                    const zoomSliderMax = parseFloat($("#zoomSlider").attr("max"));
                    currentZoomLevel = Math.max(
                        zoomSliderMin,
                        Math.min(zoomSliderMax, currentZoomLevel)
                    );

                    applyCanvasTransformations();
                }
            });

            fabric.Object.prototype.toObject = (function (toObject) {
                return function (propertiesToInclude) {
                    const customProps = [
                        "variableTag",
                        "variableName",
                        "isCustomVariable",
                        "isIcon",
                        "link",
                    ];
                    const allProps = Array.isArray(propertiesToInclude)
                        ? customProps.concat(propertiesToInclude)
                        : customProps;
                    return toObject.call(this, allProps);
                };
            })(fabric.Object.prototype.toObject);

            // Store the original dimensions of the design. These will be updated if a design is loaded.
            originalCanvasWidth = initialCanvasWidth;
            originalCanvasHeight = initialCanvasHeight;

            currentZoomLevel = 0.35;

            $("#zoomSlider").val(currentZoomLevel); // Use raw value for slider, not fixed decimal

            // Update the text display next to the slider to show percentage.
            $("#zoomValue").text(Math.round(currentZoomLevel * 100) + "%");

            // applyCanvasTransformations();

            // Event listeners for undo/redo buttons
            $("#undo-button").on("click", undo);
            $("#redo-button").on("click", redo);

            // Save state after any canvas modification
            canvas.on("object:added", saveCanvasState);
            canvas.on("object:modified", saveCanvasState);
            canvas.on("object:removed", saveCanvasState);

            // Initialize Spectrum color pickers
            $(
                "#bgColorPicker, #fontColorPicker, #elementFillPicker, #borderColorPicker, #imageBorderColor"
            ).spectrum({
                showInput: true,
                preferredFormat: "hex",
                showPalette: true,
                showButtons: false,
                palette: [
                    ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                    ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                    [
                        "#ea9999",
                        "#f9cb9c",
                        "#ffe599",
                        "#b6d7a8",
                        "#a2c4c9",
                        "#9fc5e8",
                        "#b4a7d6",
                        "#d5a6bd",
                    ],
                    [
                        "#e06666",
                        "#f6b26b",
                        "#ffd966",
                        "#93c47d",
                        "#76a5af",
                        "#6fa8dc",
                        "#8e7cc3",
                        "#c27ba0",
                    ],
                    [
                        "#cc0000",
                        "#e69138",
                        "#f1c232",
                        "#6aa84f",
                        "#45818e",
                        "#3d85c6",
                        "#674ea7",
                        "#a64d79",
                    ],
                    [
                        "#990000",
                        "#b45f06",
                        "#bf9000",
                        "#38761d",
                        "#134f5c",
                        "#0b5394",
                        "#351c75",
                        "#741b47",
                    ],
                    [
                        "#660000",
                        "#783f04",
                        "#7f6000",
                        "#274e13",
                        "#0c343d",
                        "#073763",
                        "#20124d",
                        "#4c1130",
                    ],
                ],
            });

            // Handle close custom modal button
            $("#closeCustomModal").on("click", function () {
                $("#customModal").removeClass("flex").addClass("hidden");
            });

            // Handle sidebar item clicks to show/hide content
            // Locate this section in your HTML (`html_canvas_basic` immersive) and ensure it matches:
            // Handle sidebar item clicks to show/hide content
            $(".editor-sidebar-items").on("click", function () {
                const targetId = $(this).data("target");
                $(".sidebar-content").addClass("hidden");
                $(".editor-sidebar-items").removeClass("active");
                $(targetId).removeClass("hidden");
                $(this).addClass("active");
                $("#sidebar-content-area")
                    .removeClass("hidden")
                    .addClass("sidebar-open");

                if ($(window).width() < 768) {
                    $("#sidebar-content-area").css("transform", "translateY(0%)");
                } else {
                    $("#sidebar-content-area").css("transform", "translateX(0%)");
                }

                if (targetId === "#image-upload-content") {
                    fetchUploadedImages();
                }
            });

            // Handle close sidebar content button
            $("#close-sidebar-content").on("click", function () {
                if ($(window).width() < 768) {
                    $("#sidebar-content-area").css("transform", "translateY(100%)");
                } else {
                    $("#sidebar-content-area").css("transform", "translateX(-100%)");
                }
                setTimeout(() => {
                    $("#sidebar-content-area")
                        .addClass("hidden")
                        .removeClass("sidebar-open");
                    $(".editor-sidebar-items").removeClass("active");
                }, 300);
            });

            /**
             * Toggles the lock state of the active object.
             * @param {fabric.Object} activeObject - The active Fabric.js object.
             */
            function toggleObjectLock(activeObject) {
                const isLocked = activeObject.lockMovementX;
                activeObject.set({
                    lockMovementX: !isLocked,
                    lockMovementY: !isLocked,
                    lockRotation: !isLocked,
                    lockScalingX: !isLocked,
                    lockScalingY: !isLocked,
                    hasControls: isLocked,
                    hasBorders: isLocked,
                });
                canvas.renderAll();
                updateFloatingControls(activeObject);
                showToast(`Object ${isLocked ? "unlocked!" : "locked!"}`);
            }

            /**
             * Duplicates the active object.
             * @param {fabric.Object} activeObject - The active Fabric.js object.
             */
            function duplicateObject(activeObject) {
                activeObject.clone(function (clonedObj) {
                    clonedObj.set({
                        left: activeObject.left + 10,
                        top: activeObject.top + 10,
                        evented: true,
                    });
                    if (clonedObj.type === "activeSelection") {
                        clonedObj.canvas = canvas;
                        clonedObj.forEachObject(function (obj) {
                            canvas.add(obj);
                        });
                    } else {
                        canvas.add(clonedObj);
                    }
                    canvas.setActiveObject(clonedObj);
                    canvas.renderAll();
                    showToast("Object duplicated!");
                });
            }

            //  Deletes the active object.

            function deleteObject(activeObject) {
                canvas.remove(activeObject);
                canvas.discardActiveObject();
                canvas.renderAll();
                showToast("Object deleted!");
            }




            // Initial toolbar state.
            updateObjectToolbar(null);
            updateFloatingControls(null);


            canvas.on({
                'selection:created': function (e) {
                    const activeObj = e.target || canvas.getActiveObject();
                    if (activeObj) {
                        updateObjectToolbar(activeObj);
                        updateFloatingControls(activeObj);
                    } else {
                        updateObjectToolbar(null);
                        updateFloatingControls(null);
                    }
                },
                'selection:updated': function (e) {
                    if (isGroupingUngrouping) {

                        return;
                    }
                    const activeObj = e.target || canvas.getActiveObject();
                    if (activeObj) {

                        updateObjectToolbar(activeObj);
                        updateFloatingControls(activeObj);
                    } else {

                        updateObjectToolbar(null);
                        updateFloatingControls(null);
                    }
                },
                'selection:cleared': function (e) {
                    if (!isGroupingUngrouping) {
                        updateObjectToolbar(null);
                        updateFloatingControls(null);
                    }
                    if (currentCropRect) {
                        cancelCrop();
                    }
                    clearGuides();
                    canvas.renderAll();
                },
                'object:moving': function (e) {
                    if (e.target) {
                        updateFloatingControls(e.target);
                        if (e.target === currentCropRect && croppedImage) {
                            updateClipPathFromCropRect();
                        } else {
                            showAlignmentGuides(e.target);
                        }
                    }
                },
                'object:modified': function (e) { // Added to clear guides after movement ends
                    if (e.target) {
                        clearGuides();
                        canvas.renderAll();
                    }
                },
                'object:scaling': function (e) {
                    if (e.target) {
                        updateFloatingControls(e.target);
                        const activeObject = e.target;

                        const updateImageClipPath = (img) => {
                            if (img.clipPath && img.clipPath.type === 'rect') {
                                img.clipPath.set({
                                    width: img.width,
                                    height: img.height,
                                    left: 0,
                                    top: 0,
                                    originX: 'center',
                                    originY: 'center'
                                });
                                img.clipPath.set('dirty', true);
                                img.set('dirty', true);
                            }
                        };

                        if (activeObject.type === 'image') {
                            updateImageClipPath(activeObject);
                        } else if (activeObject.type === 'group') {
                            activeObject.getObjects().forEach(obj => {
                                if (obj.type === 'image') {
                                    updateImageClipPath(obj);
                                }
                            });
                            activeObject.set('dirty', true);
                        }

                        if (e.target === currentCropRect && croppedImage) {
                            updateClipPathFromCropRect();
                        }
                        canvas.renderAll();
                    }
                },
                'object:rotating': function (e) {
                    if (e.target) {
                        updateFloatingControls(e.target);
                    }
                },
            });


            let isAltDragging = false;
            let originalObjectForAltDrag = null;
            let clonedObjectForAltDrag = null;
            canvas.on("mouse:down", function (opt) {
                // Existing Alt+Drag logic
                if (opt.e.altKey && opt.target) {
                    isAltDragging = true; // Set flag early

                    // Store the original object(s) that were clicked/selected
                    originalObjectForAltDrag = opt.target;

                    // Immediately make the original object(s) non-interactive
                    // This prevents Fabric.js from starting to drag the original
                    if (originalObjectForAltDrag.type === "activeSelection") {
                        originalObjectForAltDrag.forEachObject(function (obj) {
                            obj.set({ evented: false, selectable: false });
                        });
                    } else {
                        originalObjectForAltDrag.set({
                            evented: false,
                            selectable: false,
                        });
                    }
                    canvas.discardActiveObject(); // Deselect the original(s)

                    // Clone the object(s)
                    if (originalObjectForAltDrag.type === "activeSelection") {
                        const newSelection = [];
                        originalObjectForAltDrag._objects.forEach(function (obj) {
                            obj.clone(function (clonedObj) {
                                clonedObj.set({
                                    left: obj.left + 10, // Offset slightly for visibility
                                    top: obj.top + 10,
                                    evented: true,
                                    selectable: true,
                                    lockMovementX: false,
                                    lockMovementY: false,
                                    lockRotation: false,
                                    lockScalingX: false,
                                    lockScalingY: false,
                                    hasControls: true,
                                    hasBorders: true,
                                });
                                canvas.add(clonedObj);
                                newSelection.push(clonedObj);
                            });
                        });
                        if (newSelection.length > 0) {
                            clonedObjectForAltDrag = new fabric.ActiveSelection(
                                newSelection,
                                { canvas: canvas }
                            );
                            canvas.setActiveObject(clonedObjectForAltDrag);
                        }
                    } else {
                        originalObjectForAltDrag.clone(function (clonedObj) {
                            clonedObj.set({
                                left: originalObjectForAltDrag.left + 10, // Offset slightly
                                top: originalObjectForAltDrag.top + 10,
                                evented: true,
                                selectable: true,
                                lockMovementX: false,
                                lockMovementY: false,
                                lockRotation: false,
                                lockScalingX: false,
                                lockScalingY: false,
                                hasControls: true,
                                hasBorders: true,
                            });
                            canvas.add(clonedObj);
                            canvas.setActiveObject(clonedObj);
                            clonedObjectForAltDrag = clonedObj;
                        });
                    }

                    canvas.renderAll();
                    showToast("Object(s) duplicated by Alt+Drag!");
                    opt.e.stopImmediatePropagation();
                    return;
                }
            });

            canvas.on("mouse:move", function (opt) {
                canvas.remove(canvas.getObjects().filter((o) => o.isGuide)); // Clear previous guides
                if (
                    opt.target &&
                    !opt.e.altKey &&
                    opt.target.type !== "activeSelection"
                ) {
                }
            });
            canvas.on('zoom:change', function () {
                var zoom = canvas.getZoom();
                canvas.getObjects().forEach(function (obj) {
                    setObjectControls(obj, zoom);
                    if (obj.type === 'group') {
                        obj.getObjects().forEach(function (groupObj) {
                            setObjectControls(groupObj, zoom);
                        });
                    }
                });
                canvas.renderAll();
            });

            function setObjectControls(obj, zoom) {
                obj.set({
                    cornerSize: 12 / zoom,
                    padding: 10 / zoom
                });
            }

            canvas.on("mouse:up", function (opt) {
                if (isAltDragging) {
                    isAltDragging = false;
                    // Restore interactivity to the original object(s)
                    if (originalObjectForAltDrag) {
                        if (originalObjectForAltDrag.type === "activeSelection") {
                            originalObjectForAltDrag.forEachObject(function (obj) {
                                obj.set({ evented: true, selectable: true });
                            });
                        } else {
                            originalObjectForAltDrag.set({
                                evented: true,
                                selectable: true,
                            });
                        }
                    }
                    if (clonedObjectForAltDrag) {
                        saveCanvasState();
                    }
                    originalObjectForAltDrag = null;
                    clonedObjectForAltDrag = null;
                }
                canvas.remove(canvas.getObjects().filter((o) => o.isGuide));
            });

            canvas.on("touch:gesture", function (opt) {
                if (opt.e.altKey) {
                    // This might not work reliably on all touch devices
                    opt.e.preventDefault();
                }
            });

            // Adds a shape to the canvas based on button data.
            $(
                '[id^="addRectangle"], [id^="addCircle"], [id^="addTriangle"], [id^="addEllipse"], [id^="addLine"], [id^="addPolygon"]'
            ).on("click", function () {
                const type = $(this).data("type");
                const fill = $(this).data("fill") || "#cccccc";
                const stroke = $(this).data("stroke");
                const strokeWidth = $(this).data("stroke-width");
                let shape;

                const baseShapeWidth = originalCanvasWidth * 0.25;
                const baseShapeHeight = originalCanvasHeight * 0.25;
                const baseRadius = Math.min(baseShapeWidth, baseShapeHeight) / 2;

                const commonOptions = {
                    left: originalCanvasWidth / 2,
                    top: originalCanvasHeight / 2,

                    hasControls: true,
                    hasBorders: true,
                    originX: "center",
                    originY: "center",
                };

                switch (type) {
                    case "rect":
                        shape = new fabric.Rect(
                            $.extend(true, {}, commonOptions, {
                                width: baseShapeWidth,
                                height: baseShapeHeight,
                                fill: fill,
                                stroke: stroke,
                                strokeWidth: strokeWidth,
                                rx: 5,
                                ry: 5,
                            })
                        );
                        break;
                    case "circle":
                        shape = new fabric.Circle(
                            $.extend(true, {}, commonOptions, {
                                radius: baseRadius,
                                fill: fill,
                                stroke: stroke,
                                strokeWidth: strokeWidth,
                            })
                        );
                        break;
                    case "triangle":
                        shape = new fabric.Triangle(
                            $.extend(true, {}, commonOptions, {
                                width: baseShapeWidth,
                                height: baseShapeHeight,
                                fill: fill,
                                stroke: stroke,
                                strokeWidth: strokeWidth,
                            })
                        );
                        break;
                    case "ellipse":
                        shape = new fabric.Ellipse(
                            $.extend(true, {}, commonOptions, {
                                rx: baseShapeWidth / 2,
                                ry: baseShapeHeight / 2,
                                fill: fill,
                                stroke: stroke,
                                strokeWidth: strokeWidth,
                            })
                        );
                        break;
                    case "line":
                        shape = new fabric.Line(
                            [
                                commonOptions.left - baseShapeWidth / 2,
                                commonOptions.top,
                                commonOptions.left + baseShapeWidth / 2,
                                commonOptions.top,
                            ],
                            $.extend(true, {}, commonOptions, {
                                stroke: stroke,
                                strokeWidth: strokeWidth || 5,
                                fill: "transparent",
                            })
                        );
                        break;
                    case "polygon":
                        shape = new fabric.Polygon(
                            [
                                {
                                    x: commonOptions.left - baseShapeWidth / 2,
                                    y: commonOptions.top - baseShapeHeight / 2,
                                },
                                {
                                    x: commonOptions.left + baseShapeWidth / 2,
                                    y: commonOptions.top - baseShapeHeight / 2,
                                },
                                {
                                    x: commonOptions.left + baseShapeWidth / 2,
                                    y: commonOptions.top + baseShapeHeight / 2,
                                },
                                {
                                    x: commonOptions.left - baseShapeWidth / 2,
                                    y: commonOptions.top + baseShapeHeight / 2,
                                },
                            ],
                            $.extend(true, {}, commonOptions, {
                                fill: fill,
                                stroke: stroke,
                                strokeWidth: strokeWidth,
                            })
                        );
                        break;
                }

                if (shape) {
                    canvas.add(shape);
                    canvas.setActiveObject(shape);
                    canvas.renderAll();
                    saveCanvasState();
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} added!`);
                }
            });

            // Adds text to the canvas with predefined styles.
            $('[id^="addH"], #addpara').on("click", function () {
                const defaultText = $(this).data("text");
                const headerType = $(this).data("header");

                const baseFontSize = originalCanvasHeight * 0.05;

                let fontSize;
                let fontWeight = "normal";

                switch (headerType) {
                    case "h1":
                        fontSize = baseFontSize * 1.2;
                        fontWeight = "700";
                        break;
                    case "h2":
                        fontSize = baseFontSize * 1.0;
                        fontWeight = "700";
                        break;
                    case "h3":
                        fontSize = baseFontSize * 0.8;
                        fontWeight = "600";
                        break;
                    case "h4":
                        fontSize = baseFontSize * 0.7;
                        fontWeight = "600";
                        break;
                    case "h5":
                        fontSize = baseFontSize * 0.6;
                        fontWeight = "500";
                        break;
                    case "p":
                        fontSize = baseFontSize * 0.5;
                        fontWeight = "400";
                        break;
                    default:
                        fontSize = baseFontSize * 0.8;
                        fontWeight = "normal";
                }

                // Ensure a minimum font size to prevent it from becoming too small
                fontSize = Math.max(fontSize, 12);

                const textObject = new fabric.Textbox(defaultText, {
                    left: canvas.width / 2,
                    top: 100,
                    fontFamily: "Roboto",
                    fontSize: fontSize,
                    fontWeight: fontWeight,
                    fill: "#000000",
                    width: originalCanvasWidth * 0.6,
                    originX: "center",

                    textAlign: "center",
                    editable: true,
                    selectable: true,
                });

                canvas.add(textObject);
                canvas.setActiveObject(textObject);
                canvas.renderAll();
                saveCanvasState();
                showToast(`Text added: "${defaultText}"`);
            });

            // Event listener for pre-designed text combinations (PRIMARY AND CORRECTED INSTANCE)
            $('[data-type="text-combination"]').on("click", function () {
                const textConfigs = $(this).data("text-configs");
                const objectsToAdd = [];
                let currentYOffset = 0;

                textConfigs.forEach((config) => {
                    const textObject = new fabric.Textbox(config.text, {
                        left: 0,
                        top: currentYOffset + (config.offsetY || 0),
                        fontFamily: config.fontFamily || "Roboto",
                        fontSize: Math.max(
                            config.fontSizeRatio * originalCanvasHeight || 24,
                            12
                        ),
                        fontWeight: config.fontWeight || "normal",
                        fontStyle: config.fontStyle || "normal",
                        fill: config.fill || "#000000",
                        width: originalCanvasWidth * 0.5,
                        textAlign: config.textAlign || "left",
                        editable: true,
                        selectable: true,
                        originX: "left",
                        originY: "top",
                    });
                    objectsToAdd.push(textObject);
                    // Update currentYOffset for the next object, based on the current object's height
                    textObject.setCoords(); // Ensure textObject has calculated dimensions
                    currentYOffset += textObject.getScaledHeight();
                });

                if (objectsToAdd.length > 0) {
                    const group = new fabric.Group(objectsToAdd, {
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        originX: "center",
                        originY: "center",

                        hasControls: true,
                        hasBorders: true,
                    });
                    canvas.add(group);
                    canvas.setActiveObject(group);
                    canvas.renderAll();
                    saveCanvasState();
                    showToast("Text combination added!");
                }
            });

            // Dragstart for these new text combination buttons
            $('[data-type="text-combination"]').on("dragstart", function (e) {
                const originalEvent = e.originalEvent;
                const textConfigsString = $(this).attr("data-text-configs");
                originalEvent.dataTransfer.setData("text/plain", textConfigsString);
                originalEvent.dataTransfer.setData("text/x-type", "text-combination");
                originalEvent.dataTransfer.effectAllowed = "copy";
                originalEvent.dataTransfer.setData("text/x-internal-drag", "true");
                e.stopPropagation();
            });
            // Text formatting toolbar actions.
            $("#fontFamily").on("change", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("fontFamily", $(this).val());
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            function updateFontSizeInput() {
                const activeObject = canvas.getActiveObject();
                const fontSizeInput = $("#fontSizeInput");

                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    // Round the font size to the nearest whole number before displaying it
                    const roundedFontSize = Math.round(activeObject.get("fontSize"));
                    fontSizeInput.val(roundedFontSize);
                } else {
                    // If no text object is active, you can clear the input or set a default
                    fontSizeInput.val(null);
                }
            }

            // Event handler for when a new object is selected on the canvas
            canvas.on("selection:created", updateFontSizeInput);
            canvas.on("selection:updated", updateFontSizeInput);
            canvas.on("selection:cleared", updateFontSizeInput);


            // The original change handler now uses the updated value
            $("#fontSizeInput").on("change", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    const newFontSize = parseInt($(this).val(), 10);
                    if (!isNaN(newFontSize)) {
                        activeObject.set("fontSize", newFontSize);
                        canvas.renderAll();
                        saveCanvasState();
                    }
                }
            });

            // The minus button logic
            $("#minusBtn").on("click", function () {
                const fontSizeInput = $("#fontSizeInput");
                let currentSize = parseInt(fontSizeInput.val(), 10);
                const minSize = parseInt(fontSizeInput.attr("min"), 10);

                if (!isNaN(currentSize) && currentSize > minSize) {
                    currentSize--;
                    fontSizeInput.val(currentSize);
                    fontSizeInput.trigger("change");
                }
            });

            // The plus button logic
            $("#plusBtn").on("click", function () {
                const fontSizeInput = $("#fontSizeInput");
                let currentSize = parseInt(fontSizeInput.val(), 10);
                const maxSize = parseInt(fontSizeInput.attr("max"), 10);

                if (!isNaN(currentSize) && currentSize < maxSize) {
                    currentSize++;
                    fontSizeInput.val(currentSize);
                    fontSizeInput.trigger("change");
                }
            });
            $("#fontColorPicker").on("move.spectrum", function (e, tinycolor) {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("fill", tinycolor.toHexString());
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#boldBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    const isBold = activeObject.fontWeight === "bold";
                    activeObject.set("fontWeight", isBold ? "normal" : "bold");
                    $(this).toggleClass("active", !isBold);
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#italicBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    const isItalic = activeObject.fontStyle === "italic";
                    activeObject.set("fontStyle", isItalic ? "normal" : "italic");
                    $(this).toggleClass("active", !isItalic);
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#underlineBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("underline", !activeObject.underline);
                    $(this).toggleClass("active", activeObject.underline);
                    canvas.renderAll();
                    saveCanvasState();
                }
            });
            // Function to convert a string to Title Case (Capitalize Case)
            String.prototype.toCapitalizeCase = function () {
                return this.replace(/\w\S*/g, function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            };

            // Capitalize button handler
            $("#capitalizeBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    const currentText = activeObject.text;

                    if (currentText === currentText.toUpperCase()) {
                        activeObject.set("text", currentText.toCapitalizeCase());
                    } else {
                        activeObject.set("text", currentText.toUpperCase());
                    }
                    canvas.renderAll();
                    saveCanvasState();

                    $(this).toggleClass(
                        "active",
                        activeObject.text === activeObject.text.toUpperCase()
                    );
                } else {
                }
            });

            $("#strikethroughBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("linethrough", !activeObject.linethrough);
                    $(this).toggleClass("active", activeObject.linethrough);
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            // Text alignment handlers.
            $("#textAlignLeft").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("textAlign", "left");
                    $(this).addClass("active").siblings().removeClass("active");
                    canvas.renderAll();
                    saveCanvasState();
                } else {

                }
            });

            $("#textAlignCenter").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("textAlign", "center");
                    $(this).addClass("active").siblings().removeClass("active");
                    canvas.renderAll();
                    saveCanvasState();
                } else {

                }
            });

            $("#textAlignRight").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("textAlign", "right");
                    $(this).addClass("active").siblings().removeClass("active");
                    canvas.renderAll();
                    saveCanvasState();
                } else {

                }
            });

            $("#textAlignJustify").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("textAlign", "justify");
                    $(this).addClass("active").siblings().removeClass("active");
                    canvas.renderAll();
                    saveCanvasState();
                } else {

                }
            });

            // Element color and border toolbar actions.
            $("#elementFillPicker").on("move.spectrum", function (e, tinycolor) {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    activeObject.set("fill", tinycolor.toHexString());
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#borderColorPicker").on("move.spectrum", function (e, tinycolor) {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    activeObject.set("stroke", tinycolor.toHexString());
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#borderThickness").on("change", function () {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    activeObject.set("strokeWidth", parseInt($(this).val()));
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#borderType").on("change", function () {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    const type = $(this).val();
                    if (type === "dashed") {
                        activeObject.set("strokeDashArray", [5, 5]);
                    } else if (type === "dotted") {
                        activeObject.set("strokeDashArray", [1, 3]);
                    } else {
                        activeObject.set("strokeDashArray", []);
                    }
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#elementBorderRadius").on("input", function () {
                const activeObject = canvas.getActiveObject();
                const radius = parseInt($(this).val());

                if (activeObject) {
                    if (activeObject.type === "rect") {
                        activeObject.set({ rx: radius, ry: radius });
                        canvas.renderAll();
                        saveCanvasState();
                        showToast(`Rectangle radius set to ${radius}!`);
                    } else if (activeObject.type === "ellipse") {
                        activeObject.set({ rx: radius, ry: radius });
                        canvas.renderAll();
                        showToast(
                            `Ellipse radii set to ${radius} (making it more circular)!`
                        );
                    } else {
                        showToast(
                            "Border radius only applies to rectangles and ellipses.",
                            3000
                        );
                    }
                } else {
                    showToast("No object selected to apply radius.", 3000);
                }
            });

            // Image controls actions.
            $("#imageOpacity").on("input", function () {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === "image") {
                    activeObject.set("opacity", parseFloat($(this).val()));
                    canvas.renderAll();
                }
            });

            $("#imageBorderColor").on("move.spectrum", function (e, tinycolor) {
                let activeObject = canvas.getActiveObject();
                if (!activeObject) return;
                let targetImage =
                    activeObject.type === "group"
                        ? activeObject.getObjects().find((obj) => obj.type === "image")
                        : activeObject;
                if (targetImage && targetImage.type === "image") {
                    targetImage.set("stroke", tinycolor.toHexString());
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#imageBorderThickness").on("change", function () {
                let activeObject = canvas.getActiveObject();
                if (!activeObject) return;
                let targetImage =
                    activeObject.type === "group"
                        ? activeObject.getObjects().find((obj) => obj.type === "image")
                        : activeObject;
                if (targetImage && targetImage.type === "image") {
                    targetImage.set("strokeWidth", parseInt($(this).val()));
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            $("#imageBorderRadius").on("input", function () {
                let activeObject = canvas.getActiveObject();
                if (!activeObject) return;

                let targetImage =
                    activeObject.type === "group"
                        ? activeObject.getObjects().find((obj) => obj.type === "image")
                        : activeObject;
                if (!targetImage || targetImage.type !== "image") return;

                const radius = parseInt($(this).val()) || 0;

                if (radius < 0 || radius > 100) return;

                if (radius > 0) {
                    if (!targetImage.clipPath || targetImage.clipPath.type !== "rect") {
                        targetImage.clipPath = new fabric.Rect({
                            width: targetImage.width,
                            height: targetImage.height,
                            originX: "center",
                            originY: "center",
                            left: 0,
                            top: 0,
                            fill: "transparent",
                            selectable: false,
                            evented: false,
                        });
                    }
                    targetImage.clipPath.set({ rx: radius, ry: radius });
                    targetImage.clipPath.set("dirty", true);
                } else {
                    targetImage.clipPath = null;
                }

                targetImage.set("dirty", true);
                canvas.renderAll();
                saveCanvasState();
            });

            $("#flipXBtn").on("click", function () {
                let activeObject = canvas.getActiveObject();
                let targetImage =
                    activeObject.type === "group"
                        ? activeObject.getObjects().find((obj) => obj.type === "image")
                        : activeObject;
                if (targetImage && targetImage.type === "image") {
                    targetImage.set("flipX", !targetImage.flipX);
                    $(this).toggleClass("active", targetImage.flipX);
                    canvas.renderAll();
                    saveCanvasState();
                    showToast(
                        `Image flipped ${targetImage.flipX ? "horizontally" : "back"}!`
                    );
                }
            });

            $("#flipYBtn").on("click", function () {
                let activeObject = canvas.getActiveObject();
                let targetImage =
                    activeObject.type === "group"
                        ? activeObject.getObjects().find((obj) => obj.type === "image")
                        : activeObject;
                if (targetImage && targetImage.type === "image") {
                    targetImage.set("flipY", !targetImage.flipY);
                    $(this).toggleClass("active", targetImage.flipY);
                    canvas.renderAll();
                    saveCanvasState();
                    showToast(
                        `Image flipped ${targetImage.flipY ? "vertically" : "back"}!`
                    );
                }
            });

            function centerActiveObjectOnCanvas(axis = "both") {
                const activeObject = canvas.getActiveObject();
                if (!activeObject) {
                    showToast("No object selected to center.", 2000);
                    return;
                }

                if (axis === "horizontal" || axis === "both") {
                    activeObject.set({ left: canvas.width / 2, originX: "center" });
                }
                if (axis === "vertical" || axis === "both") {
                    activeObject.set({ top: canvas.height / 2, originY: "center" });
                }
                canvas.renderAll();
                saveCanvasState();
                showToast("Object centered on canvas!");
            }

            // Updates the clipPath of the selected image based on the cropping rectangle's position and size.
            function updateClipPathFromCropRect() {
                if (selectedImage && croppingRect) {
                    const imageTransform = selectedImage.calcTransformMatrix();
                    const inverseImageTransform =
                        fabric.util.invertTransform(imageTransform);

                    // Get the cropping rectangle's coordinates in canvas space
                    const cropRectCoords = croppingRect.getBoundingRect();

                    // Create a point for the top-left corner of the cropping rectangle in canvas space
                    const topLeftCropPoint = new fabric.Point(
                        cropRectCoords.left,
                        cropRectCoords.top
                    );

                    // Transform this canvas point into the image's local coordinate system
                    const transformedTopLeft = fabric.util.transformPoint(
                        topLeftCropPoint,
                        inverseImageTransform
                    );
                    const clipWidth = cropRectCoords.width / selectedImage.scaleX;
                    const clipHeight = cropRectCoords.height / selectedImage.scaleY;

                    const clipRect = new fabric.Rect({
                        left: transformedTopLeft.x,
                        top: transformedTopLeft.y,
                        width: clipWidth,
                        height: clipHeight,
                        originX: "left",
                        originY: "top",
                        absolutePositioned: false,
                        fill: "black",
                        selectable: false,
                        evented: false,
                        objectCaching: false,
                    });

                    selectedImage.set({
                        clipPath: clipRect,
                        dirty: true,
                    });
                    canvas.renderAll();

                    canvas.bringToFront(selectedImage);
                    canvas.bringToFront(croppingRect);
                    canvas.renderAll();
                }
            }
            function enableCropMode() {
                const activeObject = canvas.getActiveObject();

                if (activeObject && activeObject.type === "image") {
                    selectedImage = activeObject; // The original image to be cropped
                    isCropModeActive = true; // Activate crop mode

                    $("#image-controls").addClass("hidden");
                    $("#floating-object-controls")
                        .removeClass("show")
                        .addClass("hidden"); // Ensure hidden

                    const imageBoundingRect = selectedImage.getBoundingRect();

                    // Create a cropping rectangle overlay on top of the selected image
                    croppingRect = new fabric.Rect({
                        // Use the bounding box's left and top for accurate positioning on canvas
                        left: imageBoundingRect.left,
                        top: imageBoundingRect.top,
                        // Use the bounding box's width and height for accurate sizing on canvas
                        width: imageBoundingRect.width,
                        height: imageBoundingRect.height,
                        fill: "rgba(0,0,0,0.1)", // semi-transparent overlay
                        stroke: "#1d89ff", // Blue stroke for clarity
                        strokeWidth: 2,
                        strokeDashArray: [5, 5],
                        originX: "left", // Keep origin at top-left for easy positioning
                        originY: "top",
                        selectable: true,
                        hasBorders: true,
                        hasControls: true,
                        lockRotation: true, // Cropping rect should not rotate


                        padding: 0,
                        minWidth: 10,
                        minHeight: 10,
                    });

                    canvas.add(croppingRect);
                    canvas.setActiveObject(croppingRect);
                    canvas.renderAll();

                    // Show crop actions
                    $("#crop-actions").removeClass("hidden");
                    showToast(
                        "Drag and resize the box to crop. Click 'Apply' when done."
                    );

                    // Set the selectedImage as the one to be clipped for live preview
                    croppedImage = selectedImage;

                    selectedImage.set({ selectable: false, evented: false });
                    canvas.bringToFront(selectedImage);
                    canvas.bringToFront(croppingRect);

                    updateClipPathFromCropRect();
                } else {
                    showToast("Please select an image to crop.");
                }
            }
            // Applies the crop to the image using a temporary canvas.

            function applyCrop() {
                if (croppingRect && selectedImage) {
                    const originalCanvasBgColor = canvas.backgroundColor;
                    selectedImage.set({
                        clipPath: null,
                        dirty: true,
                        selectable: true,
                        evented: true,
                    });
                    canvas.remove(croppingRect);

                    // Get the bounding box of the cropping rectangle in canvas coordinates
                    const cropRectCoords = croppingRect.getBoundingRect();

                    const objectsToRestore = canvas
                        .getObjects()
                        .filter((obj) => obj !== selectedImage);
                    objectsToRestore.forEach((obj) => canvas.remove(obj));
                    canvas.renderAll();

                    const highResMultiplier = 3;

                    canvas.setBackgroundColor("rgba(0,0,0,0)", function () {
                        canvas.renderAll();

                        const croppedDataUrl = canvas.toDataURL({
                            left: cropRectCoords.left,
                            top: cropRectCoords.top,
                            width: cropRectCoords.width,
                            height: cropRectCoords.height,
                            format: "png",
                            quality: 1,
                            multiplier: highResMultiplier,
                        });

                        // Restore original canvas background immediately after getting the dataURL
                        canvas.setBackgroundColor(originalCanvasBgColor, function () {
                            canvas.renderAll();
                            objectsToRestore.forEach((obj) => canvas.add(obj));

                            fabric.Image.fromURL(
                                croppedDataUrl,
                                function (newCroppedImg) {
                                    if (newCroppedImg) {
                                        newCroppedImg.set({
                                            left: cropRectCoords.left,
                                            top: cropRectCoords.top,
                                            scaleX: 1 / highResMultiplier,
                                            scaleY: 1 / highResMultiplier,
                                            originX: "left",
                                            originY: "top",

                                            transparentCorners: false,
                                            hasControls: true,
                                            hasBorders: true,
                                            isIcon: selectedImage.isIcon,
                                        });

                                        canvas.remove(selectedImage);
                                        canvas.add(newCroppedImg);
                                        canvas.setActiveObject(newCroppedImg);
                                        canvas.renderAll();
                                        saveCanvasState();
                                        showToast("Image cropped successfully!");

                                        // Reset cropping state variables
                                        croppingRect = null;
                                        selectedImage = null;
                                        croppedImage = null;
                                        isCropModeActive = false;

                                        // Update toolbars based on the newly active object
                                        $("#crop-actions").addClass("hidden");
                                        updateObjectToolbar(canvas.getActiveObject());
                                        updateFloatingControls(canvas.getActiveObject());
                                    } else {
                                        showToast(
                                            "Failed to add cropped image to canvas. Please check the URL.",
                                            3000
                                        );
                                    }
                                },
                                {
                                    crossOrigin: "anonymous",
                                    onError: function (img, err) {
                                        console.error(
                                            "Fabric.js Image loading error for cropped image:",
                                            err
                                        );
                                        showToast(
                                            "Failed to load cropped image. This might be due to a broken link or CORS issues.",
                                            5000
                                        );
                                        // Revert state if error
                                        cancelCrop(); // Call cancelCrop to restore original state gracefully
                                    },
                                }
                            );
                        });
                    });
                }
            }

            function cancelCrop() {
                if (croppingRect) {
                    canvas.remove(croppingRect);
                    croppingRect = null;
                }
                // Remove clipPath from the original image and make it interactive again
                if (selectedImage) {
                    selectedImage.set({
                        clipPath: null,
                        dirty: true,
                        selectable: true,
                        evented: true,
                    });
                    canvas.setActiveObject(selectedImage); // Re-select the original image
                } else {
                    canvas.discardActiveObject();
                }
                canvas.renderAll();

                // Reset cropping state variables
                selectedImage = null;
                croppedImage = null;
                isCropModeActive = false; // Deactivate crop mode

                $("#crop-actions").addClass("hidden");
                updateObjectToolbar(canvas.getActiveObject());
                updateFloatingControls(canvas.getActiveObject());
                showToast("Cropping cancelled.");
            }

            $(document).ready(function () {
                // Event listeners for crop buttons
                $("#cropImageBtn").on("click", enableCropMode);
                $("#applyCropBtn").on("click", applyCrop);
                $("#cancelCropBtn").on("click", cancelCrop);
            });

            // Handles opacity changes for the active object.
            $("#opacity").on("input", function () {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    activeObject.set("opacity", parseFloat($(this).val()));
                    canvas.renderAll();
                }
            });

            // Floating controls event handlers.
            $("#lockUnlockFloatingBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    toggleObjectLock(activeObject);
                }
            });

            $("#duplicateFloatingBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    duplicateObject(activeObject);
                }
            });

            $("#deleteFloatingBtn").on("click", function () {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    deleteObject(activeObject);
                } else {
                    showToast("No object selected to delete.", 2000);
                }
            });

            function deleteObject(objectToDelete) {
                canvas.remove(objectToDelete);
                canvas.discardActiveObject();
                canvas.requestRenderAll();
                saveCanvasState(); // This will save a 'delete' state
                showToast("Object(s) deleted!"); // This will show a 'deleted' toast
                updateObjectToolbar(null);
                updateFloatingControls(null);
            }

            // Global canvas controls.
            $("#bgColorPicker").on("move.spectrum", function (e, tinycolor) {
                canvas.setBackgroundColor(
                    tinycolor.toRgbString(),
                    canvas.renderAll.bind(canvas)
                );
                saveCanvasState();
            });

            // Image upload functionality.
            $("#browse-files-button").on("click", function () {
                $("#file-upload-input").click();
            });

            $("#file-upload-input").on("change", function (e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleFileUpload(files);
                }
            });

            // Handles file upload to the server.
            function handleFileUpload(files) {
                const $imageContainer = $("#uploadedImages");
                $("#image-loader").removeClass("hidden");


                let filesProcessed = 0;
                const totalFiles = files.length;

                Array.from(files).forEach((file, index) => {
                    const formData = new FormData();
                    formData.append("file", file);

                    $.ajax({
                        url: "/api/files/upload/",
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.file && response.file.url) {
                                showToast("Image uploaded successfully!");

                                fetchUploadedImages();
                            } else {
                                showToast("File upload failed. No URL returned.", 3000);
                            }
                        },
                        error: function (xhr, status, error) {
                            showToast(`Image upload failed: ${error}`, 3000);
                        },
                        complete: function () {
                            filesProcessed++;
                            if (filesProcessed === totalFiles) {
                                $("#image-loader").addClass("hidden");
                            }
                        },
                    });
                });
            }

            // Function to append image to container
            function appendImageToContainer($container, file, prepend = false) {
                return new Promise((resolve, reject) => {
                    const $imgWrapper = $("<div>", {
                        class: "imageWrapper cursor-pointer w-full flex",
                        style: "position: relative;",
                        draggable: "true", // Explicitly make the wrapper draggable
                    });
                    const $imgElement = $("<img>", {
                        class: "my-single-image w-full",
                        src: file.url,
                    });

                    // Attach load/error handlers to the image element to know when it's visually ready
                    $imgElement
                        .on("load", function () {
                            resolve(); // Resolve the promise when the image is loaded
                        })
                        .on("error", function () {
                            console.error(
                                "Error loading image in appendImageToContainer:",
                                file.url
                            );
                            resolve();
                        });

                    const $downloadBtn = $("<button>", {
                        class:
                            "btn-icon-2 absolute top-2 right-1 bg-black/50 text-white rounded-md opacity-0 transition-opacity duration-200",
                        html: '<i class="fas fa-download icon-sm-2"></i>',
                    }).on("click", function () {
                        const $a = $("<a>", { href: file.url, download: file.fileName });
                        $a[0].click();
                    });
                    const $deleteBtn = $("<button>", {
                        class:
                            "btn-icon-2 absolute top-2 right-8 bg-black/50 text-white rounded-md opacity-0 transition-opacity duration-200",
                        html: '<i class="fas fa-trash-alt icon-sm-2"></i>',
                    }).on("click", function () {
                        showCustomModal(
                            "Confirm Delete",
                            "Are you sure you want to delete this file?",
                            `<button id="confirmDeleteFileBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                    <button id="cancelDeleteFileBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                        );
                        $("#confirmDeleteFileBtn").on("click", function () {
                            $.ajax({
                                url: `/api/files/${file._id}`,
                                method: "DELETE",
                                success: function () {
                                    showToast("File deleted successfully!");
                                    fetchUploadedImages();
                                    $("#customModal").removeClass("flex").addClass("hidden");
                                },
                                error: function (xhr, status, error) {
                                    showToast("Failed to delete file. Please try again.", 3000);
                                    $("#customModal").removeClass("flex").addClass("hidden");
                                },
                            });
                        });
                        $("#cancelDeleteFileBtn").on("click", function () {
                            $("#customModal").removeClass("flex").addClass("hidden");
                        });
                    });

                    $imgWrapper.append($imgElement, $downloadBtn, $deleteBtn);

                    if (prepend) {
                        $container.prepend($imgWrapper);
                    } else {
                        $container.append($imgWrapper);
                    }

                    $imgWrapper.hover(
                        function () {
                            $downloadBtn.show();
                            $deleteBtn.show();
                        },
                        function () {
                            $downloadBtn.hide();
                            $deleteBtn.hide();
                        }
                    );

                    // Add dragstart event for uploaded images to the WRAPPER
                    $imgWrapper.on("dragstart", function (e) {
                        const originalEvent = e.originalEvent;
                        const imageUrl = $(this).find("img").attr("src");
                        originalEvent.dataTransfer.clearData(); // Clear any existing data
                        originalEvent.dataTransfer.setData("text/plain", imageUrl);
                        originalEvent.dataTransfer.setData(
                            "text/x-type",
                            "uploaded-image"
                        );
                        originalEvent.dataTransfer.effectAllowed = "copy";
                        originalEvent.dataTransfer.setData(
                            "text/x-internal-drag",
                            "true"
                        ); // Explicitly set internal drag flag
                        isDraggingUploadedImage = true; // Set flag

                        e.stopPropagation();
                    });

                    // Add dragend event for uploaded images to the WRAPPER
                    $imgWrapper.on("dragend", function (e) {
                        isDraggingUploadedImage = false; // Reset the flag when drag ends

                        e.stopPropagation();
                    });

                    // The click handler for adding to canvas remains on the imgElement
                    $imgElement.on("click", function () {
                        var imgSrc = $(this).attr("src");
                        addUploadedImageToCanvas(
                            imgSrc,
                            canvas.width / 2,
                            canvas.height / 2
                        );
                        saveCanvasState();
                        showToast("Uploaded image added to canvas!");
                    });
                });
            }

            // New: Full-screen drag overlay logic for external files
            const fileDragOverlay = document.getElementById("file-drag-overlay");
            let dragCounter = 0;

            document.addEventListener("dragenter", function (e) {
                if (isDraggingUploadedImage) {
                    e.preventDefault();
                    e.stopPropagation();

                    return;
                }

                // Existing check for other internal drags (like text, shapes, icons)
                const isInternalDrag =
                    e.dataTransfer &&
                    Array.from(e.dataTransfer.types).includes("text/x-internal-drag");
                if (isInternalDrag) {
                    e.preventDefault();
                    e.stopPropagation();

                    return;
                }

                // Existing check for external file drags
                const isExternalFileDrag =
                    e.dataTransfer &&
                    Array.from(e.dataTransfer.types).includes("Files");
                if (isExternalFileDrag) {
                    dragCounter++;
                    if (dragCounter === 1) {
                        // Only show overlay on the first dragenter
                        fileDragOverlay.classList.remove(
                            "opacity-0",
                            "hidden",
                            "pointer-events-none"
                        );
                        fileDragOverlay.classList.add(
                            "opacity-100",
                            "flex",
                            "pointer-events-auto"
                        );
                    }
                }
                e.preventDefault(); // Prevent default to allow drop
                e.stopPropagation();
            });

            // Keep the overlay visible while dragging over the document
            document.addEventListener("dragover", function (e) {
                e.preventDefault(); // Allow drop
                e.stopPropagation();
            });

            let dragLeaveTimeout;
            document.addEventListener("dragleave", function (e) {
                // Check if it's an internal drag. If so, exit early.
                const isInternalDrag =
                    e.dataTransfer &&
                    Array.from(e.dataTransfer.types).includes("text/x-internal-drag");
                if (isInternalDrag) {
                    return; // Exit early, no need to hide overlay as it shouldn't have been shown by this logic
                }

                // Clear any previous timeout
                clearTimeout(dragLeaveTimeout);

                // Set a new timeout. If mouse re-enters before timeout, it means it's still dragging over children.
                dragLeaveTimeout = setTimeout(() => {
                    // Check if the drag event contains files (indicating an external drag)
                    const isExternalFileDrag =
                        e.dataTransfer &&
                        Array.from(e.dataTransfer.types).includes("Files");

                    // Only hide the overlay if it was an external drag that caused it to show
                    if (isExternalFileDrag) {
                        dragCounter--;
                        if (dragCounter === 0) {
                            fileDragOverlay.classList.remove(
                                "opacity-100",
                                "flex",
                                "pointer-events-auto"
                            );
                            fileDragOverlay.classList.add(
                                "opacity-0",
                                "hidden",
                                "pointer-events-none"
                            );
                        }
                    }
                }, 50); // Small delay to account for nested elements
                e.stopPropagation(); // Stop propagation
            });

            // Handle drop specifically on the full-screen overlay
            fileDragOverlay.addEventListener("drop", function (e) {
                e.preventDefault(); // Prevent default file opening behavior
                e.stopPropagation(); // Crucial: Stop propagation to prevent other drop listeners from firing

                // Hide the overlay using Tailwind classes
                fileDragOverlay.classList.remove(
                    "opacity-100",
                    "flex",
                    "pointer-events-auto"
                );
                fileDragOverlay.classList.add(
                    "opacity-0",
                    "hidden",
                    "pointer-events-none"
                );
                dragCounter = 0; // Reset counter

                const dt = e.dataTransfer;

                if (dt.files && dt.files.length > 0) {
                    const imageFiles = Array.from(dt.files).filter((file) =>
                        file.type.startsWith("image/")
                    );

                    if (imageFiles.length > 0) {
                        handleFileUpload(imageFiles); // Call your existing file upload function
                        showToast("Uploading image(s) from your computer...");
                    } else {
                        showToast(
                            "Only image files can be uploaded via drag and drop here.",
                            3000
                        );
                    }
                }
            });

            // Drag and drop target for the canvas wrapper
            canvas.wrapperEl.addEventListener("dragover", function (e) {
                e.preventDefault();
                e.stopPropagation();

                $(this).addClass("highlight");
            });

            canvas.wrapperEl.addEventListener("dragleave", function (e) {
                e.stopPropagation();
                $(this).removeClass("highlight");
            });

            // Handles drag and drop events on the canvas wrapper.
            canvas.wrapperEl.addEventListener("drop", function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass("highlight");

                const dt = e.dataTransfer;
                const pointer = canvas.getPointer(e);

                const dropType = dt.getData("text/x-type");
                const data = dt.getData("text/plain");

                if (dropType === "ai-design") {
                    let designData = dt.getData("application/json") || dt.getData("text/plain");
                    try {
                        designData = JSON.parse(designData);
                        loadAIDesignToMainCanvas(designData);
                        showToast("AI Design dropped onto canvas!");
                    } catch (err) {
                        showToast("Failed to load dropped design.", 3000);
                        console.error("Error parsing AI Design data:", err);
                    }
                    return; // Stop further processing
                }
                else if (
                    dropType === "design-background" ||
                    (data &&
                        (data.includes("certificate_template") ||
                            data.includes("mixcertificate")))
                ) {
                    showToast("Applying background from drag and drop...", 0);

                    fabric.Image.fromURL(
                        data,
                        function (img) {
                            if (img) {
                                const scaleX = originalCanvasWidth / img.width;
                                const scaleY = originalCanvasHeight / img.height;
                                const scale = Math.max(scaleX, scaleY);

                                const left = (originalCanvasWidth - img.width * scale) / 2;
                                const top = (originalCanvasHeight - img.height * scale) / 2;

                                canvas.setBackgroundImage(
                                    img,
                                    function () {
                                        canvas.renderAll();
                                        saveCanvasState();
                                        showToast(
                                            "Design background applied successfully!",
                                            3000
                                        );
                                    },
                                    {
                                        scaleX: scale,
                                        scaleY: scale,
                                        originX: "left",
                                        originY: "top",
                                        left: left,
                                        top: top,
                                        crossOrigin: "anonymous",
                                    }
                                );
                            } else {
                                console.error(
                                    "Fabric.js image object not created (img is null or undefined) for background. URL:",
                                    data
                                );
                                showToast(
                                    "Failed to load design background. Please check the image source.",
                                    3000
                                );
                            }
                        },
                        {
                            crossOrigin: "anonymous",
                            onError: function (img, err) {
                                console.error(
                                    "Fabric.js Image loading error for dropped design background:",
                                    err,
                                    "Image URL:",
                                    data
                                );
                                showToast(
                                    "Failed to load design background. This might be due to a broken link or CORS issues.",
                                    5000
                                );
                            },
                        }
                    );

                    return; // IMPORTANT: Stop processing here after attempting to set background
                }
                // Handle other internal drop types
                else if (dropType === "text-heading" || dropType === "text-body") {
                    const defaultText = dt.getData("text/x-text-content");
                    const headerType = dt.getData("text/x-header-type");

                    const baseFontSize = originalCanvasHeight * 0.05;
                    let fontSize;
                    let fontWeight = "normal";

                    switch (headerType) {
                        case "h1":
                            fontSize = baseFontSize * 1.2;
                            fontWeight = "700";
                            break;
                        case "h2":
                            fontSize = baseFontSize * 1.0;
                            fontWeight = "700";
                            break;
                        case "h3":
                            fontSize = baseFontSize * 0.8;
                            fontWeight = "600";
                            break;
                        case "h4":
                            fontSize = baseFontSize * 0.7;
                            fontWeight = "600";
                            break;
                        case "h5":
                            fontSize = baseFontSize * 0.6;
                            fontWeight = "500";
                            break;
                        case "p":
                            fontSize = baseFontSize * 0.5;
                            fontWeight = "400";
                            break;
                        default:
                            fontSize = baseFontSize * 0.8;
                            fontWeight = "normal";
                    }

                    const textObject = new fabric.Textbox(defaultText, {
                        left: pointer.x,
                        top: pointer.y,
                        fontFamily: String($("#fontFamily").val() || "Roboto"),
                        fontSize: fontSize || 50,
                        fill: "#000000",
                        fontWeight: fontWeight || "normal",

                        transparentCorners: false,
                        hasControls: true,
                        hasBorders: true,
                        width: originalCanvasWidth * 0.4,
                        textAlign: "center",
                    });

                    if (canvas) {
                        canvas.add(textObject);
                        canvas.setActiveObject(textObject);
                        canvas.renderAll();
                        saveCanvasState();
                        showToast(`Text added: "${defaultText}"`);
                    } else {
                        console.error(
                            "Error: Fabric.js canvas object is not defined or initialized."
                        );
                    }
                } else if (dropType === "variable") {
                    const variableTag = dt.getData("text/x-variable-tag");
                    const variableName = dt.getData("text/x-variable-name");
                    addVariableToCanvasAtCoords(
                        variableTag,
                        variableName,
                        pointer.x,
                        pointer.y
                    );
                    showToast(`Variable "${variableName}" dropped onto canvas!`);
                } else if (dropType === "text-combination") {
                    const textConfigs = JSON.parse(data);
                    const objectsToAdd = [];
                    let currentYOffset = 0;

                    textConfigs.forEach((config) => {
                        const textObject = new fabric.Textbox(config.text, {
                            left: 0,
                            top: currentYOffset + (config.offsetY || 0),
                            fontFamily: config.fontFamily || "Roboto",
                            fontSize: Math.max(
                                config.fontSizeRatio * originalCanvasHeight || 24,
                                12
                            ),
                            fontWeight: config.fontWeight || "normal",
                            fontStyle: config.fontStyle || "normal",
                            fill: config.fill || "#000000",
                            width: originalCanvasWidth * 0.5,
                            textAlign: config.textAlign || "left",
                            editable: true,
                            selectable: true,
                            originX: "left",
                            originY: "top",
                        });
                        objectsToAdd.push(textObject);
                        textObject.setCoords();
                        currentYOffset += textObject.getScaledHeight();
                    });

                    if (objectsToAdd.length > 0) {
                        const group = new fabric.Group(objectsToAdd, {
                            left: pointer.x,
                            top: pointer.y,
                            originX: "center",
                            originY: "center",

                            transparentCorners: false,
                            hasControls: true,
                            hasBorders: true,
                        });
                        canvas.add(group);
                        canvas.setActiveObject(group);
                        canvas.renderAll();
                        saveCanvasState();
                        showToast("Text combination dropped onto canvas!");
                    }
                } else if (dropType === "shape") {
                    const shapeData = JSON.parse(data);
                    let shape;

                    const baseShapeWidth = originalCanvasWidth * 0.25;
                    const baseShapeHeight = originalCanvasHeight * 0.25;
                    const baseRadius = Math.min(baseShapeWidth, baseShapeHeight) / 2;

                    const commonOptions = {
                        left: pointer.x,
                        top: pointer.y,
                        opacity: 1,

                        transparentCorners: false,
                        hasControls: true,
                        hasBorders: true,
                        originX: "center",
                        originY: "center",
                    };

                    switch (shapeData.type) {
                        case "rect":
                            shape = new fabric.Rect(
                                $.extend(true, {}, commonOptions, {
                                    width: baseShapeWidth,
                                    height: baseShapeHeight,
                                    fill: shapeData.fill,
                                    stroke: shapeData.stroke,
                                    strokeWidth: shapeData.strokeWidth,
                                    rx: 5,
                                    ry: 5,
                                })
                            );
                            break;
                        case "circle":
                            shape = new fabric.Circle(
                                $.extend(true, {}, commonOptions, {
                                    radius: baseRadius,
                                    fill: shapeData.fill,
                                    stroke: shapeData.stroke,
                                    strokeWidth: shapeData.strokeWidth,
                                })
                            );
                            break;
                        case "triangle":
                            shape = new fabric.Triangle(
                                $.extend(true, {}, commonOptions, {
                                    width: baseShapeWidth,
                                    height: baseShapeHeight,
                                    fill: shapeData.fill,
                                    stroke: shapeData.stroke,
                                    strokeWidth: shapeData.strokeWidth,
                                })
                            );
                            break;
                        case "ellipse":
                            shape = new fabric.Ellipse(
                                $.extend(true, {}, commonOptions, {
                                    rx: baseShapeWidth / 2,
                                    ry: baseShapeHeight / 2,
                                    fill: shapeData.fill,
                                    stroke: shapeData.stroke,
                                    strokeWidth: shapeData.strokeWidth,
                                })
                            );
                            break;
                        case "line":
                            shape = new fabric.Line(
                                [
                                    pointer.x - baseShapeWidth / 2,
                                    pointer.y,
                                    pointer.x + baseShapeWidth / 2,
                                    pointer.y,
                                ],
                                $.extend(true, {}, commonOptions, {
                                    stroke: shapeData.stroke,
                                    strokeWidth: shapeData.strokeWidth || 5,
                                    fill: "transparent",
                                    left: pointer.x,
                                    top: pointer.y,
                                })
                            );
                            break;
                        case "polygon":
                            shape = new fabric.Polygon(
                                [
                                    {
                                        x: pointer.x - baseShapeWidth / 2,
                                        y: pointer.y - baseShapeHeight / 2,
                                    },
                                    {
                                        x: pointer.x + baseShapeWidth / 2,
                                        y: pointer.y - baseShapeHeight / 2,
                                    },
                                    {
                                        x: pointer.x + baseShapeWidth / 2,
                                        y: pointer.y + baseShapeHeight / 2,
                                    },
                                    {
                                        x: pointer.x - baseShapeWidth / 2,
                                        y: pointer.y + baseShapeHeight / 2,
                                    },
                                ],
                                $.extend(true, {}, commonOptions, {
                                    fill: shapeData.fill,
                                    stroke: shapeData.stroke,
                                    strokeWidth: shapeData.strokeWidth,
                                })
                            );
                            break;
                    }

                    if (shape) {
                        canvas.add(shape);
                        canvas.setActiveObject(shape);
                        canvas.renderAll();
                        saveCanvasState();
                        showToast(
                            `${shapeData.type.charAt(0).toUpperCase() +
                            shapeData.type.slice(1)
                            } added!`
                        );
                    }
                } else if (dropType === "public-design") {
                    const designIdToLoad = dt.getData("text/x-design-id");
                    const designNameToLoad = dt.getData("text/x-design-name");

                    showCustomModal(
                        "Import Design",
                        `Importing "${designNameToLoad}" will replace your current canvas content. Do you want to proceed?`,
                        `<button id="confirmImportDesignBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">Yes, Import</button>
            <button id="cancelImportDesignBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                    );

                    $("#confirmImportDesignBtn")
                        .off("click")
                        .on("click", function () {
                            $("#customModal").removeClass("flex").addClass("hidden");
                            showGlobalLoader(); // Show loader during import process

                            $.ajax({
                                url: `/api/design/${designIdToLoad}`,
                                type: "GET",
                                success: function (response) {
                                    if (response.canvas) {
                                        const canvasData = response.canvas;

                                        // Update global original dimensions based on imported design
                                        originalCanvasWidth = canvasData.width;
                                        originalCanvasHeight = canvasData.height;

                                        // Recalculate currentZoomLevel to fit the new design
                                        const mainContentArea =
                                            document.getElementById("main-content-area");
                                        if (mainContentArea) {
                                            const containerWidth = mainContentArea.clientWidth;
                                            const containerHeight = mainContentArea.clientHeight;

                                            const horizontalPadding = 30;
                                            const topPadding = 10;
                                            const bottomPadding = 10;

                                            const effectiveContainerWidth =
                                                containerWidth - horizontalPadding;
                                            const effectiveContainerHeight =
                                                containerHeight - (topPadding + bottomPadding);

                                            const scaleX =
                                                effectiveContainerWidth / originalCanvasWidth;
                                            const scaleY =
                                                effectiveContainerHeight / originalCanvasHeight;

                                            let fitZoom = Math.min(scaleX, scaleY);
                                            const zoomOutFactor = 0.83;
                                            fitZoom *= zoomOutFactor;

                                            currentZoomLevel = fitZoom; // Set currentZoomLevel to fit the new design
                                        }

                                        canvas.loadFromJSON(canvasData, function () {
                                            // Ensure all objects are rendered on the canvas after loading.
                                            canvas.renderAll();

                                            // Re-adjust canvas view based on new dimensions and zoom level.
                                            resizeCanvas();

                                            saveCanvasState();

                                            // Update object toolbar and floating controls based on active object.
                                            const activeObject = canvas.getActiveObject();
                                            if (activeObject) {
                                                updateObjectToolbar(activeObject);
                                                updateFloatingControls(activeObject);
                                            } else {
                                                // If no object is active after load, ensure toolbars are hidden.
                                                updateObjectToolbar(null);
                                                updateFloatingControls(null);
                                            }

                                            // Reset URL to indicate a new, unsaved design
                                            const newUrl = `${window.location.origin}/design/`;
                                            window.history.pushState({ path: newUrl }, "", newUrl);

                                            // Clear the design name input to reflect it's a new unsaved design
                                            $("#designName").val("Untitled Design");

                                            showToast(
                                                `Design "${designNameToLoad}" imported successfully!`
                                            );
                                            hideGlobalLoader();
                                        });
                                    } else {
                                        showToast(
                                            "Error: No canvas data found in the imported design.",
                                            3000
                                        );
                                        hideGlobalLoader();
                                    }
                                },
                                error: function (xhr, status, error) {
                                    showToast(
                                        "Error importing design: " +
                                        (xhr.responseJSON ? xhr.responseJSON.message : error),
                                        3000
                                    );
                                    hideGlobalLoader();
                                },
                                complete: function () {
                                    // hideGlobalLoader() is handled in success/error callbacks
                                },
                            });
                        });

                    $("#cancelImportDesignBtn")
                        .off("click")
                        .on("click", function () {
                            $("#customModal").removeClass("flex").addClass("hidden");
                            showToast("Design import cancelled.");
                        });
                    return; // Stop further processing for public-design drops
                } else if (dropType === "icon") {
                    addIconToCanvasAtCoords(data, pointer.x, pointer.y);
                    showToast("Icon dropped onto canvas!");
                } else if (dropType === "uploaded-image") {
                    // This is for internal 'uploaded-image' type drops, not file drops from OS.
                    addUploadedImageToCanvas(data, pointer.x, pointer.y);
                    showToast("Uploaded image dropped onto canvas!");
                } else if (dropType === "pixabay-image") {
                    addImageToCanvas(data, pointer.x, pointer.y);
                    showToast("Image dropped onto canvas!");
                }

                else if (dropType === "ai-design") {
                    let designData = dt.getData("application/json") || dt.getData("text/plain");
                    try {
                        designData = JSON.parse(designData);
                        loadAIDesignToMainCanvas(designData);
                        showToast("AI Design dropped onto canvas!");
                    } catch (err) {
                        showToast("Failed to load dropped design.", 3000);
                        console.error("Error parsing AI Design data:", err);
                    }
                    return; // Stop further processing
                }

                // 3. Handle generic data drops (e.g., image URLs dragged from other tabs/websites)
                else if (data) {
                    fabric.Image.fromURL(
                        data,
                        function (img) {
                            if (img) {
                                const targetSizeRatio = 0.4;
                                const targetDimension =
                                    Math.min(originalCanvasWidth, originalCanvasHeight) *
                                    targetSizeRatio;
                                const scaleFactor = Math.min(
                                    targetDimension / img.width,
                                    targetDimension / img.height,
                                    1
                                );

                                img.set({
                                    scaleX: scaleFactor,
                                    scaleY: scaleFactor,
                                    left: pointer.x,
                                    top: pointer.y,
                                    originX: "center",
                                    originY: "center",

                                    transparentCorners: false,
                                    hasControls: true,
                                    hasBorders: true,
                                    isIcon: false,
                                });

                                canvas.add(img);
                                canvas.setActiveObject(img);
                                canvas.renderAll();
                                saveCanvasState();
                                showToast("External image URL dropped onto canvas!");
                            } else {
                                showToast(
                                    "Failed to add image to canvas. Please check the URL.",
                                    3000
                                );
                            }
                        },
                        {
                            crossOrigin: "anonymous",
                            onError: function (img, err) {
                                console.error(
                                    "Fabric.js Image loading error for dragged image:",
                                    err,
                                    "Image URL:",
                                    data
                                );
                                showToast(
                                    "Failed to load image for canvas. This might be due to a broken link or CORS issues.",
                                    5000
                                );
                            },
                        }
                    );
                }
            });

            // Dragstart for Header and Paragraph text elements
            $(
                '#text-content button[data-type="text-heading"], #text-content button[data-type="text-body"]'
            ).on("dragstart", function (e) {
                const defaultText = $(this).data("text");
                const headerType = $(this).data("header");
                e.originalEvent.dataTransfer.setData("text/plain", defaultText);
                e.originalEvent.dataTransfer.setData(
                    "text/x-type",
                    $(this).data("type")
                );
                e.originalEvent.dataTransfer.setData(
                    "text/x-text-content",
                    defaultText
                );
                e.originalEvent.dataTransfer.setData(
                    "text/x-header-type",
                    headerType
                );
                e.originalEvent.dataTransfer.setData("text/x-internal-drag", "true");
            });

            // Dragstart for shape elements
            $("#elements-content button").on("dragstart", function (e) {
                const shapeType = $(this).data("type");
                const fill = $(this).data("fill");
                const stroke = $(this).data("stroke");
                const strokeWidth = $(this).data("stroke-width");
                const shapeData = {
                    type: shapeType,
                    fill: fill,
                    stroke: stroke,
                    strokeWidth: strokeWidth,
                };
                e.originalEvent.dataTransfer.setData(
                    "text/plain",
                    JSON.stringify(shapeData)
                );
                e.originalEvent.dataTransfer.setData("text/x-type", "shape");
                e.originalEvent.dataTransfer.setData("text/x-internal-drag", "true");
            });

            $(".variable-draggable-item").on("dragstart", function (e) {
                const originalEvent = e.originalEvent;
                const variableTag = $(this).data("variable-tag");
                const variableName = $(this).text();

                originalEvent.dataTransfer.setData("text/plain", variableTag);
                originalEvent.dataTransfer.setData("text/x-type", "variable");
                originalEvent.dataTransfer.setData(
                    "text/x-variable-tag",
                    variableTag
                );
                originalEvent.dataTransfer.setData(
                    "text/x-variable-name",
                    variableName
                );
                originalEvent.dataTransfer.effectAllowed = "copy";
            });

            // Function to handle signature file upload
            async function handleSignatureFileUpload(file, $container) {
                const $previewContainer = $container.find(
                    ".signature-image-preview-container"
                );
                const $previewImg = $container.find(".signature-image-preview");
                const $uploadArea = $container.find(".signature-upload-area");
                const $urlInput = $container.find(".signature-image-url");

                showGlobalLoader();

                try {
                    const formData = new FormData();
                    formData.append("file", file);
                    const response = await $.ajax({
                        url: "/api/files/upload/", // Use your general file upload endpoint
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                    });

                    if (response.file && response.file.url) {
                        $urlInput.val(response.file.url);
                        $previewImg.attr("src", response.file.url);
                        $previewContainer.removeClass("hidden");
                        $uploadArea.addClass("hidden");
                        showToast("Signature image uploaded successfully!");
                    } else {
                        showToast("Signature upload failed. No URL returned.", 3000);
                    }
                } catch (error) {
                    showToast(
                        `Signature upload failed: ${error.responseText
                            ? JSON.parse(error.responseText).error
                            : error.message
                        }`,
                        3000
                    );
                } finally {
                    hideGlobalLoader();
                }
            }

            // Event listener to trigger file input click for Automatic tab logo
            $(document).on("click", ".browse-bg-files-button", function () {
                $(this).siblings(".logo-file-upload-input").click();
            });

            // Event listener to trigger file input click for Manual tab logo
            $(document).on(
                "click",
                ".manual-browse-bg-files-button",
                function () {
                    $(this).siblings(".manual-logo-file-upload-input").click();
                }
            );

            // Function to open existing files modal for signatures
            function openExistingSignatureFilesModal($container) {
                // Pass the specific signature container
                showCustomModal(
                    "Select Existing Signature",
                    `<div style="scrollbar-width: thin; scrollbar-color: #9ca3af #374151;" id="existingSignatureFilesList" class="grid grid-cols-3 gap-2 overflow-y-auto max-h-96">
                    <div id="existingSignatureFilesLoading" class="text-center col-span-3 py-4">
                        <div class="spinner-border text-blue-500" role="status"></div>
                    </div>
                </div>`,
                    `<button id="closeExistingSignatureFilesModal" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Close</button>`
                );

                const $existingFilesList = $("#existingSignatureFilesList");
                $("#existingSignatureFilesLoading").removeClass("hidden");

                $.ajax({
                    url: `/api/files/images?tags=signature`, // Assuming you tag signature images
                    method: "GET",
                    success: function (data) {
                        $existingFilesList.empty();
                        if (data.length === 0) {
                            $existingFilesList.html(
                                '<p class="text-gray-500 text-center col-span-3">No existing signature images found.</p>'
                            );
                        } else {
                            data.forEach((file) => {
                                const $fileItem = $(`
                                <div class="relative group rounded-md overflow-hidden cursor-pointer existing-file-item" data-url="${file.url}">
                                    <img src="${file.url}" alt="Signature Image" class="w-full h-20 object-contain p-1">
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                        <i class="fas fa-check-circle text-white text-3xl"></i>
                                    </div>
                                </div>
                            `);
                                $existingFilesList.append($fileItem);
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        $existingFilesList.html(
                            `<p class="text-red-400 text-center col-span-3">Error loading files: ${error}</p>`
                        );
                    },
                    complete: function () {
                        $("#existingSignatureFilesLoading").addClass("hidden");
                    },
                });


                $existingFilesList
                    .off("click")
                    .on("click", ".existing-file-item", function () {
                        const selectedUrl = $(this).data("url");

                        // Use the passed $container to find the correct signature elements
                        $container.find(".signature-image-url").val(selectedUrl);
                        $container
                            .find(".signature-image-preview")
                            .attr("src", selectedUrl);
                        $container
                            .find(".signature-image-preview-container")
                            .removeClass("hidden");
                        $container.find(".signature-upload-area").addClass("hidden");

                        showToast("Signature selected successfully!");
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });

                $("#closeExistingSignatureFilesModal")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            }

            // Event delegation for dynamically added signature inputs
            $signaturesContainer.on(
                "click",
                ".browse-signature-files-button",
                function () {
                    $(this)
                        .closest(".mb-4")
                        .find(".signature-file-upload-input")
                        .click();
                }
            );

            $signaturesContainer.on(
                "change",
                ".signature-file-upload-input",
                function (e) {
                    if (e.target.files.length > 0) {
                        handleSignatureFileUpload(
                            e.target.files[0],
                            $(this).closest(".mb-4")
                        );
                    }
                }
            );

            $signaturesContainer.on(
                "click",
                ".select-existing-signature-btn",
                function () {
                    openExistingSignatureFilesModal($(this).closest(".mb-4"));
                }
            );

            $signaturesContainer.on(
                "click",
                ".remove-signature-image-btn",
                function () {
                    const $container = $(this).closest(".mb-4");
                    $container.find(".signature-image-url").val("");
                    $container.find(".signature-image-preview").attr("src", "");
                    $container
                        .find(".signature-image-preview-container")
                        .addClass("hidden");
                    $container.find(".signature-upload-area").removeClass("hidden");
                    showToast("Signature image removed.");
                }
            );

            // Drag and drop for signature upload areas
            $signaturesContainer.on(
                "dragenter dragover",
                ".signature-upload-area",
                function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $(this).addClass("border-blue-500");
                }
            );

            $signaturesContainer.on(
                "dragleave drop",
                ".signature-upload-area",
                function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $(this).removeClass("border-blue-500");
                }
            );

            $signaturesContainer.on("drop", ".signature-upload-area", function (e) {
                const dt = e.originalEvent.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleSignatureFileUpload(files[0], $(this).closest(".mb-4"));
                }
            });

            /**
             * Helper function to download canvas as image.
             */
            async function downloadCanvas(format, dpi = 96) {
                if (!canvas) {
                    showToast("Canvas not ready!", 2000);
                    return;
                }

                // Show the loader before starting the heavy-duty task.
                showGlobalLoader();

                // Use a short delay to ensure the loader has time to render.
                await new Promise(resolve => setTimeout(resolve, 50));

                try {
                    // Calculate the multiplier based on the desired DPI.
                    const multiplier = dpi / 96;
                    let quality = 1.0;

                    // Reduce quality for JPEGs, especially for high-res downloads, to lower the file size.
                    if (format === 'jpeg' && dpi === 300) {
                        quality = 0.8;
                    }

                    // Use the multiplier directly in toDataURL to get a high-res image.
                    const dataURL = canvas.toDataURL({
                        format: format,
                        quality: quality,
                        multiplier: multiplier,
                    });

                    // Create a temporary link to trigger the download
                    const link = document.createElement("a");
                    link.download = `mixcertificate-design.${format}`;
                    link.href = dataURL;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showToast(`Design downloaded as ${format.toUpperCase()}!`);
                } catch (error) {
                    console.error("Download failed:", error);
                    showToast("An error occurred during download.", 3000);
                } finally {
                    // Always hide the loader, even if an error occurred.
                    hideGlobalLoader();
                }
            }
            async function downloadPdf() {
                if (!canvas) {
                    showToast("Canvas not ready!", 2000);
                    return;
                }

                try {
                    // This will now work without the error because the canvas is no longer tainted.
                    const imageData = canvas.toDataURL({
                        format: 'jpeg', // Or 'png'
                        quality: 0.8
                    });

                    // Create a new jsPDF instance
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });

                    // Add the canvas image to the PDF
                    pdf.addImage(imageData, 'JPEG', 0, 0, canvas.width, canvas.height);

                    // Save the PDF
                    pdf.save('mixcertificate-design.pdf');

                    showToast("Design downloaded as PDF!");
                } catch (error) {
                    console.error("PDF download failed:", error);
                    // The error here would likely be the 'Tainted canvases' error
                    // if the root cause hasn't been fixed.
                    showToast("An error occurred during PDF download.", 3000);
                }
            }
            // --- Button Event Listeners ---
            // Download PNG (standard 96 DPI).
            $("#downloadPngBtn, #downloadPngBtn-mobile").on("click", function (e) {
                e.preventDefault();
                downloadCanvas("png");
            });

            // Download JPEG (standard 96 DPI).
            $("#downloadJpegBtn, #downloadJpegBtn-mobile").on("click", function (e) {
                e.preventDefault();
                downloadCanvas("jpeg");
            });

            // Download PNG for print (300 DPI).
            $("#printDownloadPngBtn, #printDownloadPngBtn-mobile").on("click", function (e) {
                e.preventDefault();
                downloadCanvas("png", 300);
            });

            // Download JPEG for print (300 DPI).
            $("#printDownloadJpegBtn, #printDownloadJpegBtn-mobile").on("click", function (e) {
                e.preventDefault();
                downloadCanvas("jpeg", 300);
            });

            $("#zoomSlider").on("input", function () {
                currentZoomLevel = parseFloat($(this).val());
                applyCanvasTransformations();
                // Update the text display next to the slider to show percentage.
                $("#zoomValue").text(Math.round(currentZoomLevel * 100) + "%");
            });

            // Initial resize and on window resize.
            $(window).on("resize", resizeCanvas);

            // IMPORTANT FIX: Call resizeCanvas when the Fabric.js canvas is fully ready
            canvas.on("canvas:ready", resizeCanvas);

            // Call it once initially, but ensure it runs after the canvas is fully set up
            resizeCanvas();

            $.contextMenu({
                selector: "canvas",
                callback: function (key, options) {
                    var activeObject = canvas.getActiveObject();

                    if (!activeObject && key !== "paste") {
                        return;
                    }

                    switch (key) {
                        case "copy":
                            if (activeObject) {
                                copiedObject = fabric.util.object.clone(activeObject);
                            }
                            break;
                        case "copyStyle":
                            if (activeObject) {
                                copiedObjectStyle = {
                                    fill: activeObject.fill,
                                    stroke: activeObject.stroke,
                                    strokeWidth: activeObject.strokeWidth,
                                    fontFamily: activeObject.fontFamily,
                                    fontSize: activeObject.fontSize,
                                    fontWeight: activeObject.fontWeight,
                                    fontStyle: activeObject.fontStyle,
                                    textDecoration: activeObject.textDecoration,
                                };
                            }
                            break;
                        case "paste":
                            if (copiedObject) {
                                copiedObject.clone(function (cloned) {
                                    cloned.set({
                                        left: cloned.left + 20,
                                        top: cloned.top + 20,
                                        evented: true,
                                        selectable: true,
                                    });
                                    canvas.add(cloned);
                                    canvas.setActiveObject(cloned);
                                    canvas.renderAll();
                                    saveCanvasState();
                                });
                            }
                            break;
                        case "pasteStyle":
                            if (activeObject && copiedObjectStyle) {
                                activeObject.set(copiedObjectStyle);
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "duplicate":
                            if (activeObject) {
                                activeObject.clone(function (cloned) {
                                    cloned.set({
                                        left: cloned.left + 20,
                                        top: cloned.top + 20,
                                        evented: true,
                                        selectable: true,
                                    });
                                    canvas.add(cloned);
                                    canvas.setActiveObject(cloned);
                                    canvas.renderAll();
                                    saveCanvasState();
                                });
                            }
                            break;
                        case "delete":
                            if (activeObject) {
                                canvas.remove(activeObject);
                                canvas.discardActiveObject();
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "lock":
                            if (activeObject) {
                                activeObject.set({
                                    selectable: false,
                                    evented: false,
                                    hasControls: false,
                                    hasBorders: false,
                                    lockMovementX: true,
                                    lockMovementY: true,
                                    lockRotation: true,
                                    lockScalingX: true,
                                    lockScalingY: true,
                                });
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "unlock":
                            if (activeObject) {
                                activeObject.set({
                                    selectable: true,
                                    evented: true,
                                    hasControls: true,
                                    hasBorders: true,
                                    lockMovementX: false,
                                    lockMovementY: false,
                                    lockRotation: false,
                                    lockScalingX: false,
                                    lockScalingY: false,
                                });
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "alignToPage":
                            if (activeObject) {
                                var scaledWidth = activeObject.getScaledWidth();
                                var scaledHeight = activeObject.getScaledHeight();

                                activeObject.set({
                                    left: canvas.width / 2 - scaledWidth / 2,
                                    top: canvas.height / 2 - scaledHeight / 2,
                                });
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "setAsBackground":
                            if (activeObject && activeObject.type === "image") {
                                const imageUrl = activeObject.getSrc();

                                if (!imageUrl) {
                                    console.error(
                                        "Active object does not have a valid image source URL."
                                    );
                                    showToast(
                                        "Failed to set background: Image source not found.",
                                        5000
                                    );
                                    return;
                                }

                                canvas.remove(activeObject);
                                canvas.discardActiveObject();
                                canvas.renderAll();

                                showToast("Setting image as background...", 0);

                                fabric.Image.fromURL(
                                    imageUrl,
                                    function (img) {
                                        if (img) {
                                            const scaleX = canvas.width / img.width;
                                            const scaleY = canvas.height / img.height;
                                            const scale = Math.max(scaleX, scaleY);

                                            // Calculate position to center the scaled image
                                            const left = (canvas.width - img.width * scale) / 2;
                                            const top = (canvas.height - img.height * scale) / 2;

                                            canvas.setBackgroundImage(
                                                img,
                                                function () {
                                                    canvas.renderAll();
                                                    saveCanvasState();
                                                    showToast(
                                                        "Image set as background successfully!",
                                                        3000
                                                    );
                                                },
                                                {
                                                    scaleX: scale,
                                                    scaleY: scale,
                                                    top: top,
                                                    left: left,
                                                    originX: "left",
                                                    originY: "top",
                                                    crossOrigin: "anonymous",
                                                }
                                            );
                                        } else {
                                            console.error(
                                                "Fabric.js failed to create image object from URL:",
                                                imageUrl
                                            );
                                            showToast(
                                                "Failed to set background: Could not load image.",
                                                5000
                                            );
                                        }
                                    },
                                    {
                                        crossOrigin: "anonymous",
                                        onError: function (obj, err) {
                                            console.error(
                                                "Fabric.js Image loading error for background:",
                                                err,
                                                "Image URL:",
                                                imageUrl
                                            );
                                            showToast(
                                                "Failed to set background: This might be due to a broken link or CORS issues.",
                                                5000
                                            );
                                        },
                                    }
                                );
                            } else if (activeObject) {
                                showToast(
                                    "Only image objects can be set as background.",
                                    3000
                                );
                            }
                            break;

                        case "bringForward":
                            if (activeObject) {
                                canvas.bringForward(activeObject);
                                canvas.discardActiveObject();
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "sendBackwards":
                            if (activeObject) {
                                canvas.sendBackwards(activeObject);
                                canvas.discardActiveObject();
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "bringToFront":
                            if (activeObject) {
                                canvas.bringToFront(activeObject);
                                canvas.discardActiveObject();
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "sendToBack":
                            if (activeObject) {
                                canvas.sendToBack(activeObject);
                                canvas.discardActiveObject();
                                canvas.renderAll();
                                saveCanvasState();
                            }
                            break;
                        case "link":
                            if (activeObject) {
                                var link = prompt(
                                    "Enter a link for the object (e.g., https://example.com):"
                                );
                                if (link) {
                                    activeObject.set({ link: link });
                                    canvas.renderAll();
                                    saveCanvasState();
                                    showToast("Link added to object!");
                                }
                            }
                            break;
                    }
                },
                items: {
                    copy: { name: "Copy " },
                    paste: { name: "Paste " },
                    duplicate: { name: "Duplicate" },
                    copyStyle: { name: "Copy Style" },
                    pasteStyle: { name: "Paste Style" },
                    delete: { name: "Delete" },
                    sep1: "---------",
                    bringForward: { name: "Bring Forward" },
                    sendBackwards: { name: "Send Backwards" },
                    bringToFront: { name: "Bring To Front" },
                    sendToBack: { name: "Send To Back" },
                    sep2: "---------",
                    lock: { name: "Lock" },
                    unlock: { name: "Unlock" },
                    alignToPage: { name: "Align to Page" },
                    link: { name: "Add Link" },
                    setAsBackground: { name: "Set Image as Background" },
                },
            });

            var noteTooltip = $("<div>", {
                id: "noteTooltip",
                class: "d-none bg-light p-2 border rounded shadow",
                text: "Add a note",
            }).appendTo("body");

            $(document).on("mousemove", function (e) {
                noteTooltip.css({
                    left: e.pageX + 10 + "px",
                    top: e.pageY + 10 + "px",
                });
            });

            canvas.on("mouse:down", function (opt) {
                var evt = opt.e;
                if (evt.button === 3) {
                    evt.preventDefault();
                    var pointer = canvas.getPointer(evt);
                    canvas.setActiveObject(canvas.findTarget(pointer));
                    canvas.renderAll();
                }
            });

            // Mobile menu toggle.
            $("#mobile-menu-button").on("click", function () {
                $("#mobile-menu-dropdown").slideToggle();
            });

            // General dropdown toggle logic for mobile.
            $("#downloadDropdown-mobile").on("click", function () {
                $(this).next("ul").slideToggle();
            });
            $("#dropdownMenuButton-mobile").on("click", function () {
                $(this).next("ul").slideToggle();
            });

            // Fullscreen toggle.
            $("#fullscreenToggle").on("click", function () {
                const mainContentArea = document.getElementById("main-content-area");
                if (!document.fullscreenElement) {
                    if (mainContentArea.requestFullscreen) {
                        mainContentArea
                            .requestFullscreen()
                            .then(() => {
                                resizeCanvas();
                            })
                            .catch((err) => {
                                showToast(
                                    `Error attempting to enable full-screen mode: ${err.message} (${err.name})`,
                                    4000
                                );
                            });
                    }
                } else {
                    if (document.exitFullscreen) {
                        document
                            .exitFullscreen()
                            .then(() => {
                                resizeCanvas();
                            })
                            .catch((err) => {
                                showToast(
                                    `Error attempting to exit full-screen mode: ${err.message} (${err.name})`,
                                    4000
                                );
                            });
                    }
                }
            });

            // Listens for fullscreen change events to update the button icon and canvas size.
            document.addEventListener("fullscreenchange", () => {
                const fullscreenIcon = $("#fullscreenToggle i");
                if (document.fullscreenElement) {
                    fullscreenIcon.text("fullscreen_exit");
                } else {
                    fullscreenIcon.text("fullscreen");
                }
                resizeCanvas();
            });

            // Activate Design menu by default on load
            $('#sidebar button[data-target="#design-content"]').trigger("click");

            /**
             * Uploads canvas image.
             */
            const uploadImage = (dataURL) => {
                return new Promise((resolve, reject) => {
                    const byteString = atob(dataURL.split(",")[1]);
                    const mimeString = dataURL
                        .split(",")[0]
                        .split(":")[1]
                        .split(";")[0];
                    const arrayBuffer = new ArrayBuffer(byteString.length);
                    const intArray = new Uint8Array(arrayBuffer);

                    for (let i = 0; i < byteString.length; i++) {
                        intArray[i] = byteString.charCodeAt(i);
                    }

                    const blob = new Blob([arrayBuffer], { type: mimeString });
                    const formData = new FormData();
                    formData.append("file", blob, "design.jpg");

                    $.ajax({
                        url: "/api/files/upload/designs",
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        beforeSend: function () {
                            showGlobalLoader(); // Show loader for image upload
                        },
                        success: function (response) {
                            if (response.file && response.file.url) {
                                resolve(response.file.url);
                            } else {
                                reject("File upload failed. No URL returned.");
                            }
                        },
                        error: function (xhr, status, error) {
                            reject(`Image upload failed: ${error}`);
                        },
                        complete: function () {
                            hideGlobalLoader(); // Hide loader after image upload
                        },
                    });
                });
            };

            /**
             * Uploads the current canvas content as an image.
             */
            const uploadCanvasImage = () => {
                return new Promise(async (resolve, reject) => {
                    try {
                        const dataURL = canvas.toDataURL({ format: "jpeg", quality: 1 });
                        const fileUrl = await uploadImage(dataURL);
                        resolve(fileUrl);
                    } catch (error) {
                        reject(`Error uploading canvas image: ${error}`);
                    }
                });
            };



            // Loads design data if designId exists in the URL.

            function loadDesignIfExists() {
                var currentUrl = window.location.href;
                var designIdMatch = currentUrl.match(/\/design\/(\w+)/);
                var designId = designIdMatch ? designIdMatch[1] : null;

                if (designId) {
                    $.ajax({
                        url: `/api/design/${designId}`,
                        type: "GET",
                        beforeSend: function () {
                            // Show global loader BEFORE starting the AJAX request
                            showGlobalLoader();
                        },
                        success: function (response) {
                            if (response.canvas) {
                                var canvasData = response.canvas;

                                if (canvasData.width && canvasData.height) {
                                    // Update global variables for original dimensions
                                    originalCanvasWidth = canvasData.width;
                                    originalCanvasHeight = canvasData.height;
                                    // Reset currentZoomLevel so it gets recalculated to fit the new dimensions
                                    currentZoomLevel = null;
                                }

                                // Load the canvas from JSON data.
                                // The callback function ensures actions happen AFTER the canvas objects are loaded.
                                canvas.loadFromJSON(canvasData, function () {
                                    // Ensure all objects are rendered on the canvas.
                                    canvas.renderAll();
                                    updateObjectControls();
                                    // Resize the canvas and apply transformations based on the new dimensions.
                                    resizeCanvas(); // This will now use the correctly set currentZoomLevel
                                    // Save the current state to the undo/redo history.
                                    saveCanvasState();

                                    // Update object toolbar and floating controls based on active object.
                                    const activeObject = canvas.getActiveObject();
                                    if (activeObject) {
                                        updateObjectToolbar(activeObject);
                                        updateFloatingControls(activeObject);
                                    } else {
                                        // If no object is active after load, ensure toolbars are hidden.
                                        updateObjectToolbar(null);
                                        updateFloatingControls(null);
                                    }
                                    // HIDE THE GLOBAL LOADER *AFTER* EVERYTHING IS RENDERED AND UI IS UPDATED.
                                    hideGlobalLoader();
                                });

                                $("#designName").val(response.designName);
                            } else {
                                // If no canvas data is returned in the response, hide the loader.
                                hideGlobalLoader();
                            }
                        },
                        error: function (xhr, status, error) {
                            showToast("Error loading design. Please try again.", 3000);
                            // Hide the loader even if there's an error.
                            hideGlobalLoader();
                        },
                    });
                } else {
                    // If no design ID in the URL, save the initial empty canvas state.
                    saveCanvasState();
                    // Ensure loader is hidden if no design is loaded (e.g., new design page).
                    hideGlobalLoader();
                }
            }


            // Call this function to check for designId and load data
            loadDesignIfExists();

            function saveCanvas(isPublic) {
                var $saveButton = $("#saveCanvas");
                var $saveButtonMobile = $("#saveCanvas-mobile");
                $saveButton.html(
                    '<span class="spinner-border savespiner" role="status" aria-hidden="true"></span> Saving...'
                );
                $saveButton.prop("disabled", true);
                $saveButtonMobile.html(
                    '<span class="spinner-border savespiner" role="status" aria-hidden="true"></span> Saving...'
                );
                $saveButtonMobile.prop("disabled", true);

                var currentUrl = window.location.href;
                var designIdMatch = currentUrl.match(/\/design\/(\w+)/);
                var designId = designIdMatch ? designIdMatch[1] : null;

                var designName = $("#designName").val() || "Untitled Design";
                var canvasData = canvas.toJSON();
                canvasData.width = originalCanvasWidth;
                canvasData.height = originalCanvasHeight;

                uploadCanvasImage()
                    .then((imageUrl) => {
                        var requestData = JSON.stringify({
                            designName: designName,
                            imageURL: imageUrl,
                            canvas: canvasData,
                            isPublic: isPublic,
                        });

                        if (designId) {
                            $.ajax({
                                url: `/api/design/${designId}`,
                                type: "PUT",
                                contentType: "application/json",
                                data: requestData,
                                success: function (response) {
                                    showToast("Design saved successfully!");

                                    $saveButton.html('<i class="fas fa-save mr-2"></i>Save');
                                    $saveButton.prop("disabled", false);
                                    $saveButtonMobile.html(
                                        '<i class="fas fa-save mr-2"></i>Save'
                                    );
                                    $saveButtonMobile.prop("disabled", false);
                                },
                                error: function (xhr, status, error) {
                                    console.error(
                                        "Error saving design (PUT):",
                                        error,
                                        "Status:",
                                        status,
                                        "XHR:",
                                        xhr
                                    ); // LOGGING ERROR
                                    showToast("Error saving design. Please try again.", 3000);
                                    // Reset button state
                                    $saveButton.html('<i class="fas fa-save mr-2"></i>Save');
                                    $saveButton.prop("disabled", false);
                                    $saveButtonMobile.html(
                                        '<i class="fas fa-save mr-2"></i>Save'
                                    );
                                    $saveButtonMobile.prop("disabled", false);
                                },
                            });
                        } else {
                            $.ajax({
                                url: "/api/design/",
                                type: "POST",
                                contentType: "application/json",
                                data: requestData,
                                success: function (response) {
                                    var newTemplateId = response._id;
                                    var newUrl = `${window.location.origin}/design/${newTemplateId}`;
                                    window.history.pushState({ path: newUrl }, "", newUrl);
                                    showToast("Design created and saved successfully!");
                                    // Reset button state
                                    $saveButton.html('<i class="fas fa-save mr-2"></i>Save');
                                    $saveButton.prop("disabled", false);
                                    $saveButtonMobile.html(
                                        '<i class="fas fa-save mr-2"></i>Save'
                                    );
                                    $saveButtonMobile.prop("disabled", false);
                                },
                                error: function (xhr, status, error) {
                                    console.error(
                                        "Error creating design (POST):",
                                        error,
                                        "Status:",
                                        status,
                                        "XHR:",
                                        xhr
                                    ); // LOGGING ERROR
                                    showToast("Error creating design. Please try again.", 3000);
                                    // Reset button state
                                    $saveButton.html('<i class="fas fa-save mr-2"></i>Save');
                                    $saveButton.prop("disabled", false);
                                    $saveButtonMobile.html(
                                        '<i class="fas fa-save mr-2"></i>Save'
                                    );
                                    $saveButtonMobile.prop("disabled", false);
                                },
                            });
                        }
                    })
                    .catch((error) => {
                        console.error(
                            "Error during save process (image upload failed):",
                            error
                        );
                        showToast(
                            "An error occurred during save. Please try again.",
                            3000
                        );
                        // Reset button state
                        $saveButton.html('<i class="fas fa-save mr-2"></i>Save');
                        $saveButton.prop("disabled", false);
                        $saveButtonMobile.html('<i class="fas fa-save mr-2"></i>Save');
                        $saveButtonMobile.prop("disabled", false);
                    });
            }

            // New event listener for the desktop Save button
            $("#saveDesignBtn").on("click", function (e) {
                e.preventDefault();
                const isPublic = $("#savePubliclyCheckbox").prop("checked");
                saveCanvas(isPublic);
            });

            // New event listener for the mobile Save button
            $("#saveDesignBtn-mobile").on("click", function (e) {
                e.preventDefault();
                const isPublic = $("#savePubliclyCheckbox").prop("checked");
                saveCanvas(isPublic);
            });

            // New: Automatically save when 'Save Publicly' checkbox is toggled
            $("#savePubliclyCheckbox").on("change", function () {
                const isPublic = $(this).prop("checked");
                showToast(`Saving design as ${isPublic ? "public" : "private"}...`);
                saveCanvas(isPublic); // This directly calls saveCanvas with the public status
            });
        });

        //  Opens the editor with specified canvas dimensions.

        function openEditor(type) {
            let width, height;
            switch (type) {
                case "horizontal":
                    width = 3508;
                    height = 2481;
                    break;
                case "vertical":
                    width = 2481;
                    height = 3508;
                    break;
                case "badge":
                    width = 300;
                    height = 300;
                    break;
            }
            window.open(`/design/?width=${width}&height=${height}`, "_blank");
        }

        // Creates a custom design with user-defined width and height.

        function createCustomDesign() {
            const width = document.getElementById("customWidth").value;
            const height = document.getElementById("customHeight").value;
            if (width && height) {
                window.open(`/design/?width=${width}&height=${height}`, "_blank");
            } else {
                showToast("Please enter both width and height!", 2000);
            }
        }

        // Add a global paste event listener to handle pasting external images
        $(document).on("paste", function (e) {
            const targetNodeName = e.target.nodeName;
            if (
                targetNodeName === "INPUT" ||
                targetNodeName === "TEXTAREA" ||
                e.target.isContentEditable
            ) {
                return; // Do not proceed with canvas paste logic
            }

            const clipboardData =
                e.originalEvent.clipboardData || window.clipboardData;
            if (!clipboardData) {
                showToast("Clipboard data not available.", 2000);
                return;
            }

            // Check if clipboard contains image data
            for (let i = 0; i < clipboardData.items.length; i++) {
                const item = clipboardData.items[i];
                if (item.type.indexOf("image") !== -1) {
                    e.preventDefault(); // Prevent default paste behavior (e.g., pasting into an input field)
                    const blob = item.getAsFile();
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        const imageUrl = event.target.result;
                        // Get the mouse pointer coordinates if available, otherwise center it
                        const pointer = canvas.getPointer(e.originalEvent);
                        const pasteX = pointer.x;
                        const pasteY = pointer.y;

                        fabric.Image.fromURL(
                            imageUrl,
                            function (img) {
                                if (img) {
                                    // Scale down large images to fit within canvas
                                    const maxDim = Math.min(
                                        originalCanvasWidth * 0.5,
                                        originalCanvasHeight * 0.5
                                    );
                                    const scaleFactor = Math.min(
                                        maxDim / img.width,
                                        maxDim / img.height,
                                        1
                                    ); // Max scale 1 to prevent upsizing small images

                                    img.set({
                                        scaleX: scaleFactor,
                                        scaleY: scaleFactor,
                                        left: pasteX,
                                        top: pasteY,
                                        originX: "center",
                                        originY: "center",

                                        transparentCorners: false,
                                        hasControls: true,
                                        hasBorders: true,
                                        isIcon: false, // Assume pasted images are not icons
                                    });

                                    canvas.add(img);
                                    canvas.setActiveObject(img);
                                    canvas.renderAll();
                                    saveCanvasState();
                                    showToast("Image pasted onto canvas!");
                                } else {
                                    showToast("Failed to add pasted image to canvas.", 3000);
                                }
                            },
                            {
                                crossOrigin: "anonymous", // Important for loading data URLs
                                onError: function (img, err) {
                                    console.error(
                                        "Fabric.js Image loading error for pasted image:",
                                        err
                                    );
                                    showToast(
                                        "Failed to load pasted image. Please try again.",
                                        5000
                                    );
                                },
                            }
                        );
                    };
                    reader.readAsDataURL(blob);
                    return; // Exit loop after handling the first image
                }
            }
            // If no image data, and a text object is active and in editing mode, let the browser handle text paste
            const activeObject = canvas.getActiveObject();
            if (
                activeObject &&
                (activeObject.type === "i-text" ||
                    activeObject.type === "text" ||
                    activeObject.type === "textbox") &&
                activeObject.isEditing
            ) {
                // Let the browser handle the paste event for the text content
                return;
            }
            // If no image and no active text object in editing mode, try to paste as a new text object
            const pastedText = clipboardData.getData("text");
            if (pastedText) {
                e.preventDefault();
                const textObject = new fabric.Textbox(pastedText, {
                    left: canvas.width / 2,
                    top: canvas.height / 2,
                    fontFamily: "Roboto",
                    fontSize: 24,
                    fontWeight: "normal",
                    fill: "#000000",
                    width: 300,
                    originX: "center",
                    textAlign: "left",
                    editable: true,
                    selectable: true,
                });
                canvas.add(textObject);
                canvas.setActiveObject(textObject);
                canvas.renderAll();
                saveCanvasState();
                showToast("Text pasted onto canvas!");
            }
        });
        var iconPage = 1;
        var iconQuery = "";
        var iconLoading = false;

        // Search Iconfinder function.

        function searchIconfinder(query, page) {
            if (iconLoading) return;
            iconLoading = true;

            $("#iconLoading").removeClass("hidden"); // Show loading spinner

            $.ajax({
                url: `/api/iconfinder?query=${query}&limit=60&page=${page}`,
                method: "GET",
                success: function (data) {
                    displayIconResults(data.icons);
                    iconLoading = false;
                    $("#iconLoading").addClass("hidden"); // Hide loading spinner
                },
                error: function (err) {
                    console.error("Error fetching Iconfinder icons:", err);
                    iconLoading = false;
                    $("#iconLoading").addClass("hidden"); // Hide loading spinner
                },
            });
        }

        /**
         * Function to get the best preview URL (smaller image for preview).
         */
        function getBestPreviewUrl(rasterSizes) {
            var bestSize = rasterSizes.find((size) => size.size === 64); // Prefer 64x64 for preview
            if (!bestSize) {
                bestSize = rasterSizes[rasterSizes.length - 1]; // Fallback to largest available size
            }
            if (bestSize && bestSize.formats && bestSize.formats.length > 0) {
                return bestSize.formats[0].preview_url;
            }
            return null;
        }

        /**
         * Function to get the best download URL (larger image for canvas).
         */
        function getBestDownloadUrl(rasterSizes) {
            var bestSize = rasterSizes.find((size) => size.size >= 512); // Prefer 512x512 or larger for high quality
            if (!bestSize) {
                bestSize = rasterSizes[rasterSizes.length - 1]; // Fallback to largest available size
            }
            if (bestSize && bestSize.formats && bestSize.formats.length > 0) {
                return bestSize.formats[0].download_url;
            }
            return null;
        }

        // Updated addIconToCanvasAtCoords function
        function addIconToCanvasAtCoords(iconUrl, x, y) {
            fabric.loadSVGFromURL(
                iconUrl,
                function (objects, options) {
                    if (!objects || objects.length === 0) {
                        console.error("No SVG objects loaded from URL: ", iconUrl);
                        return;
                    }

                    let svgObject;
                    if (objects.length > 1) {
                        svgObject = fabric.util.groupSVGElements(objects, options);
                    } else {
                        svgObject = objects[0];
                        if (options) {
                            svgObject.set(options);
                        }
                    }

                    if (!svgObject) {
                        console.error(
                            "SVG Object failed to be created from URL: ",
                            iconUrl
                        );
                        return;
                    }

                    svgObject.set({
                        left: x,
                        top: y,
                        originX: "left",
                        originY: "top",
                        hasControls: true,
                        hasBorders: true,
                        selectable: true,
                        evented: true,
                        isIcon: true,
                    });

                    try {
                        svgObject.setOriginX("left");
                        svgObject.setOriginY("top");
                    } catch (e) {
                        console.error(
                            "Error setting origin for svgObject:",
                            svgObject,
                            e
                        );
                    }

                    // The rest of the properties for interactivity remain the same
                    svgObject.set({
                        hasControls: true,
                        hasBorders: true,
                        selectable: true,
                        evented: true,
                    });

                    canvas.add(svgObject);
                    canvas.bringToFront(svgObject);
                    canvas.renderAll();
                    saveCanvasState();
                },
                function (xhr) {
                    console.error(
                        "Failed to load SVG (drag-and-drop) from URL: ",
                        iconUrl,
                        xhr
                    );
                },
                {
                    crossOrigin: "anonymous",
                }
            );
        }

        // Function to add an icon
        function addIconToCanvas(iconUrl) {
            const targetIconDimensionRatio = 0.1;
            const targetDimension =
                Math.min(originalCanvasWidth, originalCanvasHeight) *
                targetIconDimensionRatio;

            if (iconUrl.endsWith(".svg")) {
                fabric.loadSVGFromURL(
                    iconUrl,
                    function (objects, options) {
                        if (!objects || objects.length === 0) {
                            console.error(
                                "No SVG objects loaded from URL (SVG path): ",
                                iconUrl
                            );
                            showToast("Failed to add icon: SVG objects not loaded.", 3000);
                            return;
                        }
                        let svgObject;
                        if (objects.length > 1) {
                            svgObject = fabric.util.groupSVGElements(objects, options);
                        } else {
                            svgObject = objects[0];
                            if (options) {
                                svgObject.set(options);
                            }
                        }

                        if (!svgObject) {
                            console.error(
                                "SVG Object failed to be created from URL (SVG path): ",
                                iconUrl
                            );
                            showToast(
                                "Failed to add icon: SVG object creation failed.",
                                3000
                            );
                            return;
                        }

                        const scaleFactor = Math.min(
                            targetDimension / svgObject.width,
                            targetDimension / svgObject.height
                        );
                        svgObject.scale(scaleFactor);

                        svgObject.set({
                            left: originalCanvasWidth / 2,
                            top: originalCanvasHeight / 2,
                            originX: "center",
                            originY: "center",
                            hasControls: true,
                            hasBorders: true,
                            selectable: true,
                            evented: true,
                            isIcon: true, // Mark as an icon
                        });

                        canvas.add(svgObject);
                        canvas.bringToFront(svgObject);
                        canvas.renderAll();
                        saveCanvasState();
                        showToast("Icon added to canvas!");
                    },
                    function (xhr) {
                        console.error(
                            "Failed to load SVG from URL (SVG path XHR error): ",
                            iconUrl,
                            xhr
                        );
                        showToast(
                            "Error loading SVG icon. Please check the source.",
                            3000
                        );
                    },
                    {
                        crossOrigin: "anonymous",
                    }
                );
            } else {
                fabric.Image.fromURL(
                    iconUrl,
                    function (img) {
                        if (!img) {
                            console.error(
                                "Fabric.js did not create an image object from URL:",
                                iconUrl
                            );
                            showToast(
                                "Failed to add icon: Image object not created.",
                                3000
                            );
                            return;
                        }

                        if (img.width === 0 || img.height === 0) {
                            console.error(
                                "Image has zero dimensions, cannot scale:",
                                iconUrl
                            );
                            showToast(
                                "Failed to add icon: Image has zero dimensions.",
                                3000
                            );
                            return;
                        }

                        // Calculate scale factor based on original dimensions
                        const scaleFactor = Math.min(
                            targetDimension / img.width,
                            targetDimension / img.height
                        );
                        img.scale(scaleFactor);

                        img.set({
                            left: originalCanvasWidth / 2,
                            top: originalCanvasHeight / 2,
                            originX: "center",
                            originY: "center",
                            hasControls: true,
                            hasBorders: true,
                            selectable: true,
                            evented: true,
                            isIcon: true,
                        });

                        canvas.add(img);
                        canvas.bringToFront(img);
                        canvas.renderAll();
                        showToast("Icon added to canvas!");
                    },
                    {
                        crossOrigin: "anonymous",
                        error: function (error) {
                            console.error(
                                "Fabric.js Image loading failed for URL:",
                                iconUrl,
                                error
                            );
                            showToast(
                                "Error loading image icon. Please check the source.",
                                3000
                            );
                        },
                    }
                );
            }
        }

        // Updated addIconToCanvasAtCoords function
        function addIconToCanvasAtCoords(iconUrl, x, y) {
            const targetIconDimensionRatio = 0.1;
            const targetDimension =
                Math.min(originalCanvasWidth, originalCanvasHeight) *
                targetIconDimensionRatio;

            if (iconUrl.endsWith(".svg")) {
                fabric.loadSVGFromURL(
                    iconUrl,
                    function (objects, options) {
                        if (!objects || objects.length === 0) {
                            console.error("No SVG objects loaded from URL: ", iconUrl);
                            showToast("Failed to add icon: SVG objects not loaded.", 3000);
                            return;
                        }

                        let svgObject;
                        if (objects.length > 1) {
                            svgObject = fabric.util.groupSVGElements(objects, options);
                        } else {
                            svgObject = objects[0];
                            if (options) {
                                svgObject.set(options);
                            }
                        }

                        if (!svgObject) {
                            console.error(
                                "SVG Object failed to be created from URL: ",
                                iconUrl
                            );
                            showToast(
                                "Failed to add icon: SVG object creation failed.",
                                3000
                            );
                            return;
                        }

                        // Calculate scale factor based on original dimensions
                        const scaleFactor = Math.min(
                            targetDimension / svgObject.width,
                            targetDimension / svgObject.height
                        );
                        svgObject.scale(scaleFactor);

                        svgObject.set({
                            left: x,
                            top: y,
                            originX: "left",
                            originY: "top",
                            hasControls: true,
                            hasBorders: true,
                            selectable: true,
                            evented: true,
                            isIcon: true,
                        });

                        try {
                            svgObject.setOriginX("left");
                            svgObject.setOriginY("top");
                        } catch (e) {
                            console.error(
                                "Error setting origin for svgObject:",
                                svgObject,
                                e
                            );
                        }

                        canvas.add(svgObject);
                        canvas.bringToFront(svgObject);
                        canvas.renderAll();
                        saveCanvasState();
                        showToast("Icon dropped onto canvas!");
                    },
                    function (xhr) {
                        console.error(
                            "Failed to load SVG (drag-and-drop) from URL: ",
                            iconUrl,
                            xhr
                        );
                        showToast(
                            "Error loading SVG icon. Please check the source.",
                            3000
                        );
                    },
                    {
                        crossOrigin: "anonymous",
                    }
                );
            } else {
                // Handle raster images (PNG, JPG, etc.)
                fabric.Image.fromURL(
                    iconUrl,
                    function (img) {
                        if (!img) {
                            console.error(
                                "Fabric.js did not create an image object from URL:",
                                iconUrl
                            );
                            showToast(
                                "Failed to add icon: Image object not created.",
                                3000
                            );
                            return;
                        }

                        if (img.width === 0 || img.height === 0) {
                            console.error(
                                "Image has zero dimensions, cannot scale:",
                                iconUrl
                            );
                            showToast(
                                "Failed to add icon: Image has zero dimensions.",
                                3000
                            );
                            return;
                        }

                        // Calculate scale factor based on original dimensions
                        const scaleFactor = Math.min(
                            targetDimension / img.width,
                            targetDimension / img.height
                        );
                        img.scale(scaleFactor);

                        img.set({
                            left: x,
                            top: y,
                            originX: "left",
                            originY: "top",
                            hasControls: true,
                            hasBorders: true,
                            selectable: true,
                            evented: true,
                            isIcon: true,
                        });

                        canvas.add(img);
                        canvas.bringToFront(img);
                        canvas.renderAll();
                        saveCanvasState(); // Save state for raster images too
                        showToast("Icon dropped onto canvas!");
                    },
                    {
                        crossOrigin: "anonymous",
                        error: function (error) {
                            console.error(
                                "Fabric.js Image loading failed for URL:",
                                iconUrl,
                                error
                            );
                            showToast(
                                "Error loading image icon. Please check the source.",
                                3000
                            );
                        },
                    }
                );
            }
        }

        // Event delegation for dynamically added image elements
        $(document).on("click", ".icon-item", function () {
            var fullUrl = $(this).find("img").attr("data-full");

            if (!fullUrl) {
                fullUrl = $(this).find("img").attr("src");
                console.warn(
                    "Using preview URL for canvas, consider enabling data-full for high-res icons."
                );
            }

            addIconToCanvas(fullUrl);
        });

        function displayIconResults(icons) {
            var resultsContainer = $("#iconResults");
            // If it's the first page, clear existing results. Otherwise, append.
            if (iconPage === 1) {
                resultsContainer.empty();
            }

            if (icons.length === 0 && iconPage === 1) {
                resultsContainer.html(
                    '<p class="text-gray-500 text-center">No icons found for your search.</p>'
                );
                return;
            }

            icons.forEach(function (icon) {
                var previewUrl = getBestPreviewUrl(icon.raster_sizes);

                var canvasLoadUrl = icon.svg_url || previewUrl;

                if (previewUrl && canvasLoadUrl) {
                    var imgElement = $("<img>")
                        .attr("src", previewUrl) // Use previewUrl for the visible image in the palette
                        .attr("alt", "Iconfinder Icon")
                        .css({ width: "50px", height: "50px", "object-fit": " contain" });

                    var divWrapper = $("<div>")
                        .attr(
                            "class",
                            "icon-item cursor-pointer bg-white rounded-md p-1 flex items-center justify-center"
                        )
                        .attr("draggable", "true")
                        .data("icon-url", canvasLoadUrl);

                    divWrapper.on("dragstart", function (e) {
                        const originalEvent = e.originalEvent;
                        const iconUrl = $(this).data("icon-url");

                        originalEvent.dataTransfer.setData("text/plain", iconUrl);
                        originalEvent.dataTransfer.setData("text/x-type", "icon");
                        originalEvent.dataTransfer.effectAllowed = "copy";
                        originalEvent.dataTransfer.setData(
                            "text/x-internal-drag",
                            "true"
                        );
                    });

                    divWrapper.append(imgElement);
                    resultsContainer.append(divWrapper);
                }
            });
        }

        // Search button click event for Icons
        $("#searchIconBtn").on("click", function () {
            iconQuery = $("#icons-search-input").val().trim();
            iconPage = 1;
            $("#iconResults").empty();
            if (iconQuery) {
                searchIconfinder(iconQuery, iconPage);
            } else {
                showToast("Please enter a search term for icons.", 2000);
            }
        });

        // Infinite scroll event for icons
        $("#sidebar-content-area").on("scroll", function () {
            const $this = $(this);
            if (
                $this.scrollTop() + $this.innerHeight() >=
                $this[0].scrollHeight - 50
            ) {
                if (
                    !iconLoading &&
                    iconQuery &&
                    $("#shapes-elements-content").is(":visible")
                ) {
                    iconPage++;
                    searchIconfinder(iconQuery, iconPage);
                }
            }
        });

        // Initialize icon search on page load if input has a value
        $(document).ready(function () {
            if ($("#icons-search-input").val().trim()) {
                iconQuery = $("#icons-search-input").val().trim();
                searchIconfinder(iconQuery, iconPage);
            }
        });

        // --- Pixabay (Photos) API Integration ---
        photoPage = 1;
        photoQuery = "";
        photoLoading = false;

        /**
         * Searches for photos using the Pixabay API.
         */
        function searchPixabay(query, page) {
            if (photoLoading) return;
            photoLoading = true;

            $("#photoLoading").removeClass("hidden");

            $.ajax({
                url: `/api/pixabay?q=${query}&type=photo&per_page=20&hits=18&page=${page}`,
                method: "GET",
                success: function (data) {
                    displayPhotoResults(data.hits);
                    photoLoading = false;
                    $("#photoLoading").addClass("hidden");
                },
                error: function (err) {
                    photoLoading = false;
                    $("#photoLoading").addClass("hidden");
                    showToast("Error fetching photos. Please try again.", 3000);
                },
            });
        }

        // Search button click event for Photos
        $("#photoSearchButton").on("click", function () {
            photoQuery = $("#photosSearchQuery").val().trim();
            photoPage = 1;
            $("#photoSearchResults").empty();
            if (photoQuery) {
                searchPixabay(photoQuery, photoPage);
            } else {
                showToast("Please enter a search term for photos.", 2000);
            }
        });

        // Infinite scroll event for photos
        $("#sidebar-content-area").on("scroll", function () {
            const $this = $(this);
            if (
                $this.scrollTop() + $this.innerHeight() >=
                $this[0].scrollHeight - 50
            ) {
                if (
                    !photoLoading &&
                    photoQuery &&
                    $("#photos-content").is(":visible")
                ) {
                    photoPage++;
                    searchPixabay(photoQuery, photoPage);
                }
            }
        });

        // Initialize photo search on page load if input has a value
        $(document).ready(function () {
            if ($("#photosSearchQuery").val().trim()) {
                photoQuery = $("#photosSearchQuery").val().trim();
                searchPixabay(photoQuery, photoPage);
            }

            $("#designsSearchResults").on(
                "click",
                ".design-thumbnail",
                function () {
                    const designIdToLoad = $(this).data("design-id");
                    const designNameToLoad = $(this).data("design-name");

                    showCustomModal(
                        "Import Design",
                        `Importing "${designNameToLoad}" will replace your current canvas content. Do you want to proceed?`,
                        `<button id="confirmImportDesignBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">Yes, Import</button>
      <button id="cancelImportDesignBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                    );

                    $("#confirmImportDesignBtn")
                        .off("click")
                        .on("click", function () {
                            $("#customModal").removeClass("flex").addClass("hidden");
                            showGlobalLoader();

                            $.ajax({
                                url: `/api/design/${designIdToLoad}`,
                                type: "GET",
                                success: function (response) {
                                    if (response.canvas) {
                                        const canvasData = response.canvas;

                                        // Check if the first object is an image that should be a background
                                        if (canvasData.objects && canvasData.objects.length > 0 &&
                                            canvasData.objects[0].type === "image") {
                                            const bgImage = canvasData.objects[0];

                                            // Set as background image
                                            canvasData.background = {
                                                source: bgImage.src,
                                                width: bgImage.width,
                                                height: bgImage.height,
                                                crossOrigin: bgImage.crossOrigin,
                                                type: 'image',
                                                originX: bgImage.originX,
                                                originY: bgImage.originY,
                                                left: 0,
                                                top: 0,
                                                scaleX: bgImage.scaleX,
                                                scaleY: bgImage.scaleY,
                                                opacity: bgImage.opacity
                                            };

                                            // Remove the image from objects array
                                            canvasData.objects.shift();
                                        }

                                        // Update global original dimensions
                                        originalCanvasWidth = canvasData.width;
                                        originalCanvasHeight = canvasData.height;

                                        // Recalculate zoom level
                                        const mainContentArea = document.getElementById("main-content-area");
                                        if (mainContentArea) {
                                            const containerWidth = mainContentArea.clientWidth;
                                            const containerHeight = mainContentArea.clientHeight;
                                            const horizontalPadding = 30;
                                            const topPadding = 10;
                                            const bottomPadding = 10;
                                            const effectiveContainerWidth = containerWidth - horizontalPadding;
                                            const effectiveContainerHeight = containerHeight - (topPadding + bottomPadding);
                                            const scaleX = effectiveContainerWidth / originalCanvasWidth;
                                            const scaleY = effectiveContainerHeight / originalCanvasHeight;
                                            let fitZoom = Math.min(scaleX, scaleY) * 0.83;
                                            currentZoomLevel = fitZoom;
                                        }

                                        // Clear current canvas
                                        canvas.clear();

                                        // Configure selection styles before loading
                                        canvas.selectionColor = 'rgba(29, 137, 255, 0.3)';
                                        canvas.selectionBorderColor = '#1d89ff';
                                        canvas.selectionLineWidth = 2;
                                        canvas.selectionDashArray = [5, 5];

                                        // Load the design
                                        canvas.loadFromJSON(canvasData, function () {
                                            // Set background image if exists
                                            if (canvasData.background?.source) {
                                                fabric.Image.fromURL(canvasData.background.source, function (img) {
                                                    img.set({
                                                        originX: 'left',
                                                        originY: 'top',
                                                        left: 0,
                                                        top: 0,
                                                        scaleX: canvasData.width / img.width,
                                                        scaleY: canvasData.height / img.height,
                                                        selectable: false,
                                                        evented: false
                                                    });
                                                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                                                        crossOrigin: 'anonymous'
                                                    });
                                                });
                                            }

                                            // Normalize all text objects for editing
                                            canvas.getObjects().forEach(obj => {
                                                if (obj.type.includes('text')) {
                                                    obj.set({
                                                        editable: true,
                                                        selectable: true,
                                                        evented: true,
                                                        borderColor: '#1d89ff',
                                                        cornerColor: '#ffffff',
                                                        cornerStrokeColor: '#1d89ff',
                                                        cornerSize: 8,
                                                        transparentCorners: false
                                                    });

                                                    // Ensure consistent text object type
                                                    if (obj.type !== 'textbox') {
                                                        const textbox = new fabric.Textbox(obj.text, {
                                                            left: obj.left,
                                                            top: obj.top,
                                                            width: obj.width,
                                                            fontSize: obj.fontSize,
                                                            fontFamily: obj.fontFamily,
                                                            fontWeight: obj.fontWeight,
                                                            fontStyle: obj.fontStyle,
                                                            textAlign: obj.textAlign,
                                                            lineHeight: obj.lineHeight,
                                                            fill: obj.fill,
                                                            editable: true
                                                        });
                                                        canvas.remove(obj);
                                                        canvas.add(textbox);
                                                    }
                                                }
                                            });

                                            canvas.renderAll();
                                            resizeCanvas();
                                            saveCanvasState();

                                            // Update UI
                                            const activeObject = canvas.getActiveObject();
                                            if (activeObject) {
                                                updateObjectToolbar(activeObject);
                                                updateFloatingControls(activeObject);
                                            } else {
                                                updateObjectToolbar(null);
                                                updateFloatingControls(null);
                                            }

                                            // Reset design state
                                            const newUrl = `${window.location.origin}/design/`;
                                            window.history.pushState({ path: newUrl }, "", newUrl);
                                            $("#designName").val("Untitled Design");

                                            showToast(`Design "${designNameToLoad}" imported successfully!`);
                                            hideGlobalLoader();
                                        });
                                    } else {
                                        showToast("Error: No canvas data found in the imported design.", 3000);
                                        hideGlobalLoader();
                                    }
                                },
                                error: function (xhr, status, error) {
                                    showToast(
                                        "Error importing design: " +
                                        (xhr.responseJSON ? xhr.responseJSON.message : error),
                                        3000
                                    );
                                    hideGlobalLoader();
                                }
                            });
                        });

                    $("#cancelImportDesignBtn")
                        .off("click")
                        .on("click", function () {
                            $("#customModal").removeClass("flex").addClass("hidden");
                        });
                }
            );
            // ADD this new event listener block
            $("#designsSearchResults").on(
                "dragstart",
                ".design-thumbnail",
                function (e) {
                    const designId = $(this).data("design-id");
                    const designName = $(this).data("design-name");
                    const thumbnailUrl = $(this).find("img").attr("src"); // Assuming the image is inside the thumbnail div

                    e.originalEvent.dataTransfer.setData(
                        "text/x-type",
                        "public-design"
                    ); // Custom type for public designs
                    e.originalEvent.dataTransfer.setData("text/x-design-id", designId);
                    e.originalEvent.dataTransfer.setData(
                        "text/x-design-name",
                        designName
                    );
                    e.originalEvent.dataTransfer.setData("text/plain", thumbnailUrl); // Fallback data
                    e.originalEvent.dataTransfer.setData(
                        "text/x-internal-drag",
                        "true"
                    );
                    e.originalEvent.dataTransfer.effectAllowed = "copy";
                }
            );
        });

        // In your addImageToCanvas function:
        function addImageToCanvas(imageUrl) {
            fabric.Image.fromURL(
                imageUrl,
                function (img) {
                    if (img) {
                        canvas.calcOffset();

                        const targetSizeRatio = 0.4;
                        const targetDimension =
                            Math.min(originalCanvasWidth, originalCanvasHeight) *
                            targetSizeRatio;

                        // Calculate scale factor to fit the image within the target dimension
                        const scaleFactor = Math.min(
                            targetDimension / img.width,
                            targetDimension / img.height
                        );

                        img.set({
                            scaleX: scaleFactor,
                            scaleY: scaleFactor,
                            originX: "center",
                            originY: "center",

                            transparentCorners: false,
                            hasControls: true,
                            hasBorders: true,
                            isIcon: false,
                        });

                        canvas.add(img);
                        img.center(); // Center the image on the canvas
                        canvas.setActiveObject(img);
                        canvas.renderAll();
                        saveCanvasState();

                        showToast("Image added to canvas!");
                    } else {
                        showToast(
                            "Failed to add image to canvas. Please check the image source.",
                            3000
                        );
                    }
                },
                {
                    crossOrigin: "anonymous",
                    onError: function (img, err) {
                        console.error(
                            "Fabric.js Image loading error:",
                            err,
                            "Image URL:",
                            imageUrl
                        );
                        showToast(
                            "Failed to load image for canvas. This might be due to a broken link or CORS issues.",
                            5000
                        );
                    },
                }
            );
        }

        //  Generates and displays a QR code.

        $(document).ready(function () {
            $("#generateQrCodeBtn").on("click", function () {
                var url = $("#qrCodeUrlInput").val().trim();

                if (!url) {
                    showToast("Please enter a URL for the QR Code.", 2000);
                    return;
                }

                $("#qrCodeDisplay").empty(); // Clear previous QR code
                $("#qrCodeLoading").removeClass("hidden"); // Show QR code loader

                $.ajax({
                    url: "/api/qr/basic",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ url: url }),
                    success: function (response) {
                        if (response.qrCodeUrl) {
                            var qrImg = $("<img>")
                                .attr("src", response.qrCodeUrl)
                                .attr("alt", "QR Code")
                                .addClass(
                                    "w-32 h-32 cursor-pointer rounded-md shadow-md hover:shadow-lg transition-shadow duration-200"
                                )
                                .attr("draggable", "true"); // Make the QR image draggable

                            // Add dragstart event for QR code
                            qrImg.on("dragstart", function (e) {
                                const originalEvent = e.originalEvent;
                                const qrCodeUrl = $(this).attr("src");
                                originalEvent.dataTransfer.setData("text/plain", qrCodeUrl);
                                originalEvent.dataTransfer.setData("text/x-type", "qr-code"); // Custom type for QR codes
                                originalEvent.dataTransfer.effectAllowed = "copy";
                                originalEvent.dataTransfer.setData(
                                    "text/x-internal-drag",
                                    "true"
                                ); // Add internal drag flag
                                e.stopPropagation(); // Stop propagation
                            });

                            qrImg.on("click", function () {
                                fabric.Image.fromURL(
                                    response.qrCodeUrl,
                                    function (img) {
                                        if (img) {
                                            img.scaleToWidth(150);
                                            img.scaleToHeight(150);

                                            var canvasCenterX = canvas.width / 2;
                                            var canvasCenterY = canvas.height / 2;

                                            img.set({
                                                left: canvasCenterX,
                                                top: canvasCenterY,
                                                originX: "center",
                                                originY: "center",

                                                transparentCorners: false,
                                                hasControls: true,
                                                hasBorders: true,
                                            });

                                            canvas.add(img);
                                            canvas.renderAll();
                                            saveCanvasState();
                                            showToast("QR Code added to canvas!");
                                        } else {
                                            showToast(
                                                "Failed to add QR code to canvas. Please check the URL.",
                                                3000
                                            );
                                        }
                                    },
                                    {
                                        crossOrigin: "anonymous",
                                        onError: function (img, err) {
                                            console.error(
                                                "Fabric.js Image loading error for QR code:",
                                                err,
                                                "Image URL:",
                                                response.qrCodeUrl
                                            );
                                            showToast(
                                                "Failed to load QR code for canvas. This might be due to a broken link or CORS issues.",
                                                5000
                                            );
                                        },
                                    }
                                );
                            });

                            $("#qrCodeDisplay").append(qrImg);
                        } else {
                            showToast("Error generating QR Code.", 3000);
                        }
                    },
                    error: function (xhr, status, error) {
                        showToast(
                            "An error occurred while generating the QR Code.",
                            3000
                        );
                    },
                    complete: function () {
                        $("#qrCodeLoading").addClass("hidden"); // Hide QR code loader
                    },
                });
            });
        });

        // Fetches and displays background templates.
        function fetchTemplateBackgrounds() {
            var designQuery = $("#designSearchQuery").val();

            const canvasWidth = originalCanvasWidth;
            const canvasHeight = originalCanvasHeight;

            let apiUrl = `/api/files/search?tags=${encodeURIComponent(
                designQuery
            )}&width=${canvasWidth}&height=${canvasHeight}`;

            const $templateContainer = $("#backgroundSearchResults");
            $templateContainer.empty();
            $("backgroundLoading").removeClass("hidden");

            $.ajax({
                url: apiUrl,
                method: "GET",
                success: function (data) {
                    let designsToDisplay = [];
                    if (Array.isArray(data)) {
                        designsToDisplay = data;
                    } else if (data && typeof data === "object") {
                        designsToDisplay = [data];
                    } else {
                        designsToDisplay = [];
                    }

                    if (designsToDisplay.length === 0) {
                        $templateContainer.html(
                            '<p class="text-gray-500 text-center col-span-2">No designs found matching your criteria.</p>'
                        );
                    }

                    designsToDisplay.forEach((design) => {
                        const $templateWrapper = $("<div>", {
                            class: "template-wrapper relative flex m-1 group",
                        });

                        const $templateImage = $("<img>", {
                            class:
                                "my-template-image h-auto rounded-md shadow-md cursor-pointer",
                            src: design.url,
                            alt: design.fileName,
                            "data-type": "design-background",
                        });

                        $templateImage.on("dragstart", function (e) {
                            const imageUrl = $(this).attr("src");

                            e.originalEvent.dataTransfer.setData("text/plain", imageUrl);
                            e.originalEvent.dataTransfer.setData("text/uri-list", imageUrl);
                            e.originalEvent.dataTransfer.setData(
                                "text/x-type",
                                "design-background"
                            );
                            e.originalEvent.dataTransfer.effectAllowed = "copy";
                            e.originalEvent.dataTransfer.setData(
                                "text/x-internal-drag",
                                "true"
                            );
                        });

                        const $downloadBtn = $("<button>", {
                            class:
                                "absolute top-2 right-8 bg-black/50 text-white rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 btn-icon",
                            html: '<i class="fas fa-download icon-sm"></i>',
                        }).on("click", function (e) {
                            e.stopPropagation();
                            const downloadUrl = design.url;
                            const $a = $("<a>", {
                                href: downloadUrl,
                                download: design.fileName,
                            });
                            $a[0].click();
                            showToast(`Downloading ${design.fileName}...`);
                        });

                        const $deleteBtn = $("<button>", {
                            class:
                                "absolute top-2 right-2 bg-black/50  text-white  rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 btn-icon",
                            html: '<i class="fas fa-trash-alt icon-sm"></i>',
                        }).on("click", function (e) {
                            e.stopPropagation();
                            showCustomModal(
                                "Confirm Delete",
                                "Are you sure you want to delete this design?",
                                `<button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                            <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                            );

                            $("#confirmDeleteBtn").on("click", function () {
                                $(this).html(
                                    '<span class="spinner-border spinner-border-sm deletespiner" role="status" aria-hidden="true"></span> Deleting...'
                                );
                                $(this).prop("disabled", true);

                                $.ajax({
                                    url: `/api/design/${design._id}`,
                                    method: "DELETE",
                                    success: function () {
                                        showToast("Design deleted successfully!");
                                        fetchTemplateBackgrounds();
                                        $("#customModal").removeClass("flex").addClass("hidden");
                                    },
                                    error: function (xhr, status, error) {
                                        console.error(
                                            "Error deleting design:",
                                            error,
                                            "Status:",
                                            status,
                                            "XHR:",
                                            xhr
                                        );
                                        showToast(
                                            "Failed to delete design. Please try again.",
                                            3000
                                        );
                                        $("#customModal").removeClass("flex").addClass("hidden");
                                    },
                                    complete: function () {
                                        $("#confirmDeleteBtn").html("Delete");
                                        $("#confirmDeleteBtn").prop("disabled", false);
                                    },
                                });
                            });
                            $("#cancelDeleteBtn").on("click", function () {
                                $("#customModal").removeClass("flex").addClass("hidden");
                            });
                        });

                        $templateWrapper.append($templateImage, $downloadBtn, $deleteBtn);
                        $templateContainer.append($templateWrapper);
                    });
                },
                error: function (xhr, status, error) {
                    console.error(
                        "Error fetching designs:",
                        error,
                        "Status:",
                        status,
                        "XHR:",
                        xhr
                    );
                    showToast("Failed to load designs. Please try again.", 3000);
                },
                complete: function () {
                    $("#designLoading").addClass("hidden");
                },
            });
        }

        // Event Delegation for adding background to canvas
        $("#backgroundSearchResults").on(
            "click",
            ".my-template-image",
            function () {
                const imageUrl = $(this).attr("src"); // Get the image URL directly

                // Show a loading toast/indicator if desired
                showToast("Applying background...", 0);

                fabric.Image.fromURL(
                    imageUrl,
                    function (img) {
                        if (img) {
                            // Calculate scale for "cover" behavior: image fills the canvas, cropping if necessary
                            const scaleX = originalCanvasWidth / img.width;
                            const scaleY = originalCanvasHeight / img.height;
                            const scale = Math.max(scaleX, scaleY); // FIX: Use Math.max for "cover" behavior

                            // Calculate position to center the scaled image
                            const left = (originalCanvasWidth - img.width * scale) / 2;
                            const top = (originalCanvasHeight - img.height * scale) / 2;

                            canvas.setBackgroundImage(
                                img,
                                function () {
                                    // This is the callback function
                                    canvas.renderAll(); // Render the canvas after background is set
                                    saveCanvasState(); // FIX: Save state AFTER rendering
                                    showToast("Background applied!", 3000); // Show success toast
                                },
                                {
                                    scaleX: scale,
                                    scaleY: scale,
                                    originX: "left", // Set origin to 'left' and 'top' for consistent positioning
                                    originY: "top",
                                    left: left,
                                    top: top,
                                    crossOrigin: "anonymous", // Important for loading images from other domains
                                }
                            );
                        } else {
                            showToast(
                                "Failed to load background image. Please check the image source.",
                                3000
                            );
                        }
                    },
                    {
                        crossOrigin: "anonymous", // Ensure crossOrigin is set for the Fabric.js loader
                        onError: function (img, err) {
                            console.error(
                                "Fabric.js Image loading error for background:",
                                err,
                                "Image URL:",
                                imageUrl
                            );
                            showToast(
                                "Failed to load background image for canvas. This might be due to a broken link or CORS issues.",
                                5000
                            );
                        },
                    }
                );
            }
        );

        // Function to populate brand selectors in AI design tabs
        function populateAITabsBrandSelectors() {
            $.ajax({
                url: "/api/brands", // Your backend endpoint to fetch brands
                method: "GET",
                success: function (response) {
                    allFetchedBrands = response.brands || [];

                    const $professionalBrandSelector = $(
                        "#professional-brand-selector"
                    );
                    const $manualBrandSelector = $("#manual-brand-selector");

                    // Clear existing options and add default/custom options
                    $professionalBrandSelector
                        .empty()
                        .append(
                            '<option value="">-- Select a Brand --</option><option value="custom">Custom Colors</option>'
                        );
                    $manualBrandSelector
                        .empty()
                        .append(
                            '<option value="">-- Select a Brand --</option><option value="custom">Custom Colors</option>'
                        );

                    // Append fetched brands to both dropdowns
                    if (allFetchedBrands.length > 0) {
                        allFetchedBrands.forEach((brand) => {
                            $professionalBrandSelector.append(
                                `<option value="${brand._id}">${brand.name}</option>`
                            );
                            $manualBrandSelector.append(
                                `<option value="${brand._id}">${brand.name}</option>`
                            );
                        });
                    } else {
                        console.log(
                            "No brands found in the response to populate selectors."
                        );
                    }
                },
                error: function (xhr, status, error) {
                    console.error(
                        "Error fetching brands for AI tabs:",
                        error,
                        "Status:",
                        status,
                        "XHR:",
                        xhr
                    );
                    showToast(
                        "Error loading brands for AI design. Please try again.",
                        3000
                    );
                },
            });
        }

        // Initial Call and Search Button Listener
        $(document).ready(function () {
            populateAITabsBrandSelectors();

            fetchTemplateBackgrounds();

            $("#designSearchButton").on("click", () => {
                fetchTemplateBackgrounds();
            });
        });


        function fetchUploadedImages(searchTerm = "") {
            const $imageContainer = $("#uploadedImages");
            $imageContainer.empty();
            $("#uploadedImagesLoading").removeClass("hidden"); // Show loading spinner

            const apiUrl = searchTerm
                ? `/api/files/images?searchTerm=${encodeURIComponent(searchTerm)}`
                : "/api/files/images";

            $.ajax({
                url: apiUrl,
                method: "GET",
                success: function (data) {
                    // Handle case where no images are returned
                    if (data.length === 0) {
                        $("#uploadedImagesLoading").addClass("hidden");
                        $imageContainer.html("<p class='text-gray-500 text-center mt-4'>No images found.</p>");
                        return;
                    }

                    let imagesLoadedCount = 0;
                    const totalImages = data.length;

                    data.forEach((file) => {
                        const $imgWrapper = $("<div>", {
                            class: "imageWrapper cursor-pointer w-full flex",
                            style: "position: relative;",
                        });
                        const $imgElement = $("<img>", {
                            class: "my-single-image w-full",
                            src: file.url,
                        });

                        // Attach a load event handler to each image
                        $imgElement.on("load", function () {
                            imagesLoadedCount++;
                            // Hide the loader only after the last image has loaded
                            if (imagesLoadedCount === totalImages) {
                                $("#uploadedImagesLoading").addClass("hidden");
                            }
                        }).on("error", function () {
                            // Also count images that fail to load to prevent an infinite spinner
                            console.error("Failed to load image:", file.url);
                            imagesLoadedCount++;
                            if (imagesLoadedCount === totalImages) {
                                $("#uploadedImagesLoading").addClass("hidden");
                            }
                        });

                        // (Rest of your code for download, delete buttons, drag/drop, and click handlers)
                        const $downloadBtn = $("<button>", {
                            class: "btn-icon-2 absolute top-2 right-1 bg-black/50 text-white rounded-md opacity-0 transition-opacity duration-200",
                            html: '<i class="fas fa-download icon-sm-2"></i>',
                        }).on("click", function () {
                            const $a = $("<a>", { href: file.url, download: file.fileName });
                            $a[0].click();
                        });

                        const $deleteBtn = $("<button>", {
                            class: "btn-icon-2 absolute top-2 right-8 bg-black/50 text-white rounded-md opacity-0 transition-opacity duration-200",
                            html: '<i class="fas fa-trash-alt icon-sm-2"></i>',
                        }).on("click", function () {
                            const fileId = file._id;
                            showCustomModal(
                                "Confirm Delete",
                                "Are you sure you want to delete this file?",
                                `<button id="confirmDeleteFileBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                         <button id="cancelDeleteFileBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                            );
                            $("#confirmDeleteFileBtn").on("click", function () {
                                const $confirmButton = $(this);
                                $confirmButton.html(
                                    '<span class="spinner-border spinner-border-sm deletespiner" role="status" aria-hidden="true"></span> Deleting...'
                                );
                                $confirmButton.prop("disabled", true);
                                $.ajax({
                                    url: `/api/files/${fileId}`,
                                    method: "DELETE",
                                    success: function () {
                                        showToast("File deleted successfully!");
                                        fetchUploadedImages();
                                        $("#customModal").removeClass("flex").addClass("hidden");
                                    },
                                    error: function (err) {
                                        console.error("Error deleting file:", err);
                                        showToast("Failed to delete file. Please try again.", 3000);
                                        $("#customModal").removeClass("flex").addClass("hidden");
                                    },
                                    complete: function () {
                                        $confirmButton.html("Delete");
                                        $confirmButton.prop("disabled", false);
                                    },
                                });
                            });
                            $("#cancelDeleteFileBtn").on("click", function () {
                                $("#customModal").removeClass("flex").addClass("hidden");
                            });
                        });
                        $imgWrapper.append($imgElement, $downloadBtn, $deleteBtn);
                        $imageContainer.append($imgWrapper);
                        $imgWrapper.hover(
                            function () {
                                $downloadBtn.show();
                                $deleteBtn.show();
                            },
                            function () {
                                $downloadBtn.hide();
                                $deleteBtn.hide();
                            }
                        );
                        $imgWrapper.on("dragstart", function (e) {
                            const originalEvent = e.originalEvent;
                            isDraggingUploadedImage = true;
                            const imageUrl = $(this).find("img").attr("src");
                            originalEvent.dataTransfer.clearData();
                            originalEvent.dataTransfer.setData("text/plain", imageUrl);
                            originalEvent.dataTransfer.setData("text/x-type", "uploaded-image");
                            originalEvent.dataTransfer.effectAllowed = "copy";
                            originalEvent.dataTransfer.setData("text/x-internal-drag", "true");
                            e.stopPropagation();
                        });
                        $imgWrapper.on("dragend", function (e) {
                            isDraggingUploadedImage = false;
                            e.stopPropagation();
                        });
                        $imgElement.on("click", function () {
                            var imgSrc = $(this).attr("src");
                            addUploadedImageToCanvas(imgSrc);
                            saveCanvasState();
                            showToast("Uploaded image added to canvas");
                        });
                    });
                },
                error: function (err) {
                    showToast("Error fetching uploaded images. Please try again.", 3000);
                    $("#uploadedImagesLoading").addClass("hidden"); // Hide loader on API error
                },

            });
        }

        // Call the function on page load
        $(document).ready(function () {
            $("#uploadedImageSearchButton").on("click", function () {
                const searchTerm = $("#uploadedImageSearchQuery").val().trim();
                fetchUploadedImages(searchTerm);
            });

            // Event listener for pressing Enter in the search input
            $("#uploadedImageSearchQuery").on("keypress", function (e) {
                if (e.which === 10) {
                    const searchTerm = $(this).val().trim();
                    fetchUploadedImages(searchTerm);
                }
            });
        });

        function addUploadedImageToCanvas(imageUrl, x, y) {
            fabric.Image.fromURL(
                imageUrl,
                function (img) {
                    if (img) {
                        const targetSizeRatio = 0.4;
                        const targetDimension =
                            Math.min(originalCanvasWidth, originalCanvasHeight) *
                            targetSizeRatio;

                        const scaleFactor = Math.min(
                            targetDimension / img.width,
                            targetDimension / img.height
                        );

                        img.set({
                            scaleX: scaleFactor,
                            scaleY: scaleFactor,
                            originX: "center",
                            originY: "center",

                            transparentCorners: false,
                            hasControls: true,
                            hasBorders: true,
                            isIcon: false,
                        });

                        canvas.add(img);
                        img.center(); // Center the image on the canvas
                        canvas.setActiveObject(img);
                        canvas.renderAll();
                        saveCanvasState();
                        showToast("Uploaded image added to canvas!!");
                    } else {
                        showToast(
                            "Failed to add uploaded image to canvas. Please check the image source.",
                            3000
                        );
                    }
                },
                {
                    crossOrigin: "anonymous",
                    onError: function (img, err) {
                        console.error(
                            "Fabric.js Image loading error for uploaded image:",
                            err,
                            "Image URL:",
                            imageUrl
                        );
                        showToast(
                            "Failed to load uploaded image for canvas. This might be due to a broken link or CORS issues.",
                            5000
                        );
                    },
                }
            );
        }

        // --- Pixabay (Photos) API Integration - Corrected Initialization ---
        var photoPage = 1;
        var photoQuery = "";
        var photoIsLoading = false;

        // Searches for photos using the Pixabay API.

        function searchPixabay(query, page) {
            if (photoIsLoading) return;
            photoIsLoading = true;

            $("#photoLoading").removeClass("hidden");

            $.ajax({
                url: `/api/pixabay?q=${query}&type=photo&per_page=20&hits=18&page=${page}`,
                method: "GET",
                success: function (data) {
                    displayPhotoResults(data.hits);
                    photoIsLoading = false;
                    $("#photoLoading").addClass("hidden");
                },
                error: function (xhr, status, error) {
                    photoIsLoading = false;
                    $("#photoLoading").addClass("hidden");
                    showToast("Error fetching photos. Please try again.", 3000);
                },
            });
        }

        //  Displays photo search results.

        function displayPhotoResults(images) {
            var resultsContainer = $("#photoSearchResults");
            if (photoPage === 1) {
                resultsContainer.empty();
            }
            images.forEach(function (image) {
                var imgElement = $("<img>")
                    .attr("src", image.previewURL)
                    .attr(
                        "class",
                        "photo-item cursor-pointer rounded-md shadow-md hover:shadow-lg transition-shadow duration-200"
                    )
                    .attr("data-full", image.largeImageURL)
                    .attr("alt", "Pixabay Image")
                    .attr("crossorigin", "anonymous")
                    .css({ width: "100%", height: "auto" });

                imgElement.on("click", function () {
                    addImageToCanvas($(this).data("full"));
                    saveCanvasState();
                });

                imgElement.on("dragstart", function (e) {
                    const originalEvent = e.originalEvent;
                    const fullImageUrl = $(this).data("full");

                    originalEvent.dataTransfer.setData("text/plain", fullImageUrl);
                    originalEvent.dataTransfer.setData("text/x-type", "pixabay-image");
                    originalEvent.dataTransfer.effectAllowed = "copy";
                    originalEvent.dataTransfer.setData("text/x-internal-drag", "true");
                });

                resultsContainer.append(
                    $('<div class="w-full flex"></div>').append(imgElement)
                );
            });
        }

        // Search button click event for Photos
        $("#photoSearchButton").on("click", function () {
            photoQuery = $("#photosSearchQuery").val().trim();
            photoPage = 1;
            $("#photoSearchResults").empty();
            if (photoQuery) {
                searchPixabay(photoQuery, photoPage);
            } else {
                showToast("Please enter a search term for photos.", 2000);
            }
        });

        // Infinite scroll event for photos
        $("#sidebar-content-area").on("scroll", function () {
            const $this = $(this);
            if (
                $this.scrollTop() + $this.innerHeight() >=
                $this[0].scrollHeight - 50
            ) {
                if (
                    !photoIsLoading &&
                    photoQuery &&
                    $("#photos-content").is(":visible")
                ) {
                    // Use photoIsLoading
                    photoPage++;
                    searchPixabay(photoQuery, photoPage);
                }
            }
        });

        // Initialize by using the current value in the search box, if present
        $(document).ready(function () {
            if ($("#photosSearchQuery").val().trim()) {
                // Corrected ID
                photoQuery = $("#photosSearchQuery").val().trim();
                searchPixabay(photoQuery, photoPage); // Perform search on page load if input has a value
            }
        });
        // --- End Pixabay (Photos) API Integration ---

        // --- Variable Script Starts ---

        let customVariables = [];

        // Renders a single variable into the sidebar list.
        function renderComponent(variable) {
            const item = $(
                `<div class="variable-draggable-item bg-zinc-600 hover:bg-zinc-700 text-white p-2 rounded-md text-sm cursor-grab">${variable.name}</div>`
            );
            item.data("tag", variable.tag);
            item.data("variable-tag", variable.tag);
            item.data("variable-name", variable.name);
            item.attr("draggable", "true");
            item.on("click", function () {
                addVariableToCanvas($(this).data("tag"), variable.name);
            });
            $("#components-list").append(item);
        }

        // Fetches custom variables from the backend API and renders them in the sidebar.
        function fetchVariables() {
            const $componentsList = $("#components-list");
            $componentsList.empty();
            $("#variablesLoading").removeClass("hidden");

            // Define default contact schema variables
            const defaultContactVariables = [
                { name: "First Name", tag: "{{firstName}}" },
                { name: "Last Name", tag: "{{lastName}}" },
                { name: "Full Name", tag: "{{fullName}}" },
                { name: "Email", tag: "{{email}}" },
                { name: "Phone", tag: "{{phone}}" },
                { name: "Company", tag: "{{company}}" },
                { name: "Address", tag: "{{address}}" },
                { name: "City", tag: "{{city}}" },
                { name: "State", tag: "{{state}}" },
                { name: "Zip Code", tag: "{{zipCode}}" },
                { name: "Country", tag: "{{country}}" },
                { name: "Date", tag: "{{date}}" },
                { name: "Certificate ID", tag: "{{certificateId}}" },
                { name: "Course Name", tag: "{{courseName}}" },
                { name: "Completion Date", tag: "{{completionDate}}" },
                { name: "Issue Date", tag: "{{issueDate}}" },
                { name: "Expiration Date", tag: "{{expirationDate}}" },
                { name: "Score", tag: "{{score}}" },
                { name: "Grade", tag: "{{grade}}" },
                { name: "Instructor Name", tag: "{{instructorName}}" },
                { name: "Event Name", tag: "{{eventName}}" },
                { name: "Event Date", tag: "{{eventDate}}" },
                { name: "Award Name", tag: "{{awardName}}" },
                { name: "Awarding Body", tag: "{{awardingBody}}" },
                { name: "Signature 1 Name", tag: "{{signature1Name}}" },
                { name: "Signature 1 Title", tag: "{{signature1Title}}" },
                { name: "Signature 2 Name", tag: "{{signature2Name}}" },
                { name: "Signature 2 Title", tag: "{{signature2Title}}" },
                { name: "Signature 3 Name", tag: "{{signature3Name}}" },
                { name: "Signature 3 Title", tag: "{{signature3Title}}" },
                { name: "QR Code URL", tag: "{{qrCodeUrl}}" },
            ];

            // Render default variables first
            defaultContactVariables.forEach((variable) => {
                renderComponent(variable);
            });

            // Then fetch custom variables
            // $.ajax({
            //     url: '/api/custom-variable/get',
            //     method: 'GET',
            //     success: function (response) {

            //         if (response && response.contactCustomVariable && typeof response.contactCustomVariable === 'object') {
            //             const fetchedVariablesArray = Object.values(response.contactCustomVariable);
            //             customVariables = fetchedVariablesArray;

            //             if (customVariables.length > 0) {
            //                 customVariables.forEach(variable => {
            //                     if (!variable.tag) {
            //                         variable.tag = `{{${variable.name.replace(/\s+/g, '_').toLowerCase()}}}`;
            //                     }
            //                     renderComponent(variable);
            //                 });

            //             } else {
            //                 // If no custom variables, the default ones will still be shown
            //                 console.warn("No custom variables found for this user.");
            //             }
            //         } else if (response && response.error === "No Custom Variables Found") {
            //             console.warn("No custom variables found for this user, as per backend response.");
            //         } else {
            //             console.warn("API response for custom variables was not in the expected format:", response);
            //             showToast('Received unexpected data format for variables. Please check console.', 3000);
            //         }
            //     },
            //     error: function (xhr, status, error) {
            //         console.error('Error fetching custom variables:', error, status, xhr);
            //         showToast('Error fetching custom variables. Please try again.', 3000);
            //         $componentsList.append('<p class="text-red-400 text-center py-4">Failed to load custom variables. Server error.</p>');
            //     },
            //     complete: function () {
            //         $('#variablesLoading').addClass('hidden');

            //         $componentsList.append(`

            // `);
            //     }
            // });
        }

        $(document).ready(function () {
            fetchVariables();

            // Event delegation for dragstart on variable items
            // This ensures that dragstart works for elements added dynamically
            $("#components-list").on(
                "dragstart",
                ".variable-draggable-item",
                function (e) {
                    const originalEvent = e.originalEvent;
                    const variableTag = $(this).data("variable-tag");
                    const variableName = $(this).text();

                    originalEvent.dataTransfer.setData("text/plain", variableTag);
                    originalEvent.dataTransfer.setData("text/x-type", "variable");
                    originalEvent.dataTransfer.setData(
                        "text/x-variable-tag",
                        variableTag
                    );
                    originalEvent.dataTransfer.setData(
                        "text/x-variable-name",
                        variableName
                    );
                    originalEvent.dataTransfer.effectAllowed = "copy";
                    originalEvent.dataTransfer.setData("text/x-internal-drag", "true");
                }
            );
        });

        // Adds a variable to the canvas at specified coordinates.
        function addVariableToCanvasAtCoords(tag, name, x, y, isCustom = false) {
            const baseFontSize = originalCanvasHeight * 0.03;
            const minFontSize = 14;
            const dynamicFontSize = Math.max(baseFontSize, minFontSize);

            // Use fabric.Textbox for better control over text area width
            const textObj = new fabric.Textbox(tag, {
                left: x,
                top: y,
                fill: "#000",
                fontSize: dynamicFontSize,
                originX: "center",
                originY: "center",
                variableTag: tag,
                variableName: name,
                isCustomVariable: isCustom,
                fontFamily: "Roboto",

                transparentCorners: false,
                hasControls: true,
                hasBorders: true,

                width: originalCanvasWidth * 0.4,
                textAlign: "center",
            });
            canvas.add(textObj);
            canvas.setActiveObject(textObj);
            canvas.renderAll();
            saveCanvasState();
            showToast(`Variable "${name}" added to canvas!`);
        }

        // Adds a variable to the center of the canvas.
        function addVariableToCanvas(tag, name, isCustom = false) {
            const baseFontSize = originalCanvasHeight * 0.03;
            const minFontSize = 14;
            const dynamicFontSize = Math.max(baseFontSize, minFontSize);

            // Use fabric.Textbox for better control over text area width
            const textObj = new fabric.Textbox(tag, {
                left: originalCanvasWidth / 2,
                top: originalCanvasHeight / 2,
                fill: "#000",
                fontSize: dynamicFontSize,
                originX: "center",
                originY: "center",
                variableTag: tag,
                variableName: name,
                isCustomVariable: isCustom,
                fontFamily: "Roboto",

                transparentCorners: false,
                hasControls: true,
                hasBorders: true,

                width: originalCanvasWidth * 0.4,
                textAlign: "center",
            });
            canvas.add(textObj);
            canvas.setActiveObject(textObj);
            canvas.renderAll();
            saveCanvasState();
            showToast(`Variable "${name}" added to canvas!`);
        }

        // Retrieves all variables currently on the canvas.
        function getCanvasVariables() {
            return canvas
                .getObjects()
                .filter((obj) => obj.variableTag)
                .map((obj) => ({
                    tag: obj.variableTag,
                    name: obj.variableName,
                    isCustom: obj.isCustomVariable || false,
                }));
        }

        // Opens the modal for adding a custom variable.
        $("#add-variable-btn").on("click", function () {
            $("#variable-name").val("");
            $("#variable-type").val("text");
            $("#variable-default").val("");
            $("#variableModal").removeClass("hidden").addClass("flex");
        });

        // Closes the custom variable modal.
        $("#closeVariableModal").on("click", function () {
            $("#variableModal").removeClass("flex").addClass("hidden");
        });

        // Applies font family styles to dropdown options.
        $("#fontFamily option").each(function () {
            const fontName = $(this).val();
            $(this).css("font-family", fontName);
        });

        // Saves a custom variable from the modal.
        $("#save-variable-btn").on("click", function () {
            const name = $("#variable-name").val().trim();
            const type = $("#variable-type").val();
            const defaultValue = $("#variable-default").val().trim();

            if (name) {
                const tag = `{{${name.replace(/\s+/g, "_").toLowerCase()}}}`;
                const newCustomVar = {
                    name: name,
                    type: type,
                    defaultValue: defaultValue,
                    tag: tag,
                };
                customVariables.push(newCustomVar);
                renderComponent(newCustomVar);
                addVariableToCanvas(tag, name, true);
                $("#variableModal").removeClass("flex").addClass("hidden");
                showToast(`Custom variable "${name}" added!`);
            } else {
                showToast("Please provide a variable name.", 2000);
            }
        });
        // --- Variable Script Ends ---

        function openExistingAILogoFilesModal(isManualTab) {
            showCustomModal(
                "Select Existing",
                `<div style="scrollbar-width: thin; scrollbar-color: #9ca3af #374151;" id="existingAILogoFilesList" class="grid grid-cols-3 gap-2 overflow-y-auto max-h-96">
                    <div id="existingAILogoFilesLoading" class="text-center col-span-3 py-4">
                        <div class="spinner-border text-blue-500" role="status"></div>
                    </div>
                </div>`,
                `<button id="closeExistingAILogoFilesModal" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Close</button>`
            );

            const $existingFilesList = $("#existingAILogoFilesList");
            $("#existingAILogoFilesLoading").removeClass("hidden");

            $.ajax({
                url: `/api/files/images?tags=logo`,
                method: "GET",
                success: function (data) {
                    $existingFilesList.empty();
                    if (data.length === 0) {
                        $existingFilesList.html(
                            '<p class="text-gray-500 text-center col-span-3">No existing background images found.</p>'
                        );
                    } else {
                        data.forEach((file) => {
                            const $fileItem = $(`
                                        <div class="relative group rounded-md overflow-hidden cursor-pointer existing-file-item" data-url="${file.url}">
                                            <img src="${file.url}" alt="Background Image" class="w-full h-20 object-contain p-1">
                                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                <i class="fas fa-check-circle text-white text-3xl"></i>
                                            </div>
                                        </div>
                                    `);
                            $existingFilesList.append($fileItem);
                        });

                        $existingFilesList
                            .off("click")
                            .on("click", ".existing-file-item", function () {
                                const selectedUrl = $(this).data("url");

                                const currentActiveTabIsManual =
                                    $("#manual-tab-btn").hasClass("border-b-2");

                                if (currentActiveTabIsManual) {
                                    $(".manual-logo-image-url").val(selectedUrl);
                                    $(".manual-bg-image-preview").attr("src", selectedUrl);
                                    $(".manual-bg-image-preview-container").removeClass(
                                        "hidden"
                                    );
                                    $(".manual-bg-upload-area").addClass("hidden");
                                } else {
                                    $(".logo-image-url").val(selectedUrl);
                                    $(".bg-image-preview").attr("src", selectedUrl);
                                    $(".bg-image-preview-container").removeClass("hidden");
                                    $(".bg-upload-area").addClass("hidden");
                                }

                                showToast("Background selected successfully!");
                                $("#customModal").removeClass("flex").addClass("hidden");
                            });
                    }
                },
                error: function (xhr, status, error) {
                    $existingFilesList.html(
                        `<p class="text-red-400 text-center col-span-3">Error loading files: ${error}</p>`
                    );
                },
                complete: function () {
                    $("#existingAILogoFilesLoading").addClass("hidden");
                },
            });

            $("#closeExistingAILogoFilesModal")
                .off("click")
                .on("click", function () {
                    $("#customModal").removeClass("flex").addClass("hidden");
                });
        }
        async function handleAILogoFileUpload(file, isManualTab) {
            const $previewContainer = isManualTab
                ? $(".manual-bg-image-preview-container")
                : $(".bg-image-preview-container");
            const $previewImg = isManualTab
                ? $(".manual-bg-image-preview")
                : $(".bg-image-preview");
            const $uploadArea = isManualTab
                ? $(".manual-bg-upload-area")
                : $(".bg-upload-area");
            // Add the missing $urlInput variable here
            const $urlInput = isManualTab
                ? $(".manual-logo-image-url")
                : $(".logo-image-url");

            showGlobalLoader();

            try {
                const formData = new FormData();
                formData.append("file", file);
                const response = await $.ajax({
                    url: "/api/files/upload/",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                });

                if (response.file && response.file.url) {
                    // This line will now work correctly
                    $urlInput.val(response.file.url);
                    $previewImg.attr("src", response.file.url);
                    $previewContainer.removeClass("hidden");
                    $uploadArea.addClass("hidden");
                    showToast("Background image uploaded successfully!");
                } else {
                    showToast("Background image upload failed. No URL returned.", 3000);
                }
            } catch (error) {
                showToast(
                    `Background image upload failed: ${error.responseText
                        ? JSON.parse(error.responseText).error
                        : error.message
                    }`,
                    3000
                );
            } finally {
                hideGlobalLoader();
            }
        }



        // Manual Ai Template Generator
        (function () {
            // Maps brand font data to the payload format expected by the AI backend.
            function mapBrandFontsToPayloadFormat(brandFontsArray) {
                const fontsPayload = {};
                if (brandFontsArray && Array.isArray(brandFontsArray)) {
                    brandFontsArray.forEach((font) => {
                        if (font.category) {
                            let fontName = font.name; // Prefer font.name if it exists

                            // If font.name is missing, try to extract from URL
                            if (!fontName && font.url) {
                                try {
                                    const urlObj = new URL(font.url);
                                    const familyParam = urlObj.searchParams.get("family");
                                    if (familyParam) {
                                        fontName = familyParam.split(":")[0].replace(/\+/g, " ");
                                    } else {
                                        // If it's a direct font name like 'Helvetica' passed as URL, use it directly
                                        const lastSlashIndex = font.url.lastIndexOf("/");
                                        const potentialFileName =
                                            lastSlashIndex !== -1
                                                ? font.url.substring(lastSlashIndex + 1)
                                                : font.url;
                                        fontName = potentialFileName.split(".")[0]; // Get name before file extension
                                    }
                                } catch (e) {
                                    // If URL parsing fails, use the raw URL as a fallback name
                                    fontName = font.url;
                                }
                            }

                            if (fontName) {
                                let key = font.category.replace(
                                    /\s(.)/g,
                                    function (match, p1) {
                                        return p1.toUpperCase();
                                    }
                                );
                                key = key.charAt(0).toLowerCase() + key.slice(1);
                                fontsPayload[key] = fontName;
                            }
                        }
                    });
                }
                return fontsPayload;
            }

            // Manual Ai Template Generator

            const automaticTabBtn = $("#automatic-tab-btn");
            const manualTabBtn = $("#manual-tab-btn");
            const automaticTabContent = $("#automatic-tab-content");
            const manualTabContent = $("#manual-tab-content");
            const generatedDesignPreview = $("#ai-generated-design-preview");
            const generatedDesignImg = $("#generated-design-img");
            const generatedDesignMessage = $("#generated-design-message");

            // Manual tab specific elements
            const manualPromptInput = $("#manual-prompt-input");
            const manualSmartModeToggle = $("#manual-smart-mode-toggle");

            // Initialize Spectrum color picker for manual mode (ensure this is still needed if colors are now from brand)
            // This is still needed for 'Custom Colors' option.
            $(
                "#manual-primary-color-picker, #manual-secondary-color-picker"
            ).spectrum({
                showInput: true,
                preferredFormat: "hex",
                showPalette: true,
                showButtons: false,
                palette: [
                    ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                    ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                    [
                        "#ea9999",
                        "#f9cb9c",
                        "#ffe599",
                        "#b6d7a8",
                        "#a2c4c9",
                        "#9fc5e8",
                        "#b4a7d6",
                        "#d5a6bd",
                    ],
                    [
                        "#e06666",
                        "#f6b26b",
                        "#ffd966",
                        "#93c47d",
                        "#76a5af",
                        "#6fa8dc",
                        "#8e7cc3",
                        "#c27ba0",
                    ],
                    [
                        "#cc0000",
                        "#e69138",
                        "#f1c232",
                        "#6aa84f",
                        "#45818e",
                        "#3d85c6",
                        "#674ea7",
                        "#a64d79",
                    ],
                    [
                        "#990000",
                        "#b45f06",
                        "#bf9000",
                        "#38761d",
                        "#134f5c",
                        "#0b5394",
                        "#351c75",
                        "#741b47",
                    ],
                    [
                        "#660000",
                        "#783f04",
                        "#7f6000",
                        "#274e13",
                        "#0c343d",
                        "#073763",
                        "#20124d",
                        "#4c1130",
                    ],
                ],
            });




            function openPublicBackgroundsModal(show = true) {
                const modal = $("#public-backgrounds-modal");
                if (show) {
                    modal.removeClass("hidden").addClass("flex");
                    fetchPublicBackgrounds();
                } else {
                    modal.removeClass("flex").addClass("hidden");
                }
            }


            function fetchPublicBackgrounds() {
                var designQuery = $("#designSearchQuery").val();

                const canvasWidth = originalCanvasWidth;
                const canvasHeight = originalCanvasHeight;

                let apiUrl = `/api/files/search?tags=${encodeURIComponent(
                    designQuery
                )}&width=${canvasWidth}&height=${canvasHeight}`;

                const $templateContainer = $("#publicBackgroundsContainer");
                $templateContainer.empty();
                $("#publicLoading").removeClass("hidden");

                $.ajax({
                    url: apiUrl,
                    method: "GET",
                    success: function (data) {
                        let designsToDisplay = [];
                        if (Array.isArray(data)) {
                            designsToDisplay = data;
                        } else if (data && typeof data === "object") {
                            designsToDisplay = [data];
                        } else {
                            designsToDisplay = [];
                        }

                        if (designsToDisplay.length === 0) {
                            $templateContainer.html(
                                '<p class="text-gray-500 text-center col-span-2">No public backgrounds found.</p>'
                            );
                        }

                        designsToDisplay.forEach((design) => {
                            const $templateWrapper = $("<div>", {
                                class: "public-wrapper relative flex group shadow-md ",
                            });

                            const $templateImage = $("<img>", {
                                class:
                                    "my-public-image h-auto rounded-md shadow-md cursor-pointer",
                                src: design.url,
                                alt: design.fileName,
                                "data-type": "design-background",
                                "data-url": design.url,
                            });

                            $templateImage.on("dragstart", function (e) {
                                const imageUrl = $(this).attr("src");

                                e.originalEvent.dataTransfer.setData("text/plain", imageUrl);
                                e.originalEvent.dataTransfer.setData("text/uri-list", imageUrl);
                                e.originalEvent.dataTransfer.setData(
                                    "text/x-type",
                                    "design-background"
                                );
                                e.originalEvent.dataTransfer.effectAllowed = "copy";
                                e.originalEvent.dataTransfer.setData(
                                    "text/x-internal-drag",
                                    "true"
                                );
                            });


                            $templateWrapper.append($templateImage);
                            $templateContainer.append($templateWrapper);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error(
                            "Error fetching public backgrounds:",
                            error,
                            "Status:",
                            status,
                            "XHR:",
                            xhr
                        );
                        showToast("Failed to load public backgrounds. Please try again.", 3000);
                    },
                    complete: function () {
                        $("#publicLoading").addClass("hidden");
                    },
                });
            }

            // Event listener for the "Public" button in the manual AI tab
            $(document).on("click", "#manual-select-public-bg-btn", function () {
                openPublicBackgroundsModal(true);
            });

            // Event listener for the close button inside the public backgrounds modal
            $(document).on("click", "#public-backgrounds-modal .modal-close-btn", function () {
                openPublicBackgroundsModal(false);
            });

            // Event listener for selecting a background from the modal
            $(document).on("click", "#publicBackgroundsContainer .my-public-image", function () {
                const selectedUrl = $(this).data("url");
                // This button is only in the manual tab, so we can directly target the manual preview area
                $(".manual-logo-image-url").val(selectedUrl);
                $(".manual-bg-image-preview").attr("src", selectedUrl);
                $(".manual-bg-image-preview-container").removeClass("hidden");
                $(".manual-bg-upload-area").addClass("hidden");

                showToast("Public background selected successfully!");
                openPublicBackgroundsModal(false); // Close the modal
            });

            // Function to switch tabs and manage button states
            function switchAITab(tabId) {
                automaticTabBtn
                    .removeClass("border-b-2 border-blue-500 text-white")
                    .addClass("text-gray-400");
                manualTabBtn
                    .removeClass("border-b-2 border-blue-500 text-white")
                    .addClass("text-gray-400");
                $(".tab-content").addClass("hidden");

                // Activate the selected tab button and show its content
                if (tabId === "automatic") {
                    automaticTabBtn
                        .addClass("border-b-2 border-blue-500 text-white")
                        .removeClass("text-gray-400");
                    automaticTabContent.removeClass("hidden");

                    $("#generate-automatic-template-btn").prop("disabled", false);
                    $("#regenerate-automatic-template-btn").prop("disabled", false);
                    $("#revise-automatic-template-btn").prop("disabled", false);
                    $("#generate-manual-template-btn").prop("disabled", true);
                    $("#regenerate-manual-template-btn").prop("disabled", true);
                    $("#revise-manual-template-btn").prop("disabled", true);
                } else if (tabId === "manual") {
                    manualTabBtn
                        .addClass("border-b-2 border-blue-500 text-white")
                        .removeClass("text-gray-400");
                    manualTabContent.removeClass("hidden");

                    $("#generate-manual-template-btn").prop("disabled", false);
                    $("#regenerate-manual-template-btn").prop("disabled", false);
                    $("#revise-manual-template-btn").prop("disabled", false);
                    $("#generate-automatic-template-btn").prop("disabled", true);
                    $("#regenerate-automatic-template-btn").prop("disabled", true);
                    $("#revise-automatic-template-btn").prop("disabled", true);
                }
                // Hide the generated design preview when switching tabs
                generatedDesignPreview.addClass("hidden");
                generatedDesignImg.attr("src", "");
                generatedDesignMessage.addClass("hidden");
            }

            // Event listeners for tab buttons
            automaticTabBtn.on("click", function () {
                switchAITab("automatic");
            });

            manualTabBtn.on("click", function () {
                switchAITab("manual");
            });

            // Set 'Manual' (Quick) tab as default on page load
            switchAITab("manual");

            // Function to handle logo file upload for AI design (automatic and manual)

            // Initialize Spectrum color pickers for AI design custom colors
            $(
                "#primary-color-picker, #secondary-color-picker, #manual-primary-color-picker, #manual-secondary-color-picker"
            ).spectrum({
                showInput: true,
                preferredFormat: "hex",
                showPalette: true,
                showButtons: false,
                palette: [
                    ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                    ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                    [
                        "#ea9999",
                        "#f9cb9c",
                        "#ffe599",
                        "#b6d7a8",
                        "#a2c4c9",
                        "#9fc5e8",
                        "#b4a7d6",
                        "#d5a6bd",
                    ],
                    [
                        "#e06666",
                        "#f6b26b",
                        "#ffd966",
                        "#93c47d",
                        "#76a5af",
                        "#6fa8dc",
                        "#8e7cc3",
                        "#c27ba0",
                    ],
                    [
                        "#cc0000",
                        "#e69138",
                        "#f1c232",
                        "#6aa84f",
                        "#45818e",
                        "#3d85c6",
                        "#674ea7",
                        "#a64d79",
                    ],
                    [
                        "#990000",
                        "#b45f06",
                        "#bf9000",
                        "#38761d",
                        "#134f5c",
                        "#0b5394",
                        "#351c75",
                        "#741b47",
                    ],
                    [
                        "#660000",
                        "#783f04",
                        "#7f6000",
                        "#274e13",
                        "#0c343d",
                        "#073763",
                        "#20124d",
                        "#4c1130",
                    ],
                ],
            });

            // Event listener for professional-brand-selector
            $("#professional-brand-selector").on("change", function () {
                if ($(this).val() === "custom") {
                    $("#custom-color-inputs").removeClass("hidden");
                } else {
                    $("#custom-color-inputs").addClass("hidden");
                }
            });

            // Event listener for manual-brand-selector
            $("#manual-brand-selector").on("change", function () {
                if ($(this).val() === "custom") {
                    $("#manual-custom-color-inputs").removeClass("hidden");
                } else {
                    $("#manual-custom-color-inputs").addClass("hidden");
                }
            });

            // Call this on document ready to populate the brand selectors
            $(document).ready(function () {
                populateAITabsBrandSelectors();
            });

            // --- Update the payload in $generateAutomaticTemplateBtn.on('click') ---

            const $certificateTypeDropdown = $("#certificate-type-dropdown");
            const $certificatePurposeInput = $("#certificate-purpose-input");
            const $eventNameInput = $("#event-name-input");
            const $professionalPromptInput = $("#professional-prompt-input");
            const $smartModeToggle = $("#smart-mode-toggle");
            const $positionPreferenceRadios = $(
                'input[name="position-preference"]'
            );
            const $generateAutomaticTemplateBtn = $(
                "#generate-automatic-template-btn"
            );
            const $aiLoadingSpinnerAutomatic = $("#ai-loading-spinner-automatic");
            const $regenerateAutomaticTemplateBtn = $(
                "#regenerate-automatic-template-btn"
            );
            const $reviseAutomaticTemplateBtn = $("#revise-automatic-template-btn");
            const $aiLoadingOverlayAutomatic = $("#ai-loading-overlay-automatic");

            // Function to generate automatic template
            $generateAutomaticTemplateBtn.on("click", async function () {
                let brandPayload = {};
                const certificateType = $certificateTypeDropdown.val();
                const purpose = $certificatePurposeInput.val();
                const eventName = $eventNameInput.val();
                const customPrompt =
                    $professionalPromptInput.val() ||
                    "Make it look prestigious with subtle gradients and centered text alignment.";
                const smartMode = $smartModeToggle.prop("checked");
                const backgroundImage =
                    $(".bg-image-preview").attr("src") ||
                    "https://mixcertificate-dev.mixcommerce.co/uploads/1726219716250-certificate_template_00002.png";
                const selectedTheme =
                    $(".ai-style-pill.border-blue-500").data("style") || "Minimalist";
                // const logoImage =
                //     $(".logo-image-url").val() ||
                //     "https://mixcertificate-dev.mixcommerce.co/uploads/1727203930884-MixCertificate.png";

                // Define default fonts
                const defaultFonts = {
                    title: "Roboto",
                    subtitle: "Roboto",
                    heading: "Roboto",
                    subheading: "Roboto",
                    sectionHeader: "Roboto",
                    body: "Roboto",
                    quote: "Great Vibes",
                    caption: "Roboto",
                    brandVoice: "Roboto",
                };

                // Start with default fonts for all categories
                brandPayload.fonts = {
                    ...defaultFonts,
                };

                // Determine brand object for the automatic tab
                const selectedProfessionalBrand = $(
                    "#professional-brand-selector"
                ).val();
                let selectedBrandData = null;

                if (
                    selectedProfessionalBrand &&
                    selectedProfessionalBrand !== "custom"
                ) {
                    selectedBrandData = allFetchedBrands.find(
                        (b) => b._id === selectedProfessionalBrand
                    );
                }

                if (selectedProfessionalBrand === "custom") {
                    brandPayload.colors = [
                        $("#primary-color-picker").spectrum("get").toHexString(),
                        $("#secondary-color-picker").spectrum("get").toHexString(),
                    ];
                    // Fonts remain default as already set in brandPayload.fonts
                } else if (selectedBrandData) {
                    // A specific brand is selected
                    // Fetch logo from the brand object
                    if (selectedBrandData.logoUrl) {
                        brandPayload.logo = selectedBrandData.logoUrl;
                    } else {
                        // Default logo if not found in brand data
                        brandPayload.logo = "https://mixcertificate-dev.mixcommerce.co/uploads/1727203930884-MixCertificate.png";
                    }

                    if (
                        selectedBrandData.colors &&
                        selectedBrandData.colors.length > 0
                    ) {
                        const defaultColor = selectedBrandData.colors.find(
                            (c) => c.version === "default"
                        );
                        const lightColor = selectedBrandData.colors.find(
                            (c) => c.version === "light"
                        );
                        const darkColor = selectedBrandData.colors.find(
                            (c) => c.version === "dark"
                        );

                        let primaryColor = defaultColor
                            ? defaultColor.hexCode
                            : selectedBrandData.colors[0]
                                ? selectedBrandData.colors[0].hexCode
                                : "#000000";
                        let secondaryColor =
                            selectedBrandData.colors.length > 1
                                ? lightColor
                                    ? lightColor.hexCode
                                    : darkColor
                                        ? darkColor.hexCode
                                        : selectedBrandData.colors[1]
                                            ? selectedBrandData.colors[1].hexCode
                                            : "#FFFFFF"
                                : primaryColor;

                        brandPayload.colors = [primaryColor, secondaryColor];
                    } else {
                        brandPayload.colors = ["#000000", "#FFFFFF"];
                    }

                    // Merge brand-specific fonts with defaults
                    if (selectedBrandData.fonts && selectedBrandData.fonts.length > 0) {
                        const mappedFonts = mapBrandFontsToPayloadFormat(
                            selectedBrandData.fonts
                        );
                        brandPayload.fonts = {
                            ...defaultFonts,
                            ...mappedFonts,
                        };
                    }
                } else {
                    brandPayload.colors = ["#000000", "#FFFFFF"];
                }

                const currentCanvasWidth = canvas.getWidth();
                const currentCanvasHeight = canvas.getHeight();
                // Construct the payload for the API request
                const payload = {
                    certificateType: certificateType || "Appreciation",
                    background: backgroundImage,
                    purpose: purpose || "Outstanding Contribution",
                    eventName: eventName || "Q2 Innovation Summit",
                    customPrompt:
                        customPrompt ||
                        "Design a modern certificate for top performance in corporate leadership",
                    theme: selectedTheme,

                    count: 1,
                    optimize: smartMode,
                    brand: brandPayload,
                    signatures: [
                        {
                            name: "Jane Smith",
                            designation: "CEO",
                        },
                        {
                            name: "Ravi Patel",
                            designation: "Director",
                        },
                    ],
                    width: currentCanvasWidth,
                    height: currentCanvasHeight,
                };

                console.log("Sending payload to backend (Professional):", payload);

                // Show loading states
                $aiLoadingSpinnerAutomatic.removeClass("hidden");
                $generatedDesignPreview.addClass("hidden");
                $generatedDesignMessage
                    .addClass("hidden")
                    .removeClass("text-red-500 text-green-400");
                $regenerateAutomaticTemplateBtn.addClass("hidden");
                $reviseAutomaticTemplateBtn.addClass("hidden");

                // Use the specific loader for this section
                $aiLoadingOverlayAutomatic.removeClass("hidden");

                $(
                    "#automatic-tab-content input, #automatic-tab-content select, #automatic-tab-content button"
                ).prop("disabled", true);
                $(this).prop("disabled", true);

                try {
                    const response = await $.ajax({
                        url: "http://localhost:8501/api/template-generator/multiple/professional",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(payload),
                    });

                    console.log(
                        "Received response from backend (Professional):",
                        response
                    );

                    $aiLoadingSpinnerAutomatic.addClass("hidden");
                    $generatedDesignMessage
                        .removeClass("hidden")
                        .text("Template generated successfully!")
                        .addClass("text-green-400");

                    if (
                        response &&
                        response.designs &&
                        Array.isArray(response.designs) &&
                        response.designs.length > 0
                    ) {
                        displayAIDesigns(response.designs); // Populate the preview grid with all designs

                        $generatedDesignPreview.removeClass("hidden");
                    } else {
                        console.warn(
                            "No valid 'designs' array found in the AI response (Automatic)."
                        );
                        $generatedDesignPreview.removeClass("hidden");
                        $("#ai-design-previews-grid").empty();
                        showToast(
                            "No designs were generated or the response format was unexpected.",
                            "warn"
                        );
                    }

                    // Re-enable action buttons
                    $regenerateAutomaticTemplateBtn.removeClass("hidden");
                    $reviseAutomaticTemplateBtn.removeClass("hidden");
                } catch (xhr) {
                    $aiLoadingSpinnerAutomatic.addClass("hidden");

                    let errorMessage =
                        "Failed to generate automatic template. Please try again.";
                    if (xhr && xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    } else if (xhr && xhr.responseText) {
                        try {
                            errorMessage =
                                JSON.parse(xhr.responseText).error || xhr.responseText;
                        } catch (parseError) {
                            errorMessage = xhr.responseText;
                        }
                    } else if (xhr && xhr.status) {
                        errorMessage = `Request failed with status ${xhr.status}: ${xhr.statusText || "Unknown Error"
                            }`;
                    } else {
                        errorMessage =
                            "A network error or CORS issue prevented the request. Please check your console.";
                    }

                    // Ensure the preview area is visible to show the message
                    $generatedDesignPreview.removeClass("hidden");
                    $generatedDesignMessage
                        .removeClass("hidden")
                        .text(`Error: ${errorMessage}`)
                        .addClass("text-red-500");
                    console.error("AJAX Error (Automatic):", xhr);
                    $regenerateAutomaticTemplateBtn.removeClass("hidden"); // Still allow regeneration
                } finally {
                    // Hide the specific loader for this section
                    $aiLoadingOverlayAutomatic.addClass("hidden");
                    // Ensure all controls are re-enabled regardless of success or failure
                    $(
                        "#automatic-tab-content input, #automatic-tab-content select, #automatic-tab-content button"
                    ).prop("disabled", false);
                    $(this).prop("disabled", false);
                }
            });
            const $generateManualTemplateBtn = $("#generate-manual-template-btn");
            const $aiLoadingOverlayManual = $("#ai-loading-overlay-manual");

            // Function to generate manual template
            $generateManualTemplateBtn.on("click", async function () {
                let manualBrandPayload = {};

                const manualPrompt =
                    $("#manual-prompt-input").val() ||
                    "Design a modern certificate for top performance in corporate leadership";

                // Define the fallback logo and background separately and clearly.
                const fallbackLogo = "https://mixcertificate-dev.mixcommerce.co/uploads/1727203930884-MixCertificate.png";
                const fallbackBackground = "https://mixcertificate-dev.mixcommerce.co/uploads/1726219716250-certificate_template_00002.png";

                // This is where we will determine the final logo URL.
                let finalLogoImage = fallbackLogo;

                // This is where we get the user-selected background.
                const manualBackgroundImage = $(".manual-bg-image-preview").attr("src") || fallbackBackground;

                // Default fonts payload
                const defaultFonts = {
                    title: "Roboto",
                    subtitle: "Roboto",
                    heading: "Roboto",
                    subheading: "Roboto",
                    sectionHeader: "Roboto",
                    body: "Roboto",
                    quote: "Great Vibes",
                    caption: "Roboto",
                    brandVoice: "Roboto",
                };
                manualBrandPayload.fonts = { ...defaultFonts };

                // Get the selected brand or check if it's "custom"
                const selectedManualBrand = $("#manual-brand-selector").val();
                let selectedBrandData = null;

                if (selectedManualBrand && selectedManualBrand !== "custom") {
                    selectedBrandData = allFetchedBrands.find(
                        (b) => b._id === selectedManualBrand
                    );
                }

                // Logic to set colors and fonts based on brand selection
                if (selectedManualBrand === "custom") {
                    manualBrandPayload.colors = [
                        $("#manual-primary-color-picker").spectrum("get").toHexString(),
                        $("#manual-secondary-color-picker").spectrum("get").toHexString(),
                    ];
                    // For custom, get the logo from the specific input field
                    finalLogoImage = $(".manual-logo-image-url").val() || fallbackLogo;
                    manualBrandPayload.logo = finalLogoImage;
                } else if (selectedBrandData) {
                    // If a brand is selected, use its logo, colors, and fonts
                    finalLogoImage = selectedBrandData.logo || fallbackLogo;
                    manualBrandPayload.logo = finalLogoImage;

                    // Apply brand colors
                    if (selectedBrandData.colors && selectedBrandData.colors.length > 0) {
                        const defaultColor = selectedBrandData.colors.find(
                            (c) => c.version === "default"
                        );
                        const lightColor = selectedBrandData.colors.find(
                            (c) => c.version === "light"
                        );
                        const darkColor = selectedBrandData.colors.find(
                            (c) => c.version === "dark"
                        );
                        let primaryColor = defaultColor ? defaultColor.hexCode : selectedBrandData.colors[0]?.hexCode || "#000";
                        let secondaryColor = selectedBrandData.colors.length > 1 ? lightColor?.hexCode || darkColor?.hexCode || selectedBrandData.colors[1]?.hexCode || "#FFFFFF" : primaryColor;
                        manualBrandPayload.colors = [primaryColor, secondaryColor];
                    } else {
                        manualBrandPayload.colors = ["#000", "#FFFFFF"];
                    }

                    // Apply brand fonts
                    if (selectedBrandData.fonts && selectedBrandData.fonts.length > 0) {
                        const mappedFonts = mapBrandFontsToPayloadFormat(
                            selectedBrandData.fonts
                        );
                        manualBrandPayload.fonts = { ...defaultFonts, ...mappedFonts };
                    }
                } else {
                    // Default values for "no brand selected"
                    manualBrandPayload.colors = ["#000", "#FFFFFF"];
                    manualBrandPayload.logo = finalLogoImage;
                }

                const currentCanvasWidth = canvas.getWidth();
                const currentCanvasHeight = canvas.getHeight();
                const manualSmartMode = $("#manual-smart-mode-toggle").prop("checked");

                const payload = {
                    prompt: manualPrompt,
                    brand: manualBrandPayload,
                    optimize: manualSmartMode,
                    width: currentCanvasWidth,
                    height: currentCanvasHeight,
                    count: 1,
                    background: manualBackgroundImage,
                };

                console.log("Sending payload to backend (Quick):", payload);


                $aiLoadingOverlayManual.removeClass("hidden");
                $generatedDesignPreview.addClass("hidden");
                $generatedDesignMessage
                    .addClass("hidden")
                    .removeClass("text-red-500 text-green-400");
                $("#regenerate-manual-template-btn").addClass("hidden");
                $("#revise-manual-template-btn").addClass("hidden");

                $(
                    "#manual-tab-content input, #manual-tab-content select, #manual-tab-content button"
                ).prop("disabled", true);
                $(this).prop("disabled", true);

                try {
                    const response = await $.ajax({
                        url: "http://localhost:8501/api/template-generator/multiple/quick",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(payload),
                    });

                    console.log("Received response from backend (Manual):", response);

                    $aiLoadingOverlayManual.addClass("hidden");
                    $generatedDesignPreview.removeClass("hidden");
                    $generatedDesignMessage
                        .removeClass("hidden")
                        .text("Select a design to apply to your canvas.")
                        .addClass("text-green-400");

                    if (response.designs && response.designs.length > 0) {
                        displayAIDesigns(response.designs);
                    } else {
                        $generatedDesignMessage
                            .text("No designs returned by AI. Please try again.")
                            .addClass("text-red-500");
                    }

                    $("#regenerate-manual-template-btn").removeClass("hidden");
                    $("#revise-manual-template-btn").removeClass("hidden");
                } catch (xhr) {
                    $aiLoadingOverlayManual.addClass("hidden");

                    let errorMessage =
                        "Failed to generate manual template. Please try again.";
                    if (xhr && xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    } else if (xhr && xhr.responseText) {
                        try {
                            errorMessage =
                                JSON.parse(xhr.responseText).error || xhr.responseText;
                        } catch (parseError) {
                            errorMessage = xhr.responseText;
                        }
                    } else if (xhr && xhr.status) {
                        errorMessage = `Request failed with status ${xhr.status}: ${xhr.statusText || "Unknown Error"
                            }`;
                    } else {
                        errorMessage =
                            "A network error or CORS issue prevented the request. Please check your console.";
                    }

                    $generatedDesignPreview.removeClass("hidden");
                    $generatedDesignMessage
                        .removeClass("hidden")
                        .text(`Error: ${errorMessage}`)
                        .addClass("text-red-500");
                    console.error("AJAX Error (Manual):", xhr);
                    $("#regenerate-manual-template-btn").removeClass("hidden");
                } finally {
                    $(
                        "#manual-tab-content input, #manual-tab-content select, #manual-tab-content button"
                    ).prop("disabled", false);
                    $(this).prop("disabled", false);
                }
            });

            // Regenerate and Revise Logic for Manual Tab
            $("#regenerate-manual-template-btn").on("click", function () {
                console.log("Regenerating manual template...");
                $generateManualTemplateBtn.click();
            });

            $("#revise-manual-template-btn").on("click", function () {
                showToast(
                    "Revise Manual Design functionality would typically involve adjusting prompt/inputs and re-generating.",
                    4000
                );
                console.log("Revise manual design initiated (placeholder).");
            });
        })();

        // Function to load fonts before rendering the canvas
        async function loadFonts(fontFamilies) {
            return new Promise((resolve) => {
                // Check if WebFont is available
                if (typeof WebFont === "undefined") {
                    console.warn(
                        "WebFont Loader not found. Text might not render correctly if custom fonts are used."
                    );
                    return resolve();
                }

                WebFont.load({
                    google: {
                        families: fontFamilies,
                    },
                    active: function () {
                        console.log("Fonts loaded successfully:", fontFamilies);
                        resolve();
                    },
                    inactive: function () {
                        console.warn("Some fonts could not be loaded:", fontFamilies);
                        resolve();
                    },
                    timeout: 5000,
                });
            });
        }

        async function displayAIDesigns(
            designs,
            $previewsGrid,
            $loadingSpinner,
            $messageArea
        ) {
            console.log("displayAIDesigns: Function started");
            // Corrected IDs to match the provided HTML
            $previewsGrid = $previewsGrid || $("#ai-design-previews-grid");
            $loadingSpinner = $loadingSpinner || $("#aiLoadingOverlayManual");
            $messageArea = $messageArea || $("#generatedDesignMessage");

            try {
                if (
                    !$previewsGrid.length ||
                    !$loadingSpinner.length ||
                    !$messageArea.length
                ) {
                    console.error(
                        "Required DOM elements not found for displayAIDesigns"
                    );
                    throw new Error("Required DOM elements not found");
                }

                $previewsGrid.empty().removeClass("hidden");
                $messageArea
                    .addClass("hidden")
                    .removeClass("text-red-500 text-green-400");
                $loadingSpinner.removeClass("hidden");

                if (!designs?.length) {
                    $messageArea
                        .text("No designs were generated")
                        .removeClass("hidden")
                        .addClass("text-red-500");
                    $loadingSpinner.addClass("hidden");
                    return;
                }

                const previewCards = await Promise.all(
                    designs.map((design, index) =>
                        createDesignPreviewCard(design, index)
                    )
                );

                $previewsGrid.append(previewCards);
                $messageArea
                    .text(`${designs.length} designs loaded`)
                    .removeClass("hidden")
                    .addClass("text-green-400");
            } catch (error) {
                console.error("displayAIDesigns error:", error);
                $messageArea
                    .text("Error loading designs: " + error.message)
                    .removeClass("hidden")
                    .addClass("text-red-500");
            } finally {
                $loadingSpinner.addClass("hidden");
            }
        }

        async function createDesignPreviewCard(design, index) {
            console.log(
                `createDesignPreviewCard: Creating card for design ${index}`
            );
            const $card = $(`
        <div class="preview-card relative rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-all" >
            <div class="preview-card-image-wrapper">
                <img class="preview-card-image" alt="Design ${index + 1
                }" loading="lazy" style="opacity: 0;">
                <div class="absolute inset-0 flex items-center justify-center bg-gray-200 text-gray-500 text-sm loading-spinner-overlay">
                    <div class="spinner"></div>
                </div>
            </div>
            
        </div>
    `);

            const $img = $card.find(".preview-card-image");
            const $loadingOverlay = $card.find(".loading-spinner-overlay");


            $card.on("dragstart", function (e) {
                const designData = JSON.stringify(design);
                e.originalEvent.dataTransfer.setData("text/x-type", "ai-design");
                e.originalEvent.dataTransfer.setData("application/json", designData);
                e.originalEvent.dataTransfer.setData("text/plain", designData);
                e.originalEvent.dataTransfer.effectAllowed = "copy";
                e.originalEvent.dataTransfer.setData("text/x-internal-drag", "true");
            });



            try {
                console.log(
                    `createDesignPreviewCard: Generating preview URL for design ${index}`
                );
                const previewUrl = design.previewImageBase64
                    ? `data:image/png;base64,${design.previewImageBase64}`
                    : await generateDesignPreview(design);

                $img.attr("src", previewUrl);
                // Fade in the image once loaded
                $img
                    .on("load", () => {
                        $img.css("opacity", 1);
                        $loadingOverlay.hide();
                    })
                    .on("error", () => {
                        console.error(
                            `createDesignPreviewCard: Failed to load image for design ${index}`
                        );
                        $img.attr(
                            "src",
                            "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZmIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzAwMCI+UHJldmlldyBFcnJvcjwvdGV4dD48L2N2Zz4="
                        );
                        $img.css("opacity", 1);
                        $loadingOverlay.hide();
                    });

                $card.data("design", JSON.stringify(design));

                $card.on("click", () => {
                    console.log(
                        `createDesignPreviewCard: Card for design ${index} clicked.`
                    );
                    const designData = JSON.parse($card.data("design"));
                    loadAIDesignToMainCanvas(designData);
                });
            } catch (error) {
                console.error(
                    `createDesignPreviewCard: Error generating preview for design ${index}:`,
                    error
                );
                $img.attr(
                    "src",
                    "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZmIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzAwMCI+UHJldmlldyBFcnJvcjwvdGV4dD48L2N2Zz4="
                );
                $img.css("opacity", 1);
                $loadingOverlay.hide();
            }
            return $card[0];
        }


        async function generateDesignPreview(design) {
            const PREVIEW_WIDTH = 600;
            const PREVIEW_HEIGHT = 450;

            const canvasEl = document.createElement("canvas");
            canvasEl.width = PREVIEW_WIDTH;
            canvasEl.height = PREVIEW_HEIGHT;
            canvasEl.style.position = "absolute";
            canvasEl.style.left = "-9999px";
            canvasEl.style.top = "-9999px";
            document.body.appendChild(canvasEl);

            try {
                const previewCanvas = new fabric.StaticCanvas(canvasEl, {
                    backgroundColor: "#FFFFFF",
                });

                // Load fonts if needed
                const fontFamilies = new Set();
                for (const obj of design.objects) {
                    if (
                        (obj.type === "text" || obj.type === "i-text" || obj.type === "textbox") &&
                        obj.fontFamily
                    ) {
                        fontFamilies.add(obj.fontFamily);
                    }
                }
                if (fontFamilies.size > 0 && typeof loadFonts === "function") {
                    await loadFonts(Array.from(fontFamilies));
                }

                const designWidth = Number(design.width) || 800;
                const designHeight = Number(design.height) || 600;

                // Slightly more aggressive scale for large designs
                const widthRatio = PREVIEW_WIDTH / designWidth;
                const heightRatio = PREVIEW_HEIGHT / designHeight;
                const scale = Math.min(widthRatio, heightRatio) * (designWidth > 2000 ? 3.7 : 1.25);

                // --- 1. Set background image as true background, scaled to COVER preview ---
                if (design.backgroundImage) {
                    await new Promise((resolve) => {
                        fabric.Image.fromURL(
                            design.backgroundImage,
                            (img) => {
                                const scaleX = PREVIEW_WIDTH / img.width;
                                const scaleY = PREVIEW_HEIGHT / img.height;
                                const bgScale = Math.max(scaleX, scaleY);
                                img.set({
                                    left: 0,
                                    top: 0,
                                    scaleX: bgScale,
                                    scaleY: bgScale,
                                    selectable: false,
                                    evented: false,
                                    originX: "left",
                                    originY: "top",
                                });
                                previewCanvas.setBackgroundImage(
                                    img,
                                    previewCanvas.renderAll.bind(previewCanvas)
                                );
                                resolve();
                            },
                            { crossOrigin: "anonymous" }
                        );
                    });
                }

                // --- 2. Prepare all objects, scale and collect bounding box ---
                let minLeft = Infinity, minTop = Infinity, maxRight = -Infinity, maxBottom = -Infinity;
                const tempObjects = [];

                for (const obj of design.objects) {
                    let fabricObj = null;
                    if (obj.type === "image" && obj.src) {
                        fabricObj = await new Promise((resolve) => {
                            fabric.Image.fromURL(
                                obj.src,
                                (img) => {
                                    // Apply both the preview scale and the object's scaleX/scaleY (like Fabric.js selector)
                                    const objScaleX = typeof obj.scaleX === "number" ? obj.scaleX : 1;
                                    const objScaleY = typeof obj.scaleY === "number" ? obj.scaleY : 1;
                                    const imageScale = 0.6 * scale;
                                    img.set({
                                        left: (obj.left || 0) * scale,
                                        top: (obj.top || 0) * scale,
                                        originX: obj.originX || "left",
                                        originY: obj.originY || "top",
                                        scaleX: objScaleX * imageScale,
                                        scaleY: objScaleY * imageScale,
                                        selectable: false,
                                        evented: false,
                                    });
                                    resolve(img);
                                },
                                { crossOrigin: "anonymous" }
                            );
                        });
                    } else if (["text", "i-text", "textbox"].includes(obj.type)) {
                        const baseFontSize = Number(obj.fontSize) || 16;
                        const scaledFontSize = Math.max(baseFontSize * scale, 18);

                        fabricObj = new fabric.IText(obj.text || "", {
                            left: (obj.left || 0) * scale,
                            top: (obj.top || 0) * scale,
                            fontSize: scaledFontSize,
                            textAlign: obj.textAlign || "center",
                            originX: obj.originX || "left",
                            originY: obj.originY || "top",
                            width: obj.width ? obj.width * scale : undefined,
                            fill: obj.fill || "#000000",
                            fontFamily: obj.fontFamily || "Roboto",
                            fontWeight: obj.fontWeight || "normal",
                            fontStyle: obj.fontStyle || "normal",
                        });
                    } else if (
                        ["rect", "circle", "ellipse", "polygon", "line", "triangle"].includes(obj.type)
                    ) {
                        const shapeProps = {
                            ...obj,
                            left: (obj.left || 0) * scale,
                            top: (obj.top || 0) * scale,
                            scaleX: (obj.scaleX || 1) * scale,
                            scaleY: (obj.scaleY || 1) * scale,
                            strokeWidth: obj.strokeWidth ? obj.strokeWidth * scale : undefined,
                        };
                        if (obj.radius) shapeProps.radius = obj.radius * scale;
                        if (obj.rx) shapeProps.rx = obj.rx * scale;
                        if (obj.ry) shapeProps.ry = obj.ry * scale;
                        fabricObj = fabric.util.createObject(shapeProps);
                    }
                    if (fabricObj) {
                        tempObjects.push(fabricObj);
                        // Calculate bounding box for centering (horizontal only)
                        const bounds = fabricObj.getBoundingRect();
                        minLeft = Math.min(minLeft, bounds.left);
                        maxRight = Math.max(maxRight, bounds.left + bounds.width);
                    }
                }

                // --- 3. Calculate group offset for horizontal centering only ---
                const groupWidth = maxRight - minLeft;
                const groupOffsetX = (PREVIEW_WIDTH - groupWidth) / 2 - minLeft;

                // --- 4. Add all objects to canvas, horizontally centered ---
                for (const obj of tempObjects) {
                    obj.left += groupOffsetX;
                    previewCanvas.add(obj);
                }

                previewCanvas.renderAll();

                const dataUrl = previewCanvas.toDataURL({
                    format: "png",
                    quality: 1,
                });

                return dataUrl;
            } catch (error) {
                console.error("generateDesignPreview error:", error);
                return "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjRjBGMEYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjUwIiBmaWxsPSIjNkM2RDZDIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5QcmV2aWV3IEZhaWxlZDwvdGV4dD48L3N2Zz4=";
            } finally {
                canvasEl.remove();
            }
        }

        async function loadAIDesignToMainCanvas(designData) {
            if (typeof fabric === 'undefined' || !fabric || !canvas) {
                showToast("Fabric.js or Canvas not initialized. Cannot load design.", "error");
                console.error(" Fabric.js or canvas object is null or undefined.");
                return;
            }

            showGlobalLoader();
            try {
                canvas.clear();
                canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
                canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));

                const designWidth = ensureNumber(designData.width, 800);
                const designHeight = ensureNumber(designData.height, 600);

                canvas.setDimensions({ width: designWidth, height: designHeight });

                // --- Set background image as true background (cover) ---
                let backgroundUrl = designData.backgroundImage || designData.background;
                if (backgroundUrl) {
                    if (
                        backgroundUrl.startsWith('http') ||
                        backgroundUrl.startsWith('data:') ||
                        backgroundUrl.startsWith('/')
                    ) {
                        fabric.Image.fromURL(backgroundUrl, (img) => {
                            img.set({
                                left: 0,
                                top: 0,
                                scaleX: designWidth / img.width,
                                scaleY: designHeight / img.height,
                                originX: 'left',
                                originY: 'top',
                                selectable: false,
                                evented: false,
                            });
                            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                        }, { crossOrigin: "anonymous" });
                    } else if (CSS.supports('color', backgroundUrl)) {
                        canvas.setBackgroundColor(backgroundUrl, canvas.renderAll.bind(canvas));
                    }
                }

                // --- Dynamic font size scaling ---
                const baseWidth = 800;
                const scale = designWidth > 2000 ? (designWidth / baseWidth) * 0.9 : 0.8;

                // Prepare objects
                const designObjectsToLoad = (designData.objects || []).slice();

                // --- Signature grouping logic ---
                // Find signature name/title pairs
                const signaturePairs = [];
                const usedSignatureIndexes = new Set();
                for (let i = 0; i < designObjectsToLoad.length; i++) {
                    const obj = designObjectsToLoad[i];
                    if (
                        ["text", "i-text", "textbox"].includes(obj.type) &&
                        /signature\s*name/i.test(obj.text || "")
                    ) {
                        // Try to find the next "signature title" object
                        const nextObj = designObjectsToLoad[i + 1];
                        if (
                            nextObj &&
                            ["text", "i-text", "textbox"].includes(nextObj.type) &&
                            /signature\s*title/i.test(nextObj.text || "")
                        ) {
                            signaturePairs.push([obj, nextObj]);
                            usedSignatureIndexes.add(i);
                            usedSignatureIndexes.add(i + 1);
                            i++; // Skip the next one, it's part of this pair
                        } else {
                            signaturePairs.push([obj]);
                            usedSignatureIndexes.add(i);
                        }
                    }
                }

                // Remove signature objects from main list so they don't render twice
                const nonSignatureObjects = designObjectsToLoad.filter(
                    (obj, idx) => !usedSignatureIndexes.has(idx)
                );

                // --- Render non-signature objects as usual ---
                for (const obj of nonSignatureObjects) {
                    let fabricObj = null;

                    if (obj.type === "image" && obj.src) {
                        fabricObj = await new Promise((resolve) => {
                            fabric.Image.fromURL(
                                obj.src,
                                (img) => {
                                    const objScaleX = typeof obj.scaleX === "number" ? obj.scaleX : 1;
                                    const objScaleY = typeof obj.scaleY === "number" ? obj.scaleY : 1;
                                    const imageScale = 0.6 * scale;
                                    img.set({
                                        left: ensureNumber(obj.left, 0) * scale,
                                        top: ensureNumber(obj.top, 0) * scale,
                                        originX: obj.originX || "left",
                                        originY: obj.originY || "top",
                                        scaleX: objScaleX * imageScale,
                                        scaleY: objScaleY * imageScale,
                                        selectable: true,
                                        evented: true,
                                    });
                                    resolve(img);
                                },
                                { crossOrigin: "anonymous" }
                            );
                        });
                    }
                    else if (["text", "i-text", "textbox"].includes(obj.type)) {
                        const baseFontSize = Number(obj.fontSize) || 16;
                        let scaledFontSize = Math.max(baseFontSize * scale, 12);

                        // Add extra line height for headings or specific text
                        let lineHeight = 1.1;
                        if (
                            /q2 innovation summit/i.test(obj.text || "") ||
                            (obj.textRole && ["heading", "subheading"].includes(obj.textRole))
                        ) {
                            lineHeight = 1.3;
                        }

                        // Dynamically set width: longer text gets more width

                        let textWidth = ensureNumber(obj.width, Math.min(designWidth * 0.92, 1200));
                        if (
                            (obj.textRole && ["heading", "body-text", "subheading"].includes(obj.textRole) &&
                                (/date/i.test(obj.text || "") || /awarded to/i.test(obj.text || "")))
                            || /date|awarded to/i.test(obj.text || "")
                        ) {
                            textWidth = designWidth * 0.92;
                        } else if ((obj.text || "").length > 40) {
                            textWidth = designWidth * 0.9;
                        } else if ((obj.text || "").length > 20) {
                            textWidth = designWidth * 0.8;
                        }

                        fabricObj = new fabric.Textbox(obj.text || "", {
                            left: ensureNumber(obj.left, 0) * scale,
                            top: ensureNumber(obj.top, 0) * scale,
                            fontSize: scaledFontSize,
                            lineHeight: lineHeight,
                            textAlign: obj.textAlign || "center",
                            originX: obj.originX || "left",
                            originY: obj.originY || "top",
                            width: textWidth,
                            fill: obj.fill || "#000000",
                            fontFamily: obj.fontFamily || "Roboto",
                            fontWeight: obj.fontWeight || "normal",
                            fontStyle: obj.fontStyle || "normal",
                            selectable: true,
                            evented: true,
                        });
                    }
                    else if (
                        ["rect", "circle", "ellipse", "polygon", "line", "triangle"].includes(obj.type)
                    ) {
                        const shapeProps = {
                            ...obj,
                            left: ensureNumber(obj.left, 0) * scale,
                            top: ensureNumber(obj.top, 0) * scale,
                            scaleX: (obj.scaleX || 1) * scale,
                            scaleY: (obj.scaleY || 1) * scale,
                            strokeWidth: obj.strokeWidth ? obj.strokeWidth * scale : undefined,
                        };
                        if (obj.radius) shapeProps.radius = obj.radius * scale;
                        if (obj.rx) shapeProps.rx = obj.rx * scale;
                        if (obj.ry) shapeProps.ry = obj.ry * scale;
                        fabricObj = fabric.util.createObject(shapeProps);
                    }
                    if (fabricObj) {
                        canvas.add(fabricObj);
                    }
                }

                // --- Render signature groups ---
                if (signaturePairs.length > 0) {
                    const sigCount = signaturePairs.length;
                    const section = designWidth / (sigCount + 1);
                    const sigTop = designHeight - 80 * scale; // Adjust as needed

                    for (let i = 0; i < signaturePairs.length; i++) {
                        const [nameObj, titleObj] = signaturePairs[i];
                        const sigGroupObjects = [];

                        // Signature Name
                        const nameText = new fabric.Textbox(nameObj.text || "", {
                            fontSize: Math.max(Number(nameObj.fontSize) * scale, 14),
                            fontFamily: nameObj.fontFamily || "Roboto",
                            fill: nameObj.fill || "#000000",
                            textAlign: "center",
                            originX: "center",
                            originY: "top",
                            width: designWidth * 0.22,
                            editable: false,
                            selectable: false,
                        });
                        sigGroupObjects.push(nameText);

                        // Signature Title (if present)
                        if (titleObj) {
                            const titleText = new fabric.Textbox(titleObj.text || "", {
                                fontSize: Math.max(Number(titleObj.fontSize) * scale, 12),
                                fontFamily: titleObj.fontFamily || "Roboto",
                                fill: titleObj.fill || "#000000",
                                textAlign: "center",
                                originX: "center",
                                originY: "top",
                                width: designWidth * 0.22,
                                editable: false,
                                selectable: false,
                                top: nameText.height + 2, // small gap below name
                            });
                            sigGroupObjects.push(titleText);
                        }

                        // Group them vertically
                        const sigGroup = new fabric.Group(sigGroupObjects, {
                            left: section * (i + 1),
                            top: sigTop,
                            originX: "center",
                            originY: "top",
                            selectable: true,
                            evented: true,
                        });

                        canvas.add(sigGroup);
                    }
                }

                canvas.renderAll();
                applyCanvasTransformations?.();
                showToast("Design loaded successfully!");

            } catch (error) {
                console.error(" Design load error:", error);
                showToast("Error loading design", "error");
            } finally {
                hideGlobalLoader();
            }
        }




        const ensureNumber = (value, fallback = 0) => {
            const num = parseFloat(value);
            return isNaN(num) ? fallback : num;
        };

        async function loadFonts(fontFamilies) {
            return new Promise((resolve) => {
                resolve();
            });
        };

        function getContrastingColor(backgroundColor) {
            if (!backgroundColor || typeof backgroundColor !== 'string') return '#000000';

            let color = backgroundColor;
            if (color.startsWith('#')) {
                const hex = color.slice(1);
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance > 0.5 ? '#000000' : '#FFFFFF';
            }

            const rgbMatch = color.match(/\d+/g);
            if (rgbMatch && rgbMatch.length >= 3) {
                const [r, g, b] = rgbMatch.map(Number);
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance > 0.5 ? '#000000' : '#FFFFFF';
            }

            return '#000000';
        }




        $(document).on("change", ".logo-file-upload-input", function (e) {
            if (e.target.files.length > 0) {
                handleAILogoFileUpload(e.target.files[0], false);
            }
        });

        $(document).on("click", ".select-existing-bg-btn", function () {
            openExistingAILogoFilesModal(false);
        });

        $(document).on("click", ".remove-bg-image-btn", function () {
            $(".logo-image-url").val("");
            $(".bg-image-preview").attr("src", "");
            $(".bg-image-preview-container").addClass("hidden");
            $(".bg-upload-area").removeClass("hidden");
            showToast("Logo removed.");
        });

        // Drag and drop for Automatic tab logo upload area
        $(".bg-upload-area").each(function () {
            const $this = $(this);
            ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
                $this.on(eventName, function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ["dragenter", "dragover"].forEach((eventName) => {
                $this.on(eventName, function () {
                    $this.addClass("border-blue-500");
                });
            });

            ["dragleave", "drop"].forEach((eventName) => {
                $this.on(eventName, function () {
                    $this.removeClass("border-blue-500");
                });
            });

            $this.on("drop", function (e) {
                const dt = e.originalEvent.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleAILogoFileUpload(files[0], false);
                }
            });
        });



        // Event listeners for Manual tab logo upload
        $(document).on("click", ".manual-select-existing-bg-btn", function () {
            openExistingAILogoFilesModal(true);
        });


        $(document).on("change", ".manual-logo-file-upload-input", function (e) {
            if (e.target.files.length > 0) {
                handleAILogoFileUpload(e.target.files[0], true);
            }
        });

        $(document).on("click", ".manual-select-existing-bg-btn", function () {
            openExistingAILogoFilesModal(true);
        });

        $(document).on("click", ".manual-remove-bg-image-btn", function () {
            $(".manual-logo-image-url").val("");
            $(".manual-bg-image-preview").attr("src", "");
            $(".manual-bg-image-preview-container").addClass("hidden");
            $(".manual-bg-upload-area").removeClass("hidden");
            showToast("Logo removed.");
        });

        // Drag and drop for Manual tab logo upload area
        $(".manual-bg-upload-area").each(function () {
            const $this = $(this);
            ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
                $this.on(eventName, function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ["dragenter", "dragover"].forEach((eventName) => {
                $this.on(eventName, function () {
                    $this.addClass("border-blue-500");
                });
            });

            ["dragleave", "drop"].forEach((eventName) => {
                $this.on(eventName, function () {
                    $this.removeClass("border-blue-500");
                });
            });

            $this.on("drop", function (e) {
                const dt = e.originalEvent.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleAILogoFileUpload(files[0], true);
                }
            });
        });

        // Function to handle tab switching in the Elements sidebar
        function setupElementsTabs() {
            // Get references to tab buttons
            const shapesTabBtn = document.getElementById("shapes-tab-btn");
            const iconsTabBtn = document.getElementById("icons-tab-btn");
            const framesTabBtn = document.getElementById("frames-tab-btn");
            const stickersGifsTabBtn = document.getElementById(
                "stickers-gifs-tab-btn"
            );

            // Get references to tab content panels
            const shapesTabPanel = document.getElementById("shapes-tab-panel");
            const iconsTabPanel = document.getElementById("icons-tab-panel");
            const framesTabPanel = document.getElementById("frames-tab-panel");
            const stickersGifsTabPanel = document.getElementById(
                "stickers-gifs-tab-panel"
            );

            // Store all tab buttons and panels for easier iteration
            const tabButtons = [
                shapesTabBtn,
                iconsTabBtn,
                framesTabBtn,
                stickersGifsTabBtn,
            ];
            const tabPanels = [
                shapesTabPanel,
                iconsTabPanel,
                framesTabPanel,
                stickersGifsTabPanel,
            ];

            // Function to activate a specific tab
            function activateTab(activeButton, activePanel) {
                // Deactivate all tab buttons and hide all panels
                tabButtons.forEach((btn) => {
                    btn.classList.remove("border-blue-500", "text-white");
                    btn.classList.add("border-transparent", "text-gray-400");
                });
                tabPanels.forEach((panel) => panel.classList.add("hidden"));

                // Activate the clicked button and show its corresponding panel
                activeButton.classList.remove("border-transparent", "text-gray-400");
                activeButton.classList.add("border-blue-500", "text-white");
                activePanel.classList.remove("hidden");
            }

            // Add event listeners to each tab button
            if (shapesTabBtn) {
                shapesTabBtn.addEventListener("click", () =>
                    activateTab(shapesTabBtn, shapesTabPanel)
                );
            }
            if (iconsTabBtn) {
                iconsTabBtn.addEventListener("click", () =>
                    activateTab(iconsTabBtn, iconsTabPanel)
                );
            }
            if (framesTabBtn) {
                framesTabBtn.addEventListener("click", () =>
                    activateTab(framesTabBtn, framesTabPanel)
                );
            }
            if (stickersGifsTabBtn) {
                stickersGifsTabBtn.addEventListener("click", () =>
                    activateTab(stickersGifsTabBtn, stickersGifsTabPanel)
                );
            }

            if (shapesTabBtn && shapesTabPanel) {
                activateTab(shapesTabBtn, shapesTabPanel);
            }
        }

        // Call the setupElementsTabs function when the DOM is fully loaded
        document.addEventListener("DOMContentLoaded", setupElementsTabs);

        //Automatic Ai Template Generation
        const $signaturesContainer = $("#signatures-container");

        // --- Selectors for Automatic Tab Inputs ---
        const $certificateTypeDropdown = $("#certificate-type-dropdown");
        const $certificatePurposeInput = $("#certificate-purpose-input");
        const $eventNameInput = $("#event-name-input");
        const $logoImageUrlInput = $("#logo-image-url-input");
        const $numSignaturesInput = $("#num-signatures-input");
        const $stylePills = $(".ai-style-pill");
        const $brandColorPicker = $("#brand-color-picker");
        const $smartModeToggle = $("#smart-mode-toggle");
        const $positionPreferenceRadios = $('input[name="position-preference"]');
        const $professionalPromptInput = $("#professional-prompt-input");
        // --- Selectors for Automatic Generation Buttons & Feedback ---
        const $generateAutomaticTemplateBtn = $(
            "#generate-automatic-template-btn"
        );
        const $aiLoadingSpinnerAutomatic = $("#ai-loading-spinner-automatic");
        const $regenerateAutomaticTemplateBtn = $(
            "#regenerate-automatic-template-btn"
        );
        const $reviseAutomaticTemplateBtn = $("#revise-automatic-template-btn");

        // --- Shared Design Preview Elements ---
        const $generatedDesignPreview = $("#ai-generated-design-preview");
        const $generatedDesignImg = $("#generated-design-img");
        const $generatedDesignMessage = $("#generated-design-message");

        let selectedTheme = "professional";

        // Initialize selection for the default theme ('professional') on page load
        $('.ai-style-pill[data-style="professional"]').addClass(
            "border-blue-500 border-2"
        );

        // Handle theme selection clicks
        $stylePills.on("click", function () {
            $stylePills.removeClass("border-blue-500 border-1");
            $(this).addClass("border-blue-500 border-1");
            selectedTheme = $(this).data("style");
            console.log("Selected theme:", selectedTheme);
        });

        // Global array to hold current signature data
        let currentSignaturesData = [];

        // Generates dynamic signature input fields
        function generateSignatureInputs(count) {
            // Before emptying, capture current data if it exists
            currentSignaturesData = [];
            $signaturesContainer.find(".mb-4").each(function () {
                currentSignaturesData.push({
                    image: $(this).find(".signature-image-url").val(),
                    name: $(this).find(".signature-name").val(),
                    designation: $(this).find(".signature-designation").val(),
                });
            });

            $signaturesContainer.empty();
            for (let i = 0; i < count; i++) {
                // Use existing data if available, otherwise default to empty
                const sig = currentSignaturesData[i] || {
                    image: "",
                    name: "",
                    designation: "",
                };
                const signatureHtml = `
                    <div class="mb-4 p-3 rounded-md bg-zinc-700">
                        <h4 class="text-md font-semibold text-white mb-2">Signature ${i + 1
                    }</h4>
                        <div class="signature-image-preview-container mb-2 ${sig.image ? "" : "hidden"
                    }">
                            <img class="signature-image-preview w-full h-24 object-contain rounded-md mb-2"
                                src="${sig.image}" alt="Signature Image">
                            <button class="remove-signature-image-btn px-3 py-1 bg-zinc-600 text-white rounded-md text-sm hover:bg-zinc-800 transition-colors duration-200">
                                <i class="fas fa-times-circle mr-1"></i>Remove
                            </button>
                        </div>
                        <div class="signature-upload-area border-2 border-dashed border-gray-600 rounded-lg p-3 text-center text-gray-400 cursor-pointer hover:border-blue-500 hover:text-white transition-colors duration-200 ${sig.image ? "hidden" : ""
                    }">
                            <span class="material-icons text-3xl mb-1"><i class="fas fa-cloud-upload-alt"></i></span>
                            <p class="mb-1 text-sm">Drag & drop or</p>
                            <input type="file" class="signature-file-upload-input hidden" accept="image/*">
                            <button class="browse-signature-files-button px-3 py-1 bg-zinc-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none text-sm">
                                <i class="fas fa-folder-open mr-1"></i>Browse Files
                            </button>
                            <button class="select-existing-signature-btn px-3 py-1 bg-zinc-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none text-sm ml-1">
                                <i class="fas fa-images mr-1"></i>Existing
                            </button>
                        </div>
                        <input type="hidden" class="signature-image-url" value="${sig.image
                    }">
                        <input type="text" class="signature-name w-full p-2 mt-2 rounded-md bg-zinc-700 text-white border border-gray-600 outline-0" placeholder="Signatory Name" value="${sig.name
                    }">
                        <input type="text" class="signature-designation w-full p-2 mt-2 rounded-md bg-zinc-700 text-white border border-gray-600 outline-0" placeholder="Signatory Designation" value="${sig.designation
                    }">
                    </div>
                `;
                $signaturesContainer.append(signatureHtml);
            }
        }

        // Initial generation of signature inputs (call this once on load)

        generateSignatureInputs(parseInt($numSignaturesInput.val()));

        // Listen for changes in the number of signatures input
        $numSignaturesInput.on("change", function () {
            const count = parseInt($(this).val());
            if (!isNaN(count) && count >= 0 && count <= 5) {
                generateSignatureInputs(count);
            } else {
                $(this).val(1); // Reset to 1 if invalid
                generateSignatureInputs(1);
                console.warn("Invalid number of signatures entered. Reset to 1."); // Debug: Warn on invalid input
            }
        });

        // Regenerate and Revise Logic for Automatic Tab
        $regenerateAutomaticTemplateBtn.on("click", function () {

            $generateAutomaticTemplateBtn.click();
        });

        $reviseAutomaticTemplateBtn.on("click", function () {
            alert(
                "Revise Automatic Design functionality would typically involve adjusting prompt/inputs and re-generating."
            );
            console.log("Revise automatic design initiated (placeholder).");
        });

        $(document).ready(function () {
            let currentBrand = null;

            // Initialize color picker for adding new colors
            $("#newColorPicker").spectrum({
                showInput: true,
                preferredFormat: "hex",
                showPalette: true,
                showButtons: false,
                palette: [
                    ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                    ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                    [
                        "#ea9999",
                        "#f9cb9c",
                        "#ffe599",
                        "#b6d7a8",
                        "#a2c4c9",
                        "#9fc5e8",
                        "#b4a7d6",
                        "#d5a6bd",
                    ],
                    [
                        "#e06666",
                        "#f6b26b",
                        "#ffd966",
                        "#93c47d",
                        "#76a5af",
                        "#6fa8dc",
                        "#8e7cc3",
                        "#c27ba0",
                    ],
                    [
                        "#cc0000",
                        "#e69138",
                        "#f1c232",
                        "#6aa84f",
                        "#45818e",
                        "#3d85c6",
                        "#674ea7",
                        "#a64d79",
                    ],
                    [
                        "#990000",
                        "#b45f06",
                        "#bf9000",
                        "#38761d",
                        "#134f5c",
                        "#0b5394",
                        "#351c75",
                        "#741b47",
                    ],
                    [
                        "#660000",
                        "#783f04",
                        "#7f6000",
                        "#274e13",
                        "#0c343d",
                        "#073763",
                        "#20124d",
                        "#4c1130",
                    ],
                ],
            });

            /**
             * Fetches all brands from the API and populates the brand selector dropdown.
             */
            function fetchBrands() {
                $("#brandLoader").removeClass("hidden");
                $.ajax({
                    url: "/api/brands",
                    method: "GET",
                    success: function (response) {
                        const brands = response.brands || [];
                        const $brandSelector = $("#brandSelector");
                        $brandSelector
                            .empty()
                            .append('<option value="">-- Select a Brand --</option>');
                        brands.forEach((brand) => {
                            $brandSelector.append(
                                `<option value="${brand._id}">${brand.name}</option>`
                            );
                        });
                        // If a brand was previously selected, try to re-select it
                        if (
                            currentBrand &&
                            brands.some((b) => b._id === currentBrand._id)
                        ) {
                            $brandSelector.val(currentBrand._id);
                        } else {
                            currentBrand = null;
                        }
                        updateBrandUIState(); // Call to update UI after fetching brands
                    },
                    error: function (xhr, status, error) {
                        showToast(
                            "Error fetching brands: " +
                            (xhr.responseJSON ? xhr.responseJSON.message : error),
                            3000
                        );
                        updateBrandUIState(); // Call to update UI even on error
                    },
                    complete: function () {
                        $("#brandLoader").addClass("hidden");
                    },
                });
            }

            /**
             * Renders the details of the currently selected brand into the UI.
             * @param {object} brand - The brand object to render.
             */
            function renderBrandDetails(brand) {
                currentBrand = brand;
                $("#currentBrandName").text(brand.name);

                // Render Logos
                const $brandLogos = $("#brandLogos").empty();
                if (brand.logos && brand.logos.length > 0) {
                    brand.logos.forEach((logoObj) => {
                        const versionDisplay =
                            logoObj.version && logoObj.version !== "default"
                                ? `(${logoObj.version})`
                                : "";
                        const $logoDiv = $(`
                                    <div class="relative group  rounded-md overflow-hidden">
                                        <img src="${logoObj.url
                            }" alt="Brand Logo" class="w-full h-20 object-contain p-1">
                                        <button class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 delete-logo-btn" data-url="${logoObj.url
                            }" data-version="${logoObj.version || "default"
                            }">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <span class="absolute bottom-1 left-1 text-white text-xs pointer-events-none">${versionDisplay}</span>
                                    </div>
                                `);
                        $brandLogos.append($logoDiv);
                    });
                } else {
                    $brandLogos.append(
                        '<p class="text-gray-400 text-sm col-span-3">No logos added yet.</p>'
                    );
                }

                // Render Colors
                const $brandColors = $("#brandColors").empty();
                if (brand.colors && brand.colors.length > 0) {
                    brand.colors.forEach((colorObj) => {
                        const versionDisplay =
                            colorObj.version && colorObj.version !== "default"
                                ? `(${colorObj.version})`
                                : "";
                        const $colorDiv = $(`
                                    <div class="relative group w-12 h-12 rounded-full border-2 border-zinc-600 flex items-center justify-center cursor-pointer" style="background-color: ${colorObj.hexCode
                            };">
                                        <button class="absolute top-0 right-0 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 delete-color-btn" data-hexcode="${colorObj.hexCode
                            }" data-version="${colorObj.version || "default"
                            }">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <span class="absolute bottom-0 text-white text-xs pointer-events-none">${versionDisplay}</span>
                                    </div>
                                `);
                        $brandColors.append($colorDiv);
                    });
                } else {
                    $brandColors.append(
                        '<p class="text-gray-400 text-sm">No colors added yet.</p>'
                    );
                }

                // Render Fonts
                const $brandFonts = $("#brandFonts").empty();
                // Helper function to extract font name from Google Fonts URL (fallback)
                function getFontNameFromUrl(url) {
                    try {
                        // Check if the input string is a valid URL before attempting to parse
                        if (
                            url &&
                            (url.startsWith("http://") ||
                                url.startsWith("https://") ||
                                url.startsWith("//"))
                        ) {
                            const urlObj = new URL(url);
                            const pathSegments = urlObj.pathname.split("/");
                            const filename = pathSegments[pathSegments.length - 1];
                            return filename.split(".")[0]; // Get font name without extension
                        } else {
                            // If it's not a URL, assume it's already the font name
                            return url;
                        }
                    } catch (e) {
                        console.error("Could not parse font name from URL:", url, e);
                        return url; // Return original string if parsing fails
                    }
                }
                updateBrandUIState();
                // Predefined font categories (must match backend enum)
                const predefinedFontCategories = [
                    "Title",
                    "Subtitle",
                    "Heading",
                    "Subheading",
                    "Section Header",
                    "Body",
                    "Quote",
                    "Caption",
                    "Brand Voice",
                ];

                if (!brand.fonts || brand.fonts.length === 0) {
                    $brandFonts.append(
                        '<p class="text-gray-400 text-sm">No fonts assigned to categories yet.</p>'
                    );
                }

                predefinedFontCategories.forEach((category) => {
                    const assignedFont = brand.fonts.find(
                        (fontObj) => fontObj.category === category
                    );
                    // Modified line: Include weight and size in display
                    const fontDisplayName = assignedFont
                        ? `${assignedFont.name || getFontNameFromUrl(assignedFont.url)} ${assignedFont.weight ? `(${assignedFont.weight})` : ""
                        } ${assignedFont.size ? `(${assignedFont.size}px)` : ""}`
                        : "Not assigned";
                    const fontUrl = assignedFont ? assignedFont.url : "";
                    const fontWeight = assignedFont ? assignedFont.weight : "";
                    const fontSize = assignedFont ? assignedFont.size : "";

                    const $fontCategoryRow = $(`
                        <div class="flex items-center justify-between bg-zinc-800 p-3 rounded-md overflow-x-auto">
                            <div class="flex flex-col">
                            <span class="text-white font-semibold">
                                ${assignedFont
                            ? ` ${assignedFont.name ||
                            getFontNameFromUrl(assignedFont.url)
                            }`
                            : ""
                        }
                            </span>
                            <span class="text-gray-400 text-sm font-family-preview" style="font-family: '${fontDisplayName
                            .split("(")[0]
                            .trim()}', sans-serif; ${fontWeight ? `font-weight: ${fontWeight};` : ""
                        } ${fontSize ? `font-size: ${fontSize}px;` : ""}">${category}</span>
                        </div>
                            <div class="flex items-center gap-2">
                                ${assignedFont
                            ? `
                                    <button class="edit-font-btn text-blue-400 hover:text-blue-300 transition-colors duration-200 p-1 rounded-full"
                                        data-category="${category}" data-name="${assignedFont.name ||
                            getFontNameFromUrl(assignedFont.url)
                            }" data-url="${fontUrl}" data-weight="${fontWeight}" data-size="${fontSize}">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="delete-font-btn text-blue-400 hover:text-red-300 transition-colors duration-200 p-1 rounded-full"
                                        data-category="${category}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                `
                            : `
                                    <button class="assign-font-btn text-green-400 hover:text-green-300 transition-colors duration-200 p-1 rounded-md text-sm"
                                        data-category="${category}">
                                        Assign
                                    </button>
                                `
                        }
                            </div>
                        </div>
                    `);
                    $brandFonts.append($fontCategoryRow);
                });

                // Render Photos
                const $brandPhotos = $("#brandPhotos").empty();
                if (brand.photos && brand.photos.length > 0) {
                    brand.photos.forEach((photoObj) => {
                        const $photoDiv = $(`
                            <div class="relative group border border-zinc-600 rounded-md overflow-hidden">
                                <img src="${photoObj.url}" alt="Brand Photo" class="w-full h-20 object-contain p-1">
                                <button class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 delete-photo-btn" data-url="${photoObj.url}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `);
                        $brandPhotos.append($photoDiv);
                    });
                } else {
                    $brandPhotos.append(
                        '<p class="text-gray-400 text-sm col-span-3">No photos added yet.</p>'
                    );
                }

                // Render Graphics
                const $brandGraphics = $("#brandGraphics").empty();
                if (brand.graphics && brand.graphics.length > 0) {
                    brand.graphics.forEach((graphicObj) => {
                        const $graphicDiv = $(`
                            <div class="relative group border border-zinc-600 rounded-md overflow-hidden">
                                <img src="${graphicObj.url}" alt="Brand Graphic" class="w-full h-20 object-contain p-1">
                                <button class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 delete-graphic-btn" data-url="${graphicObj.url}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `);
                        $brandGraphics.append($graphicDiv);
                    });
                } else {
                    $brandGraphics.append(
                        '<p class="text-gray-400 text-sm col-span-3">No graphics added yet.</p>'
                    );
                }

                // Render Icons
                const $brandIcons = $("#brandIcons").empty();
                if (brand.icons && brand.icons.length > 0) {
                    brand.icons.forEach((iconObj) => {
                        const $iconDiv = $(`
                            <div class="relative group border border-zinc-600 rounded-md overflow-hidden">
                                <img src="${iconObj.url}" alt="Brand Icon" class="w-full h-20 object-contain p-1">
                                <button class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 delete-icon-btn" data-url="${iconObj.url}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `);
                        $brandIcons.append($iconDiv);
                    });
                } else {
                    $brandIcons.append(
                        '<p class="text-gray-400 text-sm col-span-3">No icons added yet.</p>'
                    );
                }

                $("#currentBrandDetails").removeClass("hidden");
            }

            /**
             * Creates a new brand.
             */
            $("#createNewBrandBtn").on("click", function () {
                const newBrandName = $("#newBrandNameInput").val().trim();
                if (!newBrandName) {
                    showToast("Please enter a name for the new brand.", 2000);
                    return;
                }

                const payload = {
                    name: newBrandName,
                    fonts: [],
                    logos: [],
                    colors: [],
                    country: "Unknown",
                    state: "Unknown",
                    language: "English",
                };

                showGlobalLoader();
                $.ajax({
                    url: "/api/brands",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function (response) {
                        showToast(`Brand "${response.name}" created successfully!`);
                        $("#newBrandNameInput").val("");
                        populateAITabsBrandSelectors();
                        fetchBrands(); // Refetch brands to include the new one in the dropdown
                        currentBrand = response; // Set the newly created brand as current
                        renderBrandDetails(currentBrand); // Render its details
                        $("#brandSelector").val(currentBrand._id); // Select it in the dropdown
                        updateBrandUIState(); // Update UI state
                    },
                    error: function (xhr, status, error) {
                        showToast(
                            "Error creating brand: " +
                            (xhr.responseJSON ? xhr.responseJSON.message : error),
                            3000
                        );
                    },
                    complete: function () {
                        hideGlobalLoader();
                    },
                });
            });

            /**
             * Handles brand selection from the dropdown.
             */
            $("#brandSelector").on("change", function () {
                const brandId = $(this).val();
                if (brandId) {
                    showGlobalLoader();
                    $.ajax({
                        url: `/api/brands/${brandId}`,
                        method: "GET",
                        success: function (response) {
                            renderBrandDetails(response);
                        },
                        error: function (xhr, status, error) {
                            showToast(
                                "Error fetching brand details: " +
                                (xhr.responseJSON ? xhr.responseJSON.message : error),
                                3000
                            );
                            currentBrand = null;
                            updateBrandUIState();
                            $("#brandSelector").val("");
                        },
                        complete: function () {
                            hideGlobalLoader();
                        },
                    });
                } else {
                    currentBrand = null;
                    updateBrandUIState(); // Update UI when no brand is selected
                }
            });

            /**
             * Adds a color to the current brand.
             */
            $("#addColorBtn").on("click", function () {
                if (!currentBrand) {
                    showToast("Please select or create a brand first.", 2000);
                    return;
                }
                const colorHex = $("#newColorPicker").spectrum("get").toHexString();
                const colorVersion = $("#newColorVersion").val(); // Get the selected version

                const colorExists = currentBrand.colors.some(
                    (colorObj) =>
                        colorObj.hexCode === colorHex && colorObj.version === colorVersion
                );

                if (!colorExists) {
                    currentBrand.colors.push({
                        hexCode: colorHex,
                        version: colorVersion,
                    }); // Include version
                    renderBrandDetails(currentBrand);
                    showToast("Color added! Remember to save changes.");
                } else {
                    showToast("This color (with this version) is already added.", 2000);
                }
            });

            // Define available fonts for selection in Brand Kit
            const availableFonts = [
                "Arial",
                "Verdana",
                "Helvetica",
                "Tahoma",
                "Trebuchet MS",
                "Georgia",
                "Times New Roman",
                "Palatino Linotype",
                "Garamond",
                "Book Antiqua",
                "Courier New",
                "Lucida Console",
                "Impact",
                "Haettenschweiler",
                "Franklin Gothic Medium",
                "Arial Narrow",
                "Brush Script MT",
                "Lucida Handwriting",
                "Segoe Script",
                "Comic Sans MS",
                "Oswald",
                "Lato",
                "Montserrat",
                "Roboto",
                "Open Sans",
                "Poppins",
                "Raleway",
                "Source Sans Pro",
                "Ubuntu",
                "Playfair Display",
                "Merriweather",
                "Lora",
                "Noto Sans",
                "PT Sans",
                "Quicksand",
                "Rubik",
                "Inter",
                "Exo 2",
                "Fira Sans",
                "Cabin",
                "Abel",
                "Anton",
                "Bebas Neue",
                "Pacifico",
                "Great Vibes",
            ];

            // New loadGoogleFont function
            function loadGoogleFont(fontFamily) {
                const linkId = `google-font-${fontFamily.replace(/\s/g, "-")}`;
                if (!document.getElementById(linkId)) {
                    const link = document.createElement("link");
                    link.id = linkId;
                    link.rel = "stylesheet";
                    link.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(
                        fontFamily
                    )}:wght@400;700&display=swap`;
                    document.head.appendChild(link);
                }
            }

            // Populates the font selection dropdowns with available fonts
            function populateFontSelector() {
                // The standard select element for the main toolbar
                const fontFamilySelect = $("#fontFamily");
                fontFamilySelect.empty(); // Clear existing options


                const brandFontList = $("#fontModalFontList");
                brandFontList.empty(); // Clear existing list items

                // Define available fonts for selection
                const availableFonts = [
                    "Arial",
                    "Verdana",
                    "Helvetica",
                    "Tahoma",
                    "Trebuchet MS",
                    "Georgia",
                    "Times New Roman",
                    "Palatino Linotype",
                    "Garamond",
                    "Book Antiqua",
                    "Courier New",
                    "Lucida Console",
                    "Impact",
                    "Haettenschweiler",
                    "Franklin Gothic Medium",
                    "Arial Narrow",
                    "Brush Script MT",
                    "Lucida Handwriting",
                    "Segoe Script",
                    "Comic Sans MS",
                    "Oswald",
                    "Lato",
                    "Montserrat",
                    "Roboto",
                    "Open Sans",
                    "Poppins",
                    "Raleway",
                    "Source Sans Pro",
                    "Ubuntu",
                    "Playfair Display",
                    "Merriweather",
                    "Lora",
                    "Noto Sans",
                    "PT Sans",
                    "Quicksand",
                    "Rubik",
                    "Inter",
                    "Exo 2",
                    "Fira Sans",
                    "Cabin",
                    "Abel",
                    "Anton",
                    "Bebas Neue",
                    "Pacifico",
                    "Great Vibes",
                ];

                // Add "Default (System)" option to both
                fontFamilySelect.append(
                    $("<option>", {
                        class: "options-font p-2 my-1 ",
                        value: "Default (System)",
                        text: "Default (System)",
                    })
                );
                const defaultBrandLi = $("<li>", {
                    class: "p-2 hover:bg-zinc-600 cursor-pointer text-white",
                    "data-value": "Default (System)",
                    text: "Default (System)",
                });
                brandFontList.append(defaultBrandLi);

                availableFonts.forEach((font) => {
                    // Add to main toolbar select
                    fontFamilySelect.append(
                        $("<option>", {
                            class: "options-font p-2 my-1 ",
                            value: font,
                            text: font,
                        }).css("font-family", `'${font}', sans-serif`)
                    ); // <--- THIS IS THE KEY CHANGE FOR FONT PREVIEW

                    const brandListItem = $("<li>", {
                        class: "p-2 hover:bg-zinc-600 cursor-pointer text-white",
                        "data-value": font,
                        text: font,
                    }).css("font-family", `'${font}', sans-serif`); // Apply font style for preview

                    brandFontList.append(brandListItem);

                    // Crucial: Load the Google Font to ensure it's available for preview
                    loadGoogleFont(font);
                });

                // If you have `currentBrandFonts` (from your brand data), add them to both
                if (
                    typeof currentBrandFonts !== "undefined" &&
                    currentBrandFonts.length > 0
                ) {
                    currentBrandFonts.forEach((font) => {
                        if (!availableFonts.includes(font)) {
                            // Avoid duplicates if already in availableFonts
                            // Add to main toolbar select
                            fontFamilySelect.append(
                                $("<option>", {
                                    value: font,
                                    text: `${font} (Custom)`,
                                }).css("font-family", `'${font}', sans-serif`)
                            ); // <--- THIS IS THE KEY CHANGE FOR FONT PREVIEW

                            // Add to Brand Kit custom dropdown list
                            const brandListItem = $("<li>", {
                                class: "p-2 hover:bg-zinc-600 cursor-pointer text-white",
                                "data-value": font,
                                text: `${font} (Custom)`,
                            }).css("font-family", `'${font}', sans-serif`); // Apply font style for preview

                            brandFontList.append(brandListItem);

                            loadGoogleFont(font); // Load custom fonts too
                        }
                    });
                }
            }

            // Shows the font assignment modal.

            function showFontAssignmentModal(
                category = "",
                fontUrl = "",
                fontName = "",
                fontWeight = "",
                fontSize = 24
            ) {
                // Added fontSize parameter with default
                populateFontSelector(); // This function populates the font list

                $("#fontModalOriginalCategory").val(category);
                $("#fontModalSelectFont").val(fontUrl);
                $("#fontModalAssignCategorySelect").val(category);
                $("#fontModalFontWeightSelect").val(fontWeight);
                $("#fontModalFontSizeInput").val(fontSize);

                // Update the displayed font text in the custom dropdown
                if (fontName) {
                    // Ensure the fontName is just the name, not including weight/size info
                    const cleanFontName = fontName.split("(")[0].trim();
                    $("#selectedFontModalText").text(cleanFontName);
                    $("#selectedFontModalText").css(
                        "font-family",
                        `'${cleanFontName}', sans-serif`
                    );
                } else {
                    $("#selectedFontModalText").text("-- Select a Font --");
                    $("#selectedFontModalText").css("font-family", "inherit");
                }

                if (category && fontUrl) {
                    $("#fontModalLabel").text("Edit Font Assignment");
                    $("#saveFontAssignmentBtn").text("Update Assignment");
                } else {
                    $("#fontModalLabel").text("Assign Font");
                    $("#saveFontAssignmentBtn").text("Save Assignment");
                }

                $("#fontAssignmentModal").removeClass("hidden").addClass("flex");
            }

            // Toggle visibility of the custom font list in the toolbar
            $("#fontFamilyDisplay").on("click", function () {
                $("#fontFamilyList").toggleClass("hidden");
            });

            // Handle selection from the custom font list in the toolbar
            $("#fontFamilyList").on("click", "li", function () {
                const selectedValue = $(this).data("value");
                const selectedText = $(this).text();
                const selectedFontFamily = $(this).css("font-family"); // Get the applied font-family

                // Update hidden input for toolbar
                $("#fontFamilyHidden").val(selectedValue);
                // Update displayed text in toolbar
                $("#selectedToolbarFontText").text(selectedText);
                // Apply font style to displayed text in toolbar
                $("#selectedToolbarFontText").css("font-family", selectedFontFamily);

                // Also update the active object on canvas if it's text
                const activeObject = canvas.getActiveObject();
                if (
                    activeObject &&
                    (activeObject.type === "i-text" ||
                        activeObject.type === "text" ||
                        activeObject.type === "textbox")
                ) {
                    activeObject.set("fontFamily", selectedValue);
                    canvas.renderAll();
                    saveCanvasState();
                }

                $("#fontFamilyList").addClass("hidden"); // Hide the list
            });

            // Close the custom font list (toolbar) if clicked outside
            $(document).on("click", function (event) {
                if (
                    !$(event.target).closest("#fontFamilyDisplay").length &&
                    !$(event.target).closest("#fontFamilyList").length &&
                    !$(event.target).closest("#fontModalSelectFontDisplay").length && // Keep brand modal open if clicked there
                    !$(event.target).closest("#fontModalFontList").length
                ) {
                    // Keep brand modal open if clicked there
                    $("#fontFamilyList").addClass("hidden");
                }
            });


            // Toggle visibility of the custom font list
            $("#fontModalSelectFontDisplay").on("click", function () {
                $("#fontModalFontList").toggleClass("hidden");
            });

            // Handle selection from the custom font list
            $("#fontModalFontList").on("click", "li", function () {
                const selectedValue = $(this).data("value");
                const selectedText = $(this).text();
                const selectedFontFamily = $(this).css("font-family"); // Get the applied font-family

                $("#fontModalSelectFont").val(selectedValue); // Update hidden input
                $("#selectedFontModalText").text(selectedText); // Update displayed text
                $("#selectedFontModalText").css("font-family", selectedFontFamily); // Apply font style to displayed text
                $("#fontModalFontList").addClass("hidden"); // Hide the list
            });

            // Close the custom font list if clicked outside
            $(document).on("click", function (event) {
                if (
                    !$(event.target).closest("#fontModalSelectFontDisplay").length &&
                    !$(event.target).closest("#fontModalFontList").length
                ) {
                    $("#fontModalFontList").addClass("hidden");
                }
            });

            /**
             * Hides the font assignment modal.
             */
            function hideFontAssignmentModal() {
                $("#fontAssignmentModal").removeClass("flex").addClass("hidden");
                // Clear modal inputs
                $("#fontModalOriginalCategory").val("");
                $("#fontModalSelectFont").val("");
                $("#fontModalAssignCategorySelect").val("");
            }

            // Event listener to open the font assignment modal
            $("#openFontAssignmentModalBtn").on("click", function () {
                showFontAssignmentModal();
            });

            // Event listener to close the font assignment modal
            $("#closeFontAssignmentModal, #cancelFontAssignmentBtn").on(
                "click",
                function () {
                    hideFontAssignmentModal();
                }
            );

            // Handles saving font assignment from the modal.

            $("#saveFontAssignmentBtn").on("click", function () {
                if (!currentBrand) {
                    showToast("Please select or create a brand first.", 2000);
                    return;
                }

                const selectedFontUrl = $("#fontModalSelectFont").val();
                const selectedFontName = $("#selectedFontModalText").text(); // Get the displayed text for name
                const fontCategory = $("#fontModalAssignCategorySelect").val();
                const fontWeight = $("#fontModalFontWeightSelect").val(); // Get the selected font weight
                const fontSize = $("#fontModalFontSizeInput").val(); // Get the selected font size

                if (!selectedFontUrl) {
                    showToast("Please select a font from the dropdown.", 2000);
                    return;
                }
                if (!fontCategory) {
                    showToast("Please select a font category.", 2000);
                    return;
                }
                if (!fontWeight) {
                    showToast("Please select a font weight.", 2000);
                    return;
                }
                if (
                    !fontSize ||
                    isNaN(fontSize) ||
                    parseInt(fontSize) < 8 ||
                    parseInt(fontSize) > 100
                ) {
                    // New validation for font size
                    showToast(
                        "Please enter a valid font size between 8 and 100.",
                        2000
                    );
                    return;
                }

                // Find if a font already exists for this category
                const existingFontIndex = currentBrand.fonts.findIndex(
                    (fontObj) => fontObj.category === fontCategory
                );

                if (existingFontIndex !== -1) {
                    // Update existing font
                    currentBrand.fonts[existingFontIndex] = {
                        category: fontCategory,
                        url: selectedFontUrl,
                        name: selectedFontName,
                        weight: fontWeight,
                        size: parseInt(fontSize),
                    };
                    showToast(
                        `Font for "${fontCategory}" updated! Remember to save changes.`
                    );
                } else {
                    // Add new font for this category
                    currentBrand.fonts.push({
                        category: fontCategory,
                        url: selectedFontUrl,
                        name: selectedFontName,
                        weight: fontWeight,
                        size: parseInt(fontSize),
                    });
                    showToast(
                        `Font assigned to "${fontCategory}"! Remember to save changes.`
                    );
                }

                renderBrandDetails(currentBrand);
                hideFontAssignmentModal();
            });
            // Handles clicking the "Edit" button for a font category.

            $("#brandFonts").on("click", ".edit-font-btn", function () {
                const category = $(this).data("category");
                const name = $(this).data("name");
                const url = $(this).data("url");
                const weight = $(this).data("weight");
                const size = $(this).data("size");
                showFontAssignmentModal(category, url, name, weight, size);
            });

            //   Handles clicking the "Assign" button for a font category that has no font yet.

            $("#brandFonts").on("click", ".assign-font-btn", function () {
                const category = $(this).data("category");
                showFontAssignmentModal(category);
            });

            $("#brandFonts").on("click", ".delete-font-btn", function () {
                if (!currentBrand) return;
                const fontCategoryToDelete = $(this).data("category");
                showCustomModal(
                    "Confirm Delete Font",
                    `Are you sure you want to remove the font assigned to "${fontCategoryToDelete}"?`,
                    `<button id="confirmDeleteBrandItemBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                    <button id="cancelDeleteBrandItemBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                );
                $("#confirmDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        currentBrand.fonts = currentBrand.fonts.filter(
                            (fontObj) => fontObj.category !== fontCategoryToDelete
                        );
                        renderBrandDetails(currentBrand);
                        showToast(
                            `Font for "${fontCategoryToDelete}" deleted! Remember to save changes.`
                        );
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
                $("#cancelDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            });

            // Extracts dominant colors from an image URL using ColorThief.
            function extractColorsFromImage(imageUrl) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.src = imageUrl;

                    img.onload = function () {
                        try {
                            // IMPORTANT: Check if ColorThief is defined before using it
                            if (typeof ColorThief !== "undefined") {
                                const colorThief = new ColorThief();
                                const palette = colorThief.getPalette(img, 2);
                                console.log("Extracted Palette:", palette);
                                const primaryColor = `rgb(${palette[0].join(",")})`;
                                const secondaryColor = palette[1]
                                    ? `rgb(${palette[1].join(",")})`
                                    : primaryColor;
                                resolve([primaryColor, secondaryColor]);
                            } else {
                                console.error(
                                    "ColorThief is not defined. Make sure the script is loaded correctly."
                                );
                                reject(new Error("ColorThief library not available."));
                            }
                        } catch (error) {
                            console.error(
                                "Error extracting colors with ColorThief:",
                                error
                            );
                            reject(error);
                        }
                    };

                    img.onerror = function (error) {
                        console.error("Error loading image for color extraction:", error);
                        reject(error);
                    };
                });
            }

            //  Handles file upload for brand assets (logos, photos, graphics, icons).

            function handleBrandAssetUpload(file, assetType, version = "default") {
                // Added version parameter
                if (!currentBrand) {
                    showToast("Please select or create a brand first.", 2000);
                    return;
                }

                const formData = new FormData();
                formData.append("file", file);
                formData.append("tags", `brand,${assetType}`);

                showGlobalLoader();

                $.ajax({
                    url: "/api/files/upload/brands",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: async function (response) {
                        if (response.file && response.file.url) {
                            const newAsset = { url: response.file.url, version: version };

                            // Check if asset (by URL and version) already exists in the specific array
                            const assetExists = currentBrand[assetType].some(
                                (assetObj) =>
                                    assetObj.url === newAsset.url &&
                                    (assetObj.version || "default") === newAsset.version
                            );

                            if (!assetExists) {
                                currentBrand[assetType].push(newAsset);

                                if (assetType === "logos") {
                                    try {
                                        const extractedColors = await extractColorsFromImage(
                                            newAsset.url
                                        );
                                        const primaryHex = extractedColors[0];
                                        const secondaryHex = extractedColors[1] || primaryHex; // Use primary if no secondary

                                        // Function to update or add a color version
                                        const updateOrAddColor = (hexCode, version) => {
                                            const existingIndex = currentBrand.colors.findIndex(
                                                (c) => c.version === version
                                            );
                                            if (existingIndex !== -1) {
                                                // Update existing color
                                                currentBrand.colors[existingIndex].hexCode = hexCode;
                                            } else {
                                                // Add new color
                                                currentBrand.colors.push({
                                                    hexCode: hexCode,
                                                    version: version,
                                                });
                                            }
                                        };

                                        updateOrAddColor(primaryHex, "default");
                                        updateOrAddColor(secondaryHex, "light"); // Assuming 'light' for secondary from logo

                                        showToast(
                                            "Logo uploaded and colors extracted/updated! Remember to save changes."
                                        );
                                    } catch (colorError) {
                                        console.error(
                                            "Failed to extract colors from logo:",
                                            colorError
                                        );
                                        showToast(
                                            "Logo uploaded, but failed to extract colors automatically. Add them manually.",
                                            4000
                                        );
                                    }
                                } else {
                                    const assetExists = currentBrand[assetType].some(
                                        (assetObj) =>
                                            assetObj.url === newAsset.url &&
                                            (assetObj.version || "default") === newAsset.version
                                    );

                                    if (!assetExists) {
                                        currentBrand[assetType].push(newAsset);
                                        showToast(
                                            `${assetType.slice(0, -1).charAt(0).toUpperCase() +
                                            assetType.slice(0, -1).slice(1)
                                            } added! Remember to save changes.`
                                        );
                                    } else {
                                        showToast(
                                            `This ${assetType.slice(
                                                0,
                                                -1
                                            )} (with this version) is already added.`,
                                            2000
                                        );
                                    }
                                }

                                renderBrandDetails(currentBrand); // Re-render to show updated logos and colors
                            } else {
                                showToast(
                                    `This ${assetType.slice(
                                        0,
                                        -1
                                    )} (with this version) is already added.`,
                                    2000
                                );
                            }
                        } else {
                            showToast("File upload failed. No URL returned.", 3000);
                        }
                    },
                    error: function (xhr, status, error) {
                        showToast(
                            `File upload failed for ${assetType.slice(0, -1)}: ${error}`,
                            3000
                        );
                    },
                    complete: function () {
                        hideGlobalLoader();
                    },
                });
            }

            //  Helper function to set up drag-and-drop and click-to-upload for brand asset upload areas.

            function setupBrandAssetUpload(areaId, inputId, assetType) {
                const $dropArea = $(`#${areaId}`);
                const $fileInput = $(`#${inputId}`);

                // Handle file selection from input (triggered by label click)
                $fileInput.on("change", function (e) {
                    const files = e.target.files;
                    if (files.length > 0) {
                        handleBrandAssetUpload(files[0], assetType);
                    }
                    // Clear the input value to allow re-uploading the same file
                    $(this).val("");
                });

                // Drag and drop events
                ["dragenter", "dragover", "dragleave", "drop"].forEach(
                    (eventName) => {
                        $dropArea.on(eventName, function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    }
                );

                ["dragenter", "dragover"].forEach((eventName) => {
                    $dropArea.on(eventName, function () {
                        $(this).addClass("highlight");
                    });
                });

                ["dragleave", "drop"].forEach((eventName) => {
                    $dropArea.on(eventName, function () {
                        $(this).removeClass("highlight");
                    });
                });

                $dropArea.on("drop", function (e) {
                    const dt = e.originalEvent.dataTransfer;
                    const files = dt.files;
                    if (files.length > 0) {
                        handleBrandAssetUpload(files[0], assetType);
                    }
                });
            }

            //  function  for selecting existing files
            function openExistingFilesSelectionModal(assetType, versionSelectorId) {
                showCustomModal(
                    `Select Existing ${assetType.charAt(0).toUpperCase() + assetType.slice(1, -1)
                    }`,
                    `<div style="scrollbar-width: thin; scrollbar-color: #9ca3af #374151;" id="existingFilesList" class="grid grid-cols-3 gap-2 overflow-y-auto max-h-96">
                                <div id="existingFilesLoading" class="text-center col-span-3 py-4">
                                    <div class="spinner-border text-blue-500" role="status"></div>
                                </div>
                            </div>`,
                    `<button id="closeExistingFilesModal" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Close</button>`
                );

                const $existingFilesList = $("#existingFilesList");
                $("#existingFilesLoading").removeClass("hidden");

                $.ajax({
                    url: `/api/files/images?tags=${assetType}`, // Fetch images with specific tags
                    method: "GET",
                    success: function (data) {
                        $existingFilesList.empty();
                        if (data.length === 0) {
                            $existingFilesList.html(
                                '<p class="text-gray-500 text-center col-span-3">No existing files found.</p>'
                            );
                        } else {
                            data.forEach((file) => {
                                const $fileItem = $(`
                                            <div class="relative group  rounded-md overflow-hidden cursor-pointer existing-file-item" data-url="${file.url}">
                                                <img src="${file.url}" alt="File" class="w-full h-20 object-contain p-1">
                                                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                    <i class="fas fa-check-circle text-white text-3xl"></i>
                                                </div>
                                            </div>
                                        `);
                                $existingFilesList.append($fileItem);
                            });
                        }
                    },
                    error: function (xhr, status, error) {
                        $existingFilesList.html(
                            `<p class="text-red-400 text-center col-span-3">Error loading files: ${error}</p>`
                        );
                    },
                    complete: function () {
                        $("#existingFilesLoading").addClass("hidden");
                    },
                });

                // Handle selection of an existing file
                $existingFilesList
                    .off("click")
                    .on("click", ".existing-file-item", function () {
                        const selectedUrl = $(this).data("url");
                        const version = $(`#${versionSelectorId}`).val();

                        addExistingAssetToBrand(selectedUrl, assetType, version);
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });

                $("#closeExistingFilesModal")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            }

            // Function to manage visibility of brand creation/update elements
            function updateBrandUIState() {
                if (currentBrand) {
                    $("#newBrandNameInput").addClass("hidden");
                    $("#createNewBrandBtn").addClass("hidden");
                    $("#currentBrandDetails").removeClass("hidden");
                    $("#saveBrandChangesBtn").removeClass("hidden");
                    $("#deleteCurrentBrandBtn").removeClass("hidden"); // Also show delete button
                } else {
                    // No brand selected: show creation, hide details and save button
                    $("#newBrandNameInput").removeClass("hidden");
                    $("#createNewBrandBtn").removeClass("hidden");
                    $("#currentBrandDetails").addClass("hidden");
                    $("#saveBrandChangesBtn").addClass("hidden");
                    $("#deleteCurrentBrandBtn").addClass("hidden"); // Hide delete button
                    $("#newBrandNameInput").val(""); // Clear new brand name input
                }
            }

            // function to add existing asset (by URL) to brand

            async function addExistingAssetToBrand(
                url,
                assetType,
                version = "default"
            ) {
                if (!currentBrand) {
                    showToast("Please select or create a brand first.", 2000);
                    return;
                }

                const newAsset = { url: url, version: version };
                const assetExists = currentBrand[assetType].some(
                    (assetObj) =>
                        assetObj.url === newAsset.url &&
                        (assetObj.version || "default") === newAsset.version
                );

                if (!assetExists) {
                    currentBrand[assetType].push(newAsset);

                    if (assetType === "logos") {
                        try {
                            const extractedColors = await extractColorsFromImage(
                                newAsset.url
                            );
                            const primaryHex = extractedColors[0];
                            const secondaryHex = extractedColors[1] || primaryHex;

                            // Function to update or add a color version
                            const updateOrAddColor = (hexCode, version) => {
                                const existingIndex = currentBrand.colors.findIndex(
                                    (c) => c.version === version
                                );
                                if (existingIndex !== -1) {
                                    // Update existing color
                                    currentBrand.colors[existingIndex].hexCode = hexCode;
                                } else {
                                    // Add new color
                                    currentBrand.colors.push({
                                        hexCode: hexCode,
                                        version: version,
                                    });
                                }
                            };

                            updateOrAddColor(primaryHex, "default");
                            updateOrAddColor(secondaryHex, "light"); // Assuming 'light' for secondary from logo

                            showToast(
                                "Existing logo added and colors extracted/updated! Remember to save changes."
                            );
                        } catch (colorError) {
                            console.error(
                                "Failed to extract colors from existing logo:",
                                colorError
                            );
                            showToast(
                                "Existing logo added, but failed to extract colors automatically. Add them manually.",
                                4000
                            );
                        }
                    } else {
                        // Original toast for other asset types
                        showToast(
                            `${assetType.slice(0, -1).charAt(0).toUpperCase() +
                            assetType.slice(0, -1).slice(1)
                            } added! Remember to save changes.`
                        );
                    }
                    // --- END NEW LOGIC ---

                    renderBrandDetails(currentBrand); // Re-render to show updated assets and colors
                } else {
                    showToast(
                        `This ${assetType.slice(
                            0,
                            -1
                        )} (with this version) is already added.`,
                        2000
                    );
                }
            }

            $("#newLogoInput").on("change", function (e) {
                const files = e.target.files;
                if (files.length > 0) {
                    const logoVersion = $("#newLogoVersion").val(); // Get logo version
                    handleBrandAssetUpload(files[0], "logos", logoVersion); // Pass version
                }
                $(this).val(""); // Clear the input value to allow re-uploading the same file
            });

            // Event listeners for deleting various brand assets
            $("#brandPhotos").on("click", ".delete-photo-btn", function () {
                if (!currentBrand) return;
                const photoUrlToDelete = $(this).data("url");
                showCustomModal(
                    "Confirm Delete",
                    "Are you sure you want to delete this photo?",
                    `<button id="confirmDeleteBrandItemBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                    <button id="cancelDeleteBrandItemBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                );
                $("#confirmDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        currentBrand.photos = currentBrand.photos.filter(
                            (photoObj) => photoObj.url !== photoUrlToDelete
                        );
                        renderBrandDetails(currentBrand);
                        showToast("Photo deleted! Remember to save changes.");
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
                $("#cancelDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            });

            $("#brandGraphics").on("click", ".delete-graphic-btn", function () {
                if (!currentBrand) return;
                const graphicUrlToDelete = $(this).data("url");
                showCustomModal(
                    "Confirm Delete",
                    "Are you sure you want to delete this graphic?",
                    `<button id="confirmDeleteBrandItemBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                    <button id="cancelDeleteBrandItemBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                );
                $("#confirmDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        currentBrand.graphics = currentBrand.graphics.filter(
                            (graphicObj) => graphicObj.url !== graphicUrlToDelete
                        );
                        renderBrandDetails(currentBrand);
                        showToast("Graphic deleted! Remember to save changes.");
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
                $("#cancelDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            });

            $("#brandIcons").on("click", ".delete-icon-btn", function () {
                if (!currentBrand) return;
                const iconUrlToDelete = $(this).data("url");
                showCustomModal(
                    "Confirm Delete",
                    "Are you sure you want to delete this icon?",
                    `<button id="confirmDeleteBrandItemBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                    <button id="cancelDeleteBrandItemBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                );
                $("#confirmDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        currentBrand.icons = currentBrand.icons.filter(
                            (iconObj) => iconObj.url !== iconUrlToDelete
                        );
                        renderBrandDetails(currentBrand);
                        showToast("Icon deleted! Remember to save changes.");
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
                $("#cancelDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            });

            $("#brandLogos").on("click", ".delete-logo-btn", function () {
                if (!currentBrand) return;
                const logoUrlToDelete = $(this).data("url");
                const logoVersionToDelete = $(this).data("version"); // Get the version

                showCustomModal(
                    "Confirm Delete",
                    "Are you sure you want to delete this logo?",
                    `<button id="confirmDeleteBrandItemBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                            <button id="cancelDeleteBrandItemBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                );
                $("#confirmDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        currentBrand.logos = currentBrand.logos.filter(
                            (logoObj) =>
                                !(
                                    logoObj.url === logoUrlToDelete &&
                                    (logoObj.version || "default") === logoVersionToDelete
                                )
                        );
                        renderBrandDetails(currentBrand);
                        showToast("Logo deleted! Remember to save changes.");
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
                $("#cancelDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            });

            // Event listener for "Select from Existing Files" button
            $("#selectExistingLogoBtn").on("click", function () {
                openExistingFilesSelectionModal("logos", "newLogoVersion");
            });

            // Toggle visibility for Logo add options (the new div)
            $("#addLogoButton").on("click", function () {
                $("#logo-add-options").toggleClass("hidden");
            });

            $("#brandColors").on("click", ".delete-color-btn", function () {
                if (!currentBrand) return;
                const colorHexToDelete = $(this).data("hexcode");
                const colorVersionToDelete = $(this).data("version"); // Get the version

                showCustomModal(
                    "Confirm Delete",
                    "Are you sure you want to delete this color?",
                    `<button id="confirmDeleteBrandItemBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete</button>
                            <button id="cancelDeleteBrandItemBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                );
                $("#confirmDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        currentBrand.colors = currentBrand.colors.filter(
                            (colorObj) =>
                                !(
                                    colorObj.hexCode === colorHexToDelete &&
                                    (colorObj.version || "default") === colorVersionToDelete
                                )
                        );
                        renderBrandDetails(currentBrand);
                        showToast("Color deleted! Remember to save changes.");
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
                $("#cancelDeleteBrandItemBtn")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            });

            /**
             * Saves changes to the current brand by sending a PUT request to the API.
             */
            $("#saveBrandChangesBtn").on("click", function () {
                if (!currentBrand || !currentBrand._id) {
                    showToast("No brand selected to save changes.", 2000);
                    return;
                }

                showGlobalLoader();
                $.ajax({
                    url: `/api/brands/${currentBrand._id}`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(currentBrand),
                    success: function (response) {
                        showToast("Brand changes saved successfully!");
                        populateAITabsBrandSelectors();
                        fetchBrands();
                        renderBrandDetails(response);
                    },
                    error: function (xhr, status, error) {
                        showToast(
                            "Error saving brand changes: " +
                            (xhr.responseJSON ? xhr.responseJSON.message : error),
                            3000
                        );
                    },
                    complete: function () {
                        hideGlobalLoader();
                    },
                });
            });

            /**
             * Deletes the currently selected brand.
             */
            $("#deleteCurrentBrandBtn").on("click", function () {
                if (!currentBrand || !currentBrand._id) {
                    showToast("No brand selected to delete.", 2000);
                    return;
                }

                showCustomModal(
                    "Confirm Delete Brand",
                    `Are you sure you want to delete the brand "${currentBrand.name}"? This action cannot be undone.`,
                    `<button id="confirmDeleteBrandBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Delete Permanently</button>
                    <button id="cancelDeleteBrandBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>`
                );

                $("#confirmDeleteBrandBtn")
                    .off("click")
                    .on("click", function () {
                        showGlobalLoader();
                        $.ajax({
                            url: `/api/brands/${currentBrand._id}`,
                            method: "DELETE",
                            success: function (response) {
                                showToast(
                                    `Brand "${currentBrand.name}" deleted successfully!`
                                );
                                currentBrand = null;
                                $("#currentBrandDetails").addClass("hidden");
                                fetchBrands();
                                $("#customModal").removeClass("flex").addClass("hidden");
                            },
                            error: function (xhr, status, error) {
                                showToast(
                                    "Error deleting brand: " +
                                    (xhr.responseJSON ? xhr.responseJSON.message : error),
                                    3000
                                );
                                $("#customModal").removeClass("flex").addClass("hidden");
                            },
                            complete: function () {
                                hideGlobalLoader();
                            },
                        });
                    });
                $("#cancelDeleteBrandBtn")
                    .off("click")
                    .on("click", function () {
                        $("#customModal").removeClass("flex").addClass("hidden");
                    });
            });

            // --- New Toggle Logic for Plus Buttons ---
            // Toggle visibility for Logo upload area
            $("#addLogoButton").on("click", function () {
                $("#bg-upload-area").toggleClass("hidden");
            });

            // Toggle visibility for Color input area
            $("#addColorSectionButton").on("click", function () {
                $("#color-input-area").toggleClass("hidden");
            });

            // Toggle visibility for Font assignment area (entire content area)
            $("#addFontSectionButton").on("click", function () {
                $("#font-content-area").toggleClass("hidden");
            });

            // Toggle visibility for Photo upload area
            $("#addPhotoButton").on("click", function () {
                $("#photo-upload-area").toggleClass("hidden");
            });

            // Toggle visibility for Graphic upload area
            $("#addGraphicButton").on("click", function () {
                $("#graphic-upload-area").toggleClass("hidden");
            });

            // Toggle visibility for Icon upload area
            $("#addIconButton").on("click", function () {
                $("#icon-upload-area").toggleClass("hidden");
            });

            // Initial fetch of brands and populate font selector on document ready
            fetchBrands();
            populateFontSelector();
        });

        $(document).ready(function () {
            const $designSearchQuery = $("#designSearchQuery");
            const $designSearchButton = $("#designSearchButton");
            const $designsSearchResults = $("#designsSearchResults");
            const $designLoading = $("#designLoading");

            // The toggleLoading function no longer clears the container
            function toggleLoading(show) {
                if (show) {
                    $designLoading.removeClass("hidden");
                } else {
                    $designLoading.addClass("hidden");
                }
            }

            function renderDesigns(designs, clearContainer = true) {
                const $designsSearchResults = $("#designsSearchResults");

                if (clearContainer) {
                    $designsSearchResults.empty();
                }

                if (designs.length === 0) {
                    if (clearContainer) {
                        $designsSearchResults.append('<p class="text-gray-400 col-span-2">No public designs found.</p>');
                    }
                    return [];
                }

                const imageLoadPromises = [];
                const designsToRender = designs.slice(); // Create a copy to work with

                function renderNextChunk() {
                    const chunk = designsToRender.splice(0, 2); // Take a batch of 2 designs
                    if (chunk.length === 0) {
                        return; // No more designs to render
                    }

                    const fragment = document.createDocumentFragment();

                    chunk.forEach((design) => {
                        const designCard = `
                <div class="design-thumbnail cursor-pointer rounded-md" data-design-id="${design._id}" data-design-name="${design.designName}">
                    <img src="${design.imageURL || "https://via.placeholder.com/150?text=No+Image"}" 
                         alt="${design.designName}" 
                         class="w-full h-32 object-cover rounded-md mb-2">
                    <p class="text-center text-sm text-gray-400 truncate">${design.designName}</p>
                </div>
            `;
                        const $designCard = $(designCard);
                        const $img = $designCard.find("img");

                        const imgLoadPromise = new Promise((resolve) => {
                            if ($img[0].complete) {
                                resolve();
                            } else {
                                $img.on("load", resolve).on("error", resolve);
                            }
                        });
                        imageLoadPromises.push(imgLoadPromise);

                        $(fragment).append($designCard);
                    });

                    $designsSearchResults.append(fragment);



                    setTimeout(renderNextChunk, 0);
                }

                // Start the rendering process
                renderNextChunk();

                // We still return all promises so Promise.all waits for every image to load
                return imageLoadPromises;
            }

            let currentPage = 1;
            const designsPerPage = 10;
            let isLoadingMore = false;
            let hasMoreDesigns = true;

            // Fetches a new page of public designs from the API
            function fetchDesigns(searchTerm = "", isInitialLoad = true) {
                // Only clear the container on a new search or initial load
                if (isInitialLoad) {
                    currentPage = 1;
                    hasMoreDesigns = true;
                    $designsSearchResults.empty();
                }

                if (!hasMoreDesigns || isLoadingMore) {
                    return;
                }

                isLoadingMore = true;
                toggleLoading(true);


                const apiUrl = `/api/design/public-paginated?searchTerm=${encodeURIComponent(searchTerm)}&page=${currentPage}&limit=${designsPerPage}`;

                $.ajax({
                    url: apiUrl,
                    type: "GET",
                    success: function (response) {

                        const newDesigns = response.designs;

                        if (newDesigns.length < designsPerPage) {
                            hasMoreDesigns = false;

                        }

                        // The isInitialLoad parameter passed to renderDesigns determines if the container is cleared
                        const imagePromises = renderDesigns(newDesigns, isInitialLoad);

                        Promise.all(imagePromises)
                            .then(() => {

                                toggleLoading(false);
                                isLoadingMore = false;
                                if (hasMoreDesigns) {
                                    currentPage++;
                                }
                            })
                            .catch(() => {
                                console.warn("Some images failed to load. Hiding loader anyway.");
                                toggleLoading(false);
                                isLoadingMore = false;
                            });
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching designs:", error);
                        toggleLoading(false);
                        isLoadingMore = false;
                        if (isInitialLoad) {
                            $designsSearchResults.html('<p class="text-red-400 col-span-2">Failed to load designs. Please try again.</p>');
                        }
                    },
                });
            }

            $designSearchButton.on("click", function () {
                const searchTerm = $designSearchQuery.val().trim();
                fetchDesigns(searchTerm, true);
            });

            $designSearchQuery.on("keypress", function (e) {
                if (e.which === 13) {
                    const searchTerm = $designSearchQuery.val().trim();
                    fetchDesigns(searchTerm, true);
                }
            });

            $(".sidebar-inner-area").on("scroll", function () {
                const designsPanel = $("#design-content");
                const designsPanelVisible = designsPanel.is(":visible");

                if (designsPanelVisible) {
                    const buffer = 50;
                    const element = $(this)[0];
                    if (element.scrollTop + element.clientHeight >= element.scrollHeight - buffer) {

                        // Passing false for the initial load to ensure designs are appended
                        fetchDesigns($designSearchQuery.val().trim(), false);
                    }
                }
            });

            fetchDesigns();
        });
    </script>
</body>

</html>